<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gerenciamento de Pedidos</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; color: #333; padding: 20px; }
        .container { max-width: 1400px; margin: auto; }
        h1 { color: #7FB1C8; }
        
        /* Estilo da Tabela */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; font-size: 14px; vertical-align: middle; }
        th { background-color: #7FB1C8; color: white; }
        tr:hover { background-color: #f9f9f9; }
        
        /* Estilos dos Status */
        .status-orcado { color: #888; font-weight: bold; }
        .status-pago { color: green; font-weight: bold; background-color: #e6ffe6; border-radius: 4px; padding: 2px 5px; }
        .status-50 { color: #E09F41; font-weight: bold; background-color: #fff8e6; border-radius: 4px; padding: 2px 5px; }
        .status-pendente { color: #E60000; font-weight: bold; background-color: #ffe6e6; border-radius: 4px; padding: 2px 5px; }
        .status-entregue { color: #004d00; font-weight: bold; text-decoration: line-through; } 
        
        /* Estilos de A√ß√£o */
        select, button { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; margin: 2px 0; }
        button { background-color: #E09F41; color: white; cursor: pointer; border: none; margin-left: 5px; transition: background-color 0.3s; }
        button:hover { background-color: #c98e3b; }
        .edit-button { background-color: #7FB1C8; }
        .edit-button:hover { background-color: #6a9bb0; }
        
        /* Estilo do Modal (para Edi√ß√£o) */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 10px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2); animation-name: animatetop; animation-duration: 0.4s }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: #000; text-decoration: none; cursor: pointer; }
        .modal-content input, .modal-content textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        @keyframes animatetop { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
    </style>
</head>
<body>
    <div class="container">
        <h1>Painel de Gerenciamento de Pedidos</h1>
        <p>Pedidos em andamento no topo. Atualiza√ß√£o autom√°tica a cada 5 minutos.</p>
        <button onclick="carregarPedidos()">Atualizar Lista Manualmente</button>
        <div id="lista-pedidos">Carregando pedidos...</div>
    </div>

    <div id="modal-edicao" class="modal">
      <div class="modal-content">
        <span class="close" onclick="fecharModalEdicao()">&times;</span>
        <h2>Editar Pedido <span id="modal-id-pedido"></span></h2>
        <form id="form-edicao">
            <input type="hidden" id="edit-id-pedido">
            
            <label for="edit-cliente">Nome do Cliente:</label>
            <input type="text" id="edit-cliente" required>

            <label for="edit-data">Data da Entrega:</label>
            <input type="date" id="edit-data">
            
            <label for="edit-horario">Hor√°rio da Entrega:</label>
            <input type="time" id="edit-horario">
            
            <label for="edit-total">Total Final (R$):</label>
            <input type="text" id="edit-total" pattern="[0-9.,]+" title="Use apenas n√∫meros, v√≠rgula ou ponto." required>

            <label for="edit-resumo">Resumo dos Itens:</label>
            <textarea id="edit-resumo" rows="4"></textarea>

            <button type="button" onclick="salvarEdicao()">Salvar Edi√ß√µes</button>
        </form>
      </div>
    </div>

    <script>
        // üö®üö® URL DO APPS SCRIPT (A mesma que voc√™ usou no site de pedidos) üö®üö®
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzPg0luc_LKOhkOLrefXv202qDAHMHFHO_19WF4dtXoc_20MwykJzNI5IRuYlq0Rr5s/exec"; 
        
        // Define as novas op√ß√µes de status
        const STATUS_OPTIONS = [
            "Or√ßado", 
            "Agendado - Pago", 
            "Agendado - 50%", 
            "Agendado - Pendente", 
            "Entregue", 
            "Cancelado"
        ];

        // Mapeamento de Status para classes de estilo
        const STATUS_CLASSES = {
            "Or√ßado": "status-orcado",
            "Agendado - Pago": "status-pago",
            "Agendado - 50%": "status-50",
            "Agendado - Pendente": "status-pendente",
            "Entregue": "status-entregue",
            "Cancelado": "status-cancelado"
        };
        
        // Status que devem ser exibidos no painel (em andamento)
        const STATUS_EM_ANDAMENTO = [
            "Or√ßado", 
            "Agendado - Pago", 
            "Agendado - 50%", 
            "Agendado - Pendente"
        ];


        async function carregarPedidos() {
            const container = document.getElementById('lista-pedidos');
            container.innerHTML = '<table><thead><tr><th>ID Pedido</th><th>Status</th><th>Cliente / Data / Hor√°rio</th><th>Total</th><th>Resumo</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>';
            const tbody = container.querySelector('tbody');
            container.classList.add('loading');

            try {
                // Requisi√ß√£o para ler os pedidos (GET com a action=read)
                const response = await fetch(`${APPS_SCRIPT_URL}?action=read`);
                const data = await response.json();

                if (!data.success) {
                    tbody.innerHTML = `<tr><td colspan="6">Erro ao carregar pedidos: ${data.message || 'Resposta inv√°lida da API.'}</td></tr>`;
                    return;
                }

                // Filtra e inverte a ordem para mostrar os mais novos primeiro (presumindo que o Apps Script retorna em ordem de cria√ß√£o)
                const pedidosEmAndamento = data.pedidos
                    .filter(p => STATUS_EM_ANDAMENTO.includes(p.Status))
                    .reverse(); 

                if (pedidosEmAndamento.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6">Nenhum pedido em aberto.</td></tr>`;
                    return;
                }
                
                const MAX_RESUMO_LENGTH = 100;

                pedidosEmAndamento.forEach(pedido => { 
                    // CHAVES LENDO OS NOMES FORMATADOS PELO APPS SCRIPT (com underscore)
                    const id = pedido.ID_do_Pedido || 'N/A';
                    const statusAtual = pedido.Status || 'Or√ßado';
                    const resumo = pedido.Resumo_dos_Itens || 'Sem Resumo'; 
                    const nomeCliente = pedido.Nome_do_Cliente || 'N/A';
                    const dataEntrega = pedido.Data_da_Entrega || '---';
                    const horarioEntrega = pedido.Hor√°rio_da_Entrega || '---';
                    const totalFinal = pedido.Total_Final || '0,00';
                    
                    const resumoSimplificado = resumo.length > MAX_RESUMO_LENGTH ? resumo.substring(0, MAX_RESUMO_LENGTH) + '...' : resumo;
                    
                    // Converte a data (ex: dd/mm/aaaa) para o formato esperado pelo input type="date" (yyyy-mm-dd)
                    const dataParaInput = dataEntrega !== '---' 
                        ? dataEntrega.split('/').reverse().join('-') 
                        : '';


                    let row = document.createElement('tr');
                    row.id = `pedido-${id}`;
                    // Armazena todos os dados do pedido na linha para facilitar a edi√ß√£o
                    row.dataset.pedido = JSON.stringify({
                        id: id,
                        cliente: nomeCliente,
                        data: dataParaInput, // Formato yyyy-mm-dd
                        horario: horarioEntrega,
                        total: totalFinal,
                        resumo: resumo
                    });

                    row.innerHTML = `
                        <td>${id}</td>
                        <td><span id="status-${id}" class="${STATUS_CLASSES[statusAtual]}">${statusAtual}</span></td>
                        <td>
                            <strong>${nomeCliente}</strong><br>
                            Data: ${dataEntrega}<br>
                            Hor√°rio: ${horarioEntrega}
                        </td>
                        <td>R$ ${totalFinal}</td>
                        <td title="${resumo}">${resumoSimplificado}</td>
                        <td>
                            <select id="select-status-${id}" data-id="${id}">
                                ${STATUS_OPTIONS.map(status => `
                                    <option value="${status}" ${status === statusAtual ? 'selected' : ''}>
                                        ${status}
                                    </option>
                                `).join('')}
                            </select>
                            <button onclick="atualizarStatusPedido('${id}')">Salvar Status</button>
                            <button class="edit-button" onclick="abrirModalEdicao('${id}')">Editar</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error("Erro na comunica√ß√£o com a API:", error);
                container.innerHTML = '<table><tr><td colspan="6">Erro de rede. Verifique a URL e a Implanta√ß√£o do Apps Script.</td></tr></table>';
            } finally {
                container.classList.remove('loading');
            }
        }
        
        async function atualizarStatusPedido(idPedido) {
            const select = document.getElementById(`select-status-${idPedido}`);
            const novoStatus = select.value;
            const statusDisplay = document.getElementById(`status-${idPedido}`);
            const botao = select.nextElementSibling; // O bot√£o "Salvar Status"
            
            const statusAnterior = statusDisplay.textContent;
            statusDisplay.textContent = 'Aguarde...';
            statusDisplay.className = ''; // Limpa a classe para o estado de espera
            botao.disabled = true;

            const urlEncodedData = new URLSearchParams();
            urlEncodedData.append('action', 'updateStatus');
            urlEncodedData.append('id', idPedido);
            urlEncodedData.append('status', novoStatus);
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: urlEncodedData 
                });
                
                const data = await response.json();

                if (data.success) {
                    alert(`Status do Pedido ${idPedido} atualizado para ${novoStatus}.`);
                    
                    if (!STATUS_EM_ANDAMENTO.includes(novoStatus)) {
                        document.getElementById(`pedido-${idPedido}`).remove();
                    } else {
                        statusDisplay.textContent = novoStatus;
                        statusDisplay.className = STATUS_CLASSES[novoStatus]; 
                    }
                } else {
                    alert(`Erro ao atualizar o status: ${data.message}`);
                    statusDisplay.textContent = statusAnterior;
                    statusDisplay.className = STATUS_CLASSES[statusAnterior]; 
                }
            } catch (error) {
                console.error("Erro de rede:", error);
                alert("Erro de rede ao atualizar o status.");
                statusDisplay.textContent = statusAnterior;
                statusDisplay.className = STATUS_CLASSES[statusAnterior]; 
            } finally {
                botao.disabled = false;
            }
        }
        
        // --- Fun√ß√µes de Edi√ß√£o com Modal ---

        function abrirModalEdicao(idPedido) {
            const row = document.getElementById(`pedido-${idPedido}`);
            const pedidoData = JSON.parse(row.dataset.pedido);
            
            document.getElementById('modal-id-pedido').textContent = pedidoData.id;
            document.getElementById('edit-id-pedido').value = pedidoData.id;
            document.getElementById('edit-cliente').value = pedidoData.cliente;
            document.getElementById('edit-data').value = pedidoData.data;
            document.getElementById('edit-horario').value = pedidoData.horario;
            document.getElementById('edit-total').value = pedidoData.total;
            document.getElementById('edit-resumo').value = pedidoData.resumo;

            document.getElementById('modal-edicao').style.display = "block";
        }
        
        function fecharModalEdicao() {
            document.getElementById('modal-edicao').style.display = "none";
        }
        
        async function salvarEdicao() {
            const idPedido = document.getElementById('edit-id-pedido').value;
            const cliente = document.getElementById('edit-cliente').value;
            const dataEntrega = document.getElementById('edit-data').value;
            const horarioEntrega = document.getElementById('edit-horario').value;
            const totalFinal = document.getElementById('edit-total').value;
            const resumo = document.getElementById('edit-resumo').value;

            // Formata a data de volta para dd/mm/aaaa para o Apps Script
            const dataFormatada = dataEntrega.split('-').reverse().join('/'); 

            const urlEncodedData = new URLSearchParams();
            urlEncodedData.append('action', 'updateData'); // A√ß√£o que voc√™ deve implementar no Apps Script
            urlEncodedData.append('id', idPedido);
            urlEncodedData.append('Nome_do_Cliente', cliente);
            urlEncodedData.append('Data_da_Entrega', dataFormatada); 
            urlEncodedData.append('Hor√°rio_da_Entrega', horarioEntrega);
            urlEncodedData.append('Total_Final', totalFinal);
            urlEncodedData.append('Resumo_dos_Itens', resumo);
            
            const modal = document.getElementById('modal-edicao');
            const saveButton = modal.querySelector('button[onclick="salvarEdicao()"]');
            saveButton.textContent = 'Salvando...';
            saveButton.disabled = true;

            try {
                // Requisi√ß√£o para atualizar os dados (POST com a action=updateData)
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: urlEncodedData 
                });
                
                const data = await response.json();

                if (data.success) {
                    alert(`Dados do Pedido ${idPedido} atualizados com sucesso!`);
                    fecharModalEdicao();
                    carregarPedidos(); // Recarrega a lista para mostrar a mudan√ßa
                } else {
                    alert(`Erro ao salvar edi√ß√µes: ${data.message}`);
                }
            } catch (error) {
                console.error("Erro de rede:", error);
                alert("Erro de rede ao salvar edi√ß√µes.");
            } finally {
                saveButton.textContent = 'Salvar Edi√ß√µes';
                saveButton.disabled = false;
            }
        }

        // --- Inicializa√ß√£o e Atualiza√ß√£o Autom√°tica ---
        
        // Chamada inicial
        document.addEventListener('DOMContentLoaded', carregarPedidos);

        // Atualiza√ß√£o autom√°tica a cada 5 minutos (300000 milissegundos)
        setInterval(carregarPedidos, 300000); 

    </script>
</body>
</html>
