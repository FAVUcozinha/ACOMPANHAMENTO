<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEDIDOS FAVU COZINHA AFETIVA</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ========================================================================= */
        /* FONTES E VARI√ÅVEIS */
        /* ========================================================================= */
        @font-face {
            font-family: 'Basic Choice 2';
            src: url('fonts/Basic Choice 2.ttf') format('truetype'),
                 local('Roboto'); 
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --cor-fundo-azul: #7FB1C8;
            --cor-fundo-creme: #F4E6CB;
            --cor-laranja-forte: #E09F41;
            --cor-verde: #2ecc71;
            --cor-vermelho: #e74c3c;
            --cor-texto: #1A2B0F;
        }

        /* ========================================================================= */
        /* ESTILOS GERAIS */
        /* ========================================================================= */
        body {
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            background-color: var(--cor-fundo-azul); /* Fundo Azul igual da imagem */
            margin: 0;
            padding: 0;
            color: var(--cor-texto);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* HEADER */
        header {
            background-color: var(--cor-fundo-creme); /* Fundo Creme */
            color: var(--cor-texto);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        h1 { font-size: 24px; margin: 0; display: flex; flex-direction: column; }
        h1 .title-line1 { font-weight: bold; font-size: 1.2em; }
        h1 .title-line2 { font-size: 0.8em; color: var(--cor-laranja-forte); display:none; } 
        /* Na imagem parece ser s√≥ o texto preto, ajuste se necess√°rio */

        #dashboard-totals {
            text-align: right;
            background: rgba(255,255,255,0.5);
            padding: 5px 15px;
            border-radius: 10px;
            border: 1px solid var(--cor-laranja-forte);
        }
        #dashboard-totals strong { display: block; font-size: 1.4em; color: var(--cor-laranja-forte); }
        #dashboard-totals span { font-size: 0.9em; color: #555; }

        /* BARRA DE FILTROS */
        .filter-bar {
            background-color: var(--cor-fundo-creme); 
            padding: 10px 20px; 
            display: flex; 
            gap: 30px; 
            align-items: flex-start; 
            flex-wrap: wrap;
            border-bottom: 2px solid var(--cor-laranja-forte);
            flex-shrink: 0;
        }

        .search-filter, .date-filter {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 0 0 auto;
            min-width: 250px;
        }

        .search-filter label, .date-filter label {
            color: #333;
            font-size: 0.9em;
            font-weight: normal;
        }

        .filter-bar input {
            padding: 8px 12px;
            border: 1px solid #5a9bd4; /* Borda azul clara */
            border-radius: 15px; /* Cantos mais arredondados */
            font-family: inherit;
            color: var(--cor-texto);
            background-color: #fff;
            width: 100%;
            transition: border-color 0.2s;
        }

        .filter-bar input:focus {
            outline: none;
            border-color: #5a9bd4;
        }

        .filter-bar input::placeholder {
            color: #999;
        }

        /* ========================================================================= */
        /* KANBAN BOARD */
        /* ========================================================================= */
        #main-content {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 20px;
            display: flex;
            align-items: flex-start;
        }

        #kanban-board {
            display: flex;
            gap: 15px;
            height: 100%;
            padding-bottom: 10px;
            width: 100%;
        }

        .kanban-column {
            background-color: var(--cor-fundo-creme); /* Colunas Creme */
            min-width: 300px;
            width: 300px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .column-header {
            padding: 15px;
            /* Na imagem o header n√£o tem fundo escuro, parece transparente ou mesma cor da coluna */
            background-color: transparent; 
            border-bottom: 2px solid var(--cor-laranja-forte);
            font-weight: bold;
            color: var(--cor-texto);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
        }
        
        .column-select-all-checkbox {
            width: 18px; height: 18px; cursor: pointer;
        }

        .column-content {
            padding: 10px;
            overflow-y: auto;
            flex: 1;
        }

        /* ========================================================================= */
        /* CARDS (ESTILO DA IMAGEM) */
        /* ========================================================================= */
        .pedido-card {
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 5px solid #ccc; /* Cor padr√£o, sobrescrita por status */
            cursor: grab;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .pedido-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .pedido-card.selected { border: 2px solid var(--cor-laranja-forte); }
        
        /* Tag de Observa√ß√£o - abaixo do ID do pedido com preenchimento amarelo */
        .observacao-tag {
            display: inline-block;
            background-color: #fff9c4; /* Amarelo claro com preenchimento */
            color: #f57f17; /* Amarelo mais escuro para o texto */
            font-size: 0.65em;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 3px 6px;
            border-radius: 4px;
            margin-top: 2px;
        }

        /* Cores dos Status */
        .status-Pedido-Recebido { border-left-color: #3498db; }
        .status-Pedido-Confirmado { border-left-color: var(--cor-laranja-forte); }
        .status-Aguardando-Retirada { border-left-color: #9b59b6; }
        .status-Entregue { border-left-color: var(--cor-verde); }
        .status-Cancelado { border-left-color: var(--cor-vermelho); opacity: 0.8; }

        /* Cabe√ßalho do Card (Checkbox e ID) */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-checkbox { cursor: pointer; width: 18px; height: 18px; margin-top: 2px; }
        .card-id { font-size: 0.75em; color: #5a9bd4; font-weight: bold; } /* Azul igual da imagem */

        /* T√≠tulo do Card */
        .card-title { font-weight: bold; font-size: 1em; color: #000; margin-bottom: 5px; line-height: 1.2; }

        /* BOX DE INFORMA√á√ÉO (SEM FUNDO COLORIDO) */
        .card-info-box {
            background-color: transparent;
            border-radius: 5px;
            padding: 8px;
            font-size: 0.9em;
            color: #333;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .card-info-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-icon {
            font-size: 1.2em; /* Tamanho dos emojis */
            width: 20px;
            text-align: center;
        }
        
        /* Bot√£o de n√∫mero (oculto) */
        .card-numero-btn {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            cursor: pointer;
            color: inherit;
            font-size: inherit;
            font-family: inherit;
            text-decoration: underline;
            text-decoration-style: dotted;
        }
        .card-numero-btn:hover {
            color: var(--cor-laranja-forte);
        }

        /* Cupom no Card */
        .card-cupom {
            font-size: 0.85em;
            color: var(--cor-laranja-forte);
            margin-top: 5px;
            margin-bottom: 3px;
        }
        .card-cupom-label {
            font-weight: bold;
        }
        .card-cupom-valor {
            color: var(--cor-texto);
        }

        /* Pre√ßo */
        .card-price {
            font-weight: bold; 
            color: var(--cor-texto); 
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Select de Pagamento no Card com Fundo Colorido */
        .card-status-pagamento {
            margin-top: 8px;
            width: 100%;
        }
        .card-status-pagamento select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 5px;
            border: none;
            font-size: 0.85em;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            color: white;
        }
        /* Cores destacadas para o status de pagamento - tons suaves e claros */
        .card-status-pagamento select.pg-pendente { 
            background-color: #ffb3b3; /* Vermelho claro e suave */
            color: #8b0000; /* Texto vermelho escuro para contraste */
        }
        .card-status-pagamento select.pg-pago { 
            background-color: #a8e6a8; /* Verde claro e suave */
            color: #006400; /* Texto verde escuro para contraste */
        }
        .card-status-pagamento select.pg-parcial { 
            background-color: #ffeb9c; /* Amarelo claro e suave */
            color: #8b6914; /* Texto marrom/amarelo escuro para contraste */
        }

        /* MODAL DE EDI√á√ÉO */
        .modal {
            display: none;
            position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--cor-fundo-creme);
            padding: 25px; border-radius: 10px; width: 90%; max-width: 500px;
            max-height: 90vh; overflow-y: auto; position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-button { position: absolute; right: 20px; top: 15px; font-size: 28px; cursor: pointer; color: var(--cor-laranja-forte); }
        
        #edit-form label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }
        #edit-form input, #edit-form select, #edit-form textarea {
            width: 100%; padding: 10px; margin-top: 5px;
            border: 1px solid var(--cor-fundo-azul); border-radius: 8px;
            box-sizing: border-box; font-family: inherit;
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-save { background-color: var(--cor-verde); color: white; padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .btn-cancel { background-color: var(--cor-vermelho); color: white; padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }

        /* BARRA DE A√á√ïES EM LOTE */
        #bulk-actions-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: white; padding: 15px 25px; border-radius: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none; align-items: center; gap: 15px; z-index: 1500;
        }
        #bulk-actions-bar.show { display: flex; }
        #bulk-actions-bar button { padding: 8px 15px; border-radius: 20px; border: none; color: white; font-weight: bold; cursor: pointer; }

        /* Loading & Toast */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 3000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--cor-laranja-forte); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast { position: fixed; top: 20px; right: 20px; background-color: var(--cor-verde); color: white; padding: 15px 25px; border-radius: 8px; z-index: 4000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* CALEND√ÅRIO CUSTOMIZADO */
        #date-picker-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        #date-picker-modal.show { display: flex; }
        .date-picker-content { 
            background-color: var(--cor-fundo-creme); 
            border-radius: 20px; 
            padding: 25px; 
            max-width: 380px; 
            width: 90%; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.3); 
        }
        .date-picker-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            font-weight: bold;
            font-size: 1.1em;
        }
        .date-picker-month-year {
            color: #1a5f3f; /* Verde escuro */
            font-weight: bold;
        }
        .date-picker-nav { 
            background: none; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            color: #1a5f3f; /* Verde escuro */
            padding: 5px 10px;
            border-radius: 8px;
            transition: background-color 0.2s;
            font-weight: bold;
        }
        .date-picker-nav:hover {
            background-color: rgba(26, 95, 63, 0.1);
        }
        .date-picker-calendar { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 4px; 
            margin-bottom: 20px; 
        }
        .date-picker-weekday {
            text-align: center;
            padding: 8px;
            font-size: 0.85em;
            color: #5a9bd4; /* Azul claro/verde-azulado */
            font-weight: bold;
        }
        .date-picker-day { 
            text-align: center; 
            padding: 12px 8px; 
            border-radius: 8px; 
            cursor: pointer; 
            background-color: #fff;
            border: 1px solid transparent;
            transition: all 0.2s;
            font-weight: normal;
            color: #000; /* Preto */
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .date-picker-day:hover { 
            background-color: rgba(90, 155, 212, 0.1);
        }
        .date-picker-day.selected { 
            background-color: #a0a0a0; /* Azul-cinza */
            color: #000;
            font-weight: normal;
            border: 2px solid var(--cor-laranja-forte);
            border-radius: 8px;
        }
        .date-picker-day.in-range {
            background-color: #a0a0a0; /* Azul-cinza */
            color: #000;
        }
        .date-picker-day.range-start {
            background-color: #a0a0a0; /* Azul-cinza */
            color: #000;
            font-weight: normal;
            border: 2px solid var(--cor-laranja-forte);
            border-radius: 8px;
        }
        .date-picker-day.range-end {
            background-color: #a0a0a0; /* Azul-cinza */
            color: #000;
            font-weight: normal;
            border: 2px solid var(--cor-laranja-forte);
            border-radius: 8px;
        }
        .date-picker-day.today {
            background-color: #fff;
            border: 2px solid var(--cor-laranja-forte);
            border-radius: 8px;
        }
        /* C√©lulas vazias (dias de outros meses) */
        .date-picker-empty {
            background-color: transparent;
            border: none;
            min-height: 40px;
        }
        .date-picker-buttons { 
            display: flex; 
            flex-direction: column;
            gap: 10px; 
        }
        .date-picker-buttons-row {
            display: flex;
            gap: 10px;
        }
        .date-picker-btn { 
            flex: 1; 
            padding: 10px; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .date-picker-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            #kanban-board { flex-direction: column; overflow-y: auto; overflow-x: hidden; }
            .kanban-column { width: 100%; min-width: 100%; margin-bottom: 20px; min-height: 100px;}
            header { flex-direction: column; gap: 10px; text-align: center; }
            .filter-bar { flex-direction: column; align-items: stretch; }
            #bulk-actions-bar { width: 90%; flex-wrap: wrap; justify-content: center; bottom: 10px; border-radius: 15px;}
        }
    </style>
</head>
<body>

    <div id="loading-overlay"><div class="spinner"></div><p style="color:#1A2B0F; font-weight:bold; margin-top:10px;">Sincronizando...</p></div>
    <div id="toast">Opera√ß√£o realizada!</div>

    <header>
        <h1>
            <span class="title-line1">Pedidos<br>FAVU COZINHA AFETIVA</span>
        </h1>
        <div id="dashboard-totals">
            <strong>R$ 0,00</strong>
            <span id="total-count">Carregando...</span>
        </div>
    </header>

    <div class="filter-bar">
        <div class="search-filter">
            <label>Buscar</label>
            <input type="text" id="search-input" placeholder="ID do pedido, nome ou n√∫mero do cliente" oninput="filtrarPedidos()">
        </div>
        <div class="date-filter">
            <label>Data de Entrega</label>
            <input type="date" id="date-input" onchange="filtrarPedidos()" style="display:none;">
            <input type="hidden" id="date-filter-inicial" value="">
            <input type="text" id="date-filter-display" readonly placeholder="Filtrar por Data" onclick="openDatePicker()" style="background:white; cursor:pointer;">
        </div>
    </div>

    <div id="main-content">
        <div id="kanban-board">
            </div>
    </div>

    <div id="bulk-actions-bar">
        <span id="selected-count" style="color:var(--cor-texto); font-weight:bold;">0 itens</span>
        <button onclick="abrirBulkMove()" style="background-color: var(--cor-fundo-azul);">Etapa</button>
        <button onclick="abrirBulkPayment()" style="background-color: var(--cor-laranja-forte);">Pagamento</button>
        <button onclick="abrirModalResumos()" style="background-color: var(--cor-verde);">Resumos</button>
        <button onclick="limparSelecao()" style="background-color: var(--cor-vermelho); color: white;">Limpar</button>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <h2 style="margin-top:0; color:var(--cor-laranja-forte);">Editar Pedido</h2>
                <span class="close-button" onclick="fecharModal()">&times;</span>
            </div>
            <div id="modal-id-display" style="font-size:0.85em; color:#777; font-weight:normal; margin-top:5px; margin-bottom:10px;"></div>
            
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                
                <label>Nome do Cliente:</label>
                <input type="text" id="edit-nome" required>

                <label>Telefone:</label>
                <input type="text" id="edit-telefone" required>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label>Data Entrega:</label>
                        <input type="date" id="edit-data" required>
                    </div>
                    <div style="flex:1;">
                        <label>Hor√°rio:</label>
                        <input type="time" id="edit-hora" required>
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label>Forma Pagamento:</label>
                        <select id="edit-forma">
                            <option value="Pix">Pix</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cart√£o">Cart√£o</option>
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label>Status Pagamento:</label>
                        <select id="edit-status-pgto">
                            <option value="Pagamento pendente">Pagamento pendente</option>
                            <option value="Pago 50%">Pago 50%</option>
                            <option value="Pago 100%">Pago 100%</option>
                        </select>
                    </div>
                </div>

                <label>Cupom:</label>
                <input type="text" id="edit-cupom">

                <label>Total Final (R$):</label>
                <input type="text" id="edit-total" required>

                <label>Observa√ß√µes:</label>
                <textarea id="edit-obs" rows="3"></textarea>
                
                <label>Itens do Pedido (Leitura):</label>
                <textarea id="edit-resumo" rows="4" style="background:#eee; font-size:0.85em;" readonly></textarea>

                <div class="modal-actions" style="justify-content: center;">
                    <button type="button" class="btn-cancel" onclick="fecharModal()">Cancelar</button>
                    <button type="submit" class="btn-save">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="bulk-move-modal" class="modal">
        <div class="modal-content" style="max-width:350px; text-align:center;">
            <h3>Mover para...</h3>
            <select id="bulk-move-select" style="width:100%; padding:10px; margin-bottom:20px;">
                </select>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn-cancel" onclick="document.getElementById('bulk-move-modal').style.display='none'">Cancelar</button>
                <button class="btn-save" onclick="executarBulkMove()">Mover</button>
            </div>
        </div>
    </div>

    <div id="bulk-payment-modal" class="modal">
        <div class="modal-content" style="max-width:350px; text-align:center;">
            <h3>Alterar Pagamento para...</h3>
            <select id="bulk-payment-select" style="width:100%; padding:10px; margin-bottom:20px;">
                <option value="Pagamento pendente">Pagamento pendente</option>
                <option value="Pago 50%">Pago 50%</option>
                <option value="Pago 100%">Pago 100%</option>
            </select>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn-cancel" onclick="document.getElementById('bulk-payment-modal').style.display='none'">Cancelar</button>
                <button class="btn-save" onclick="executarBulkPayment()">Alterar</button>
            </div>
        </div>
    </div>

    <div id="date-picker-modal">
        <div class="date-picker-content">
            <div class="date-picker-header">
                <button class="date-picker-nav" id="prev-month">‚Äπ</button>
                <div class="date-picker-month-year" id="month-year-display"></div>
                <button class="date-picker-nav" id="next-month">‚Ä∫</button>
            </div>
            <div class="date-picker-calendar" id="calendar-grid"></div>
            <div class="date-picker-buttons">
                <div class="date-picker-buttons-row">
                <button class="date-picker-btn" style="background:#A5D6A7; color:white;" onclick="selecionarHoje()">Hoje</button>
                    <button class="date-picker-btn" style="background:var(--cor-fundo-azul); color:white;" onclick="filtrarMesAtual(); closeDatePicker();">M√™s Atual</button>
                </div>
                <div class="date-picker-buttons-row">
                    <button class="date-picker-btn" style="background:#EF9A9A; color:white;" onclick="limparFiltros(); closeDatePicker();">Limpar</button>
                    <button class="date-picker-btn" style="background:var(--cor-verde); color:white;" onclick="aplicarFiltroData(); closeDatePicker();">Filtrar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="whatsapp-confirm-modal" class="modal">
        <div class="modal-content" style="max-width:400px; text-align:center;">
            <span class="close-button" onclick="fecharModalWhatsApp()">&times;</span>
            <h3 id="whatsapp-confirm-title" style="margin-top:0; color:var(--cor-texto);"></h3>
            <p id="whatsapp-confirm-message" style="margin:20px 0;"></p>
            <div class="modal-actions" style="justify-content: center; gap: 10px;">
                <button class="btn-cancel" onclick="fecharModalWhatsApp()">Cancelar</button>
                <button class="btn-save" id="whatsapp-confirm-btn" onclick="confirmarEnvioWhatsApp()">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="resumos-modal" class="modal">
        <div class="modal-content" style="max-width:400px; text-align:center;">
            <span class="close-button" onclick="fecharModalResumos()">&times;</span>
            <h3 style="margin-top:0; color:var(--cor-texto);">Escolha o tipo de resumo</h3>
            <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
                <button class="btn-save" onclick="gerarListaPedidos()" style="width: 100%; padding: 12px;">
                    üìã Lista de pedidos
                </button>
                <button class="btn-save" onclick="gerarResumoItens()" style="width: 100%; padding: 12px; background-color: var(--cor-fundo-azul);">
                    üì¶ Itens
                </button>
            </div>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn-cancel" onclick="fecharModalResumos()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURA√á√ÉO
        // ============================================================================
        const API_URL = "https://script.google.com/macros/s/AKfycbxh3eXo5cEoft0GAeO4wioz1ZdiSYMlgG2PU_c38EKjY-JewWH36G8uCIj9L5hgZOrmBA/exec";

        const STATUS_FLOW = [
            'Pedido Recebido',
            'Pedido Confirmado',
            'Aguardando Retirada',
            'Entregue',
            'Cancelado'
        ];

        let todosPedidos = [];
        let ticketsSelecionados = new Set();
        let isDragEnabled = window.innerWidth > 768; // Desabilita drag no mobile
        let currentCalendarDate = new Date();
        let dataInicialIntervalo = null;
        let dataFinalIntervalo = null;

        // ============================================================================
        // INICIALIZA√á√ÉO
        // ============================================================================
        document.addEventListener("DOMContentLoaded", () => {
            inicializarKanban();
            carregarPedidos();
            renderCalendar(); 
            // Auto-refresh a cada 30 segundos
            setInterval(carregarPedidos, 30000);
            
            // Fecha o calend√°rio ao clicar fora
            const modal = document.getElementById('date-picker-modal');
            if (modal) {
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        closeDatePicker();
                    }
                });
            }
        });

        function inicializarKanban() {
            const board = document.getElementById('kanban-board');
            const bulkSelect = document.getElementById('bulk-move-select');
            
            STATUS_FLOW.forEach(status => {
                // Cria coluna
                const col = document.createElement('div');
                col.className = 'kanban-column';
                col.dataset.status = status;
                col.innerHTML = `
                    <div class="column-header">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <input type="checkbox" class="column-select-all-checkbox" onclick="toggleSelectColumn(this, '${status}')">
                            <span>${status} (<span class="count-badge">0</span>)</span>
                        </div>
                    </div>
                    <div class="column-content" id="col-${limparString(status)}" 
                         ondrop="drop(event)" ondragover="allowDrop(event)">
                    </div>
                `;
                board.appendChild(col);

                // Preenche select de mover em massa
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                bulkSelect.appendChild(option);
            });
        }

        function limparString(str) {
            return str.replace(/[^a-zA-Z0-9]/g, '');
        }

        // ============================================================================
        // CARREGAMENTO DE DADOS
        // ============================================================================
        async function carregarPedidos() {
            if(document.getElementById('edit-modal').style.display === 'flex') return;

            try {
                const response = await fetch(`${API_URL}?action=read`);
                const data = await response.json();

                if (data.success) {
                    todosPedidos = data.pedidos;
                    filtrarPedidos();
                    // Dashboard j√° √© atualizado em filtrarPedidos()
                } else {
                    console.error("Erro API:", data.message);
                }
            } catch (erro) {
                console.error("Erro de conex√£o:", erro);
            }
        }

        function renderizar(pedidosParaExibir) {
            // Limpa colunas
            document.querySelectorAll('.column-content').forEach(el => el.innerHTML = '');
            const contadores = {};
            STATUS_FLOW.forEach(s => contadores[s] = 0);

            pedidosParaExibir.forEach(pedido => {
                const status = pedido.Status_do_Pedido || 'Pedido Recebido';
                let statusNormalizado = STATUS_FLOW.find(s => s.toLowerCase() === status.toLowerCase()) || 'Pedido Recebido';
                
                const colId = `col-${limparString(statusNormalizado)}`;
                const coluna = document.getElementById(colId);

                if (coluna) {
                    const card = criarCardHTML(pedido);
                    coluna.appendChild(card);
                    contadores[statusNormalizado]++;
                }
            });

            STATUS_FLOW.forEach(status => {
                const col = document.querySelector(`.kanban-column[data-status="${status}"]`);
                if(col) col.querySelector('.count-badge').textContent = contadores[status];
            });

            // Atualiza dashboard com l√≥gica: selecionados OU per√≠odo
            atualizarDashboard();
        }

        // Fun√ß√£o para obter pedidos do per√≠odo (m√™s vigente ou filtro de data)
        function obterPedidosDoPeriodo() {
            const dataFiltro = document.getElementById('date-input').value; // YYYY-MM-DD
            
            if (dataFiltro) {
                // Se h√° filtro de data, retorna apenas os pedidos dessa data
                return todosPedidos.filter(p => {
                    const dataPedParts = (p.Data_Entrega || '').split('/');
                    if(dataPedParts.length === 3) {
                        const dataPedISO = `${dataPedParts[2]}-${dataPedParts[1]}-${dataPedParts[0]}`;
                        return dataPedISO === dataFiltro;
                    }
                    return false;
                });
            } else {
                // Se n√£o h√° filtro, usa o m√™s vigente
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                
                return todosPedidos.filter(p => {
                    const dataPedParts = (p.Data_Entrega || '').split('/');
                    if(dataPedParts.length === 3) {
                        const diaPed = parseInt(dataPedParts[0]);
                        const mesPed = parseInt(dataPedParts[1]) - 1; // M√™s √© 0-indexed
                        const anoPed = parseInt(dataPedParts[2]);
                        return mesPed === mesAtual && anoPed === anoAtual;
                    }
                    return false;
                });
            }
        }

        // Fun√ß√£o helper para converter string de valor para n√∫mero
        function converterValorParaNumero(valorStr) {
            if (!valorStr) return 0;
            
            let valor = String(valorStr);
            valor = valor.replace(/R\$/gi, '').trim();
            
            const temVirgula = valor.includes(',');
            const temPonto = valor.includes('.');
            
            if (temVirgula) {
                valor = valor.replace(/\./g, '');
                valor = valor.replace(',', '.');
            } else if (temPonto) {
                // Mant√©m ponto como decimal
            } else {
                valor = valor.replace(/\D/g, '');
            }
            
            const num = parseFloat(valor);
            return isNaN(num) ? 0 : num;
        }

        // Fun√ß√£o helper para formatar valor com 2 casas decimais (formato brasileiro)
        function formatarValorComCentavos(valor) {
            if (!valor) return '0,00';
            
            // Converte para n√∫mero
            const valorNum = converterValorParaNumero(valor);
            
            // Formata com 2 casas decimais e v√≠rgula
            return valorNum.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Fun√ß√£o helper para calcular valor de um pedido
        // Converte string monet√°ria brasileira (ex: 'R$ 2.530,50') para float
        // Passos: remove R$, remove espa√ßos, remove pontos de milhar, troca v√≠rgula por ponto
        function calcularValorPedido(pedido) {
            if (!pedido || !pedido.Total_Final) return 0;
            let valor = String(pedido.Total_Final).trim();
            
            // Se tiver v√≠rgula, assume formato BR (1.000,00) -> remove ponto, troca v√≠rgula por ponto
            if (valor.includes(',')) {
                valor = valor.replace(/\./g, '').replace(',', '.');
            } 
            // Se N√ÉO tiver v√≠rgula, mant√©m o ponto (formato US/Planilha: 42.00 ou 174.5)
            
            // Remove tudo que n√£o for d√≠gito ou ponto
            valor = valor.replace(/[^\d.]/g, '');
            return parseFloat(valor) || 0;
        }

        // Fun√ß√£o para obter pedidos filtrados (considera busca e data/intervalo)
        // Retorna:
        // - Se apenas texto: todos os pedidos do cliente/nome pesquisado (independente da data)
        // - Se apenas data: todos os pedidos no per√≠odo selecionado
        // - Se texto + data: pedidos do cliente/nome pesquisado que est√£o no per√≠odo selecionado
        function obterPedidosFiltrados() {
            const texto = document.getElementById('search-input').value.trim().toLowerCase();
            const dataFiltro = document.getElementById('date-input').value; // YYYY-MM-DD ou YYYY-MM-DD,YYYY-MM-DD

            return todosPedidos.filter(p => {
                // Filtro de texto (se houver) - busca por nome do cliente, ID do pedido ou n√∫mero
                if (texto) {
                    const matchTexto = 
                        (p.Nome_Cliente || '').toLowerCase().includes(texto) ||
                        (p.ID_do_Pedido || '').toLowerCase().includes(texto) ||
                        (p.Numero || '').includes(texto);
                    
                    // Se n√£o corresponde ao texto, exclui o pedido
                    if (!matchTexto) return false;
                }
                
                // Filtro de data/intervalo (se houver)
                if (dataFiltro) {
                    // Verifica se √© intervalo (tem v√≠rgula) - ex: "2025-12-14,2025-12-20"
                    if (dataFiltro.includes(',')) {
                        const [dataInicio, dataFim] = dataFiltro.split(',');
                        const [anoInicio, mesInicio, diaInicio] = dataInicio.split('-');
                        const [anoFim, mesFim, diaFim] = dataFim.split('-');
                        
                        const dataInicioObj = new Date(parseInt(anoInicio), parseInt(mesInicio) - 1, parseInt(diaInicio));
                        const dataFimObj = new Date(parseInt(anoFim), parseInt(mesFim) - 1, parseInt(diaFim));
                        
                        // Converte DD/MM/AAAA do pedido para Date
                        const dataPedParts = (p.Data_Entrega || '').split('/');
                        if(dataPedParts.length === 3) {
                            const dataPedObj = new Date(parseInt(dataPedParts[2]), parseInt(dataPedParts[1]) - 1, parseInt(dataPedParts[0]));
                            dataInicioObj.setHours(0, 0, 0, 0);
                            dataFimObj.setHours(0, 0, 0, 0);
                            dataPedObj.setHours(0, 0, 0, 0);
                            // Retorna true se a data do pedido est√° dentro do intervalo
                            return dataPedObj >= dataInicioObj && dataPedObj <= dataFimObj;
                        }
                        return false;
                    } else {
                        // Data √∫nica
                        const dataPedParts = (p.Data_Entrega || '').split('/');
                        if(dataPedParts.length === 3) {
                            const dataPedISO = `${dataPedParts[2]}-${dataPedParts[1]}-${dataPedParts[0]}`;
                            return dataPedISO === dataFiltro;
                        }
                        return false;
                    }
                }
                
                // Se passou por todos os filtros aplicados, inclui o pedido
                // (se h√° apenas texto, retorna todos os pedidos que correspondem ao texto)
                // (se h√° apenas data, retorna todos os pedidos no per√≠odo)
                // (se h√° texto + data, retorna apenas os que correspondem a ambos)
                return true;
            });
        }

        // Atualiza o dashboard com os totais baseados nos filtros aplicados:
        // - Se h√° pedidos selecionados: mostra totais apenas dos selecionados
        // - Se h√° filtro de per√≠odo (ex: 14/12/2025 - 20/12/2025): mostra totais apenas do per√≠odo
        // - Se h√° busca por cliente: mostra totais de todos os pedidos do cliente
        // - Se h√° busca + per√≠odo: mostra totais dos pedidos do cliente no per√≠odo
        // - Se n√£o h√° filtros: mostra totais do m√™s vigente
        function atualizarDashboard() {
            let pedidosParaCalcular = [];
            let totalValor = 0;
            let totalPedidos = 0;

            // Prioridade 1: Se h√° pedidos selecionados, usa APENAS os selecionados
            if (ticketsSelecionados.size > 0) {
                pedidosParaCalcular = todosPedidos.filter(p => ticketsSelecionados.has(p.ID_do_Pedido));
            } else {
                // Prioridade 2: Verifica se h√° filtros ativos (busca ou data)
                const texto = document.getElementById('search-input').value.trim();
                const dataFiltro = document.getElementById('date-input').value;
                
                if (texto || dataFiltro) {
                    // Se h√° filtros, usa os pedidos filtrados
                    // - Apenas texto: todos os pedidos do cliente pesquisado
                    // - Apenas data: todos os pedidos no per√≠odo selecionado
                    // - Texto + data: pedidos do cliente no per√≠odo selecionado
                    pedidosParaCalcular = obterPedidosFiltrados();
                } else {
                    // Prioridade 3: Se n√£o h√° filtros nem sele√ß√£o, usa o m√™s vigente (padr√£o)
                    pedidosParaCalcular = obterPedidosDoPeriodo();
                }
            }

            // Calcula total e contagem (excluindo pedidos cancelados do valor financeiro)
            pedidosParaCalcular.forEach(pedido => {
                const status = pedido.Status_do_Pedido || 'Pedido Recebido';
                const statusNormalizado = STATUS_FLOW.find(s => s.toLowerCase() === status.toLowerCase()) || 'Pedido Recebido';
                
                // N√£o inclui pedidos cancelados no total financeiro, mas conta no total de pedidos
                if (statusNormalizado !== 'Cancelado') {
                    totalValor += calcularValorPedido(pedido);
                }
                totalPedidos++;
            });

            // Atualiza o dashboard com os valores calculados
            document.querySelector('#dashboard-totals strong').textContent = 
                totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('total-count').textContent = 
                `${totalPedidos} pedido${totalPedidos !== 1 ? 's' : ''}`;
        }

        function criarCardHTML(pedido) {
            const card = document.createElement('div');
            const sanitizedStatus = (pedido.Status_do_Pedido || '').replace(/\s+/g, '-');
            const temObs = pedido.Observacoes && pedido.Observacoes.trim() !== '';
            
            card.className = `pedido-card status-${sanitizedStatus} ${temObs ? 'com-observacao' : ''} ${ticketsSelecionados.has(pedido.ID_do_Pedido) ? 'selected' : ''}`;
            if(isDragEnabled) card.draggable = true;
            card.id = `card-${pedido.ID_do_Pedido}`;
            card.dataset.id = pedido.ID_do_Pedido;
            
            if(isDragEnabled) card.addEventListener('dragstart', drag);
            card.addEventListener('click', (e) => {
                // Se clicar no select ou checkbox, n√£o abre modal
                if(e.target.tagName !== 'SELECT' && e.target.type !== 'checkbox') {
                    abrirModalEdicao(pedido.ID_do_Pedido);
                }
            });

            // Estilo do select de pagamento
            const pgStatus = (pedido.Status_Pagamento || 'Pagamento pendente').toLowerCase();
            let pgClass = 'pg-pendente';
            if(pgStatus.includes('50%')) pgClass = 'pg-parcial';
            if(pgStatus.includes('100%') || pgStatus === 'pago') pgClass = 'pg-pago';

            // HTML DO CARD IGUAL A IMAGEM
            card.innerHTML = `
                <div class="card-header">
                    <input type="checkbox" class="card-checkbox" 
                           ${ticketsSelecionados.has(pedido.ID_do_Pedido) ? 'checked' : ''}
                           onclick="toggleSelecao('${pedido.ID_do_Pedido}', this); event.stopPropagation();">
                    <div style="text-align: right;">
                        <div>
                            <span class="card-id">${pedido.ID_do_Pedido}</span>
                        </div>
                        ${temObs ? '<div><span class="observacao-tag">OBSERVA√á√ÉO</span></div>' : ''}
                    </div>
                </div>
                <br>
                <div class="card-title">${pedido.Nome_Cliente}</div>

                <div class="card-info-box">
                    <div class="card-info-row">
                        <span class="card-icon">üóìÔ∏è</span> ${pedido.Data_Entrega || '--/--/----'}
                    </div>
                    <div class="card-info-row">
                        <span class="card-icon">‚è∞</span> ${pedido.Horario_Entrega || '--:--'}
                    </div>
                    <div class="card-info-row">
                        <span class="card-icon">üì±</span> 
                        <button class="card-numero-btn" onclick="abrirModalWhatsApp('${pedido.ID_do_Pedido}'); event.stopPropagation();">
                            ${pedido.Numero || 'N/A'}
                        </button>
                    </div>
                </div>
                
                ${pedido.Cupom ? `
                <div class="card-cupom">
                    <span class="card-cupom-label">Cupom:</span> ${pedido.Cupom}
                    ${(() => {
                        const valores = calcularValoresComCupom(pedido);
                        if (valores.desconto > 0) {
                            return ` - Desconto: R$ ${valores.desconto.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                        }
                        return '';
                    })()}
                </div>
                ` : ''}
                
                <div class="card-price">Total do valor: ${formatarValorComCentavos(pedido.Total_Final)}</div>

                <div class="card-status-pagamento">
                    <select class="${pgClass}" onchange="atualizarStatusPagamentoDireto('${pedido.ID_do_Pedido}', this)">
                        <option value="Pagamento pendente" ${pgStatus === 'pendente' || pgStatus === 'pagamento pendente' ? 'selected' : ''}>Pagamento pendente</option>
                        <option value="Pago 50%" ${pgStatus.includes('50') ? 'selected' : ''}>Pago 50%</option>
                        <option value="Pago 100%" ${pgStatus.includes('100') || pgStatus === 'pago' ? 'selected' : ''}>Pago 100%</option>
                    </select>
                </div>
            `;
            return card;
        }

        // ============================================================================
        // L√ìGICA DE FILTROS & CALEND√ÅRIO
        // ============================================================================
        function filtrarPedidos() {
            const texto = document.getElementById('search-input').value.trim().toLowerCase();
            const dataFiltro = document.getElementById('date-input').value; // YYYY-MM-DD ou YYYY-MM-DD,YYYY-MM-DD

            const filtrados = todosPedidos.filter(p => {
                // Filtro de texto (se houver)
                if (texto) {
                    const matchTexto = 
                        (p.Nome_Cliente || '').toLowerCase().includes(texto) ||
                        (p.ID_do_Pedido || '').toLowerCase().includes(texto) ||
                        (p.Numero || '').includes(texto);
                    
                    if (!matchTexto) return false;
                }
                
                // Filtro de data/intervalo (se houver)
                if (dataFiltro) {
                    // Verifica se √© intervalo (tem v√≠rgula)
                    if (dataFiltro.includes(',')) {
                        const [dataInicio, dataFim] = dataFiltro.split(',');
                        const [anoInicio, mesInicio, diaInicio] = dataInicio.split('-');
                        const [anoFim, mesFim, diaFim] = dataFim.split('-');
                        
                        const dataInicioObj = new Date(parseInt(anoInicio), parseInt(mesInicio) - 1, parseInt(diaInicio));
                        const dataFimObj = new Date(parseInt(anoFim), parseInt(mesFim) - 1, parseInt(diaFim));
                        
                        // Converte DD/MM/AAAA do pedido para Date
                        const dataPedParts = (p.Data_Entrega || '').split('/');
                        if(dataPedParts.length === 3) {
                            const dataPedObj = new Date(parseInt(dataPedParts[2]), parseInt(dataPedParts[1]) - 1, parseInt(dataPedParts[0]));
                            dataInicioObj.setHours(0, 0, 0, 0);
                            dataFimObj.setHours(0, 0, 0, 0);
                            dataPedObj.setHours(0, 0, 0, 0);
                            return dataPedObj >= dataInicioObj && dataPedObj <= dataFimObj;
                        } else {
                            return false;
                        }
                    } else {
                        // Data √∫nica
                        const dataPedParts = (p.Data_Entrega || '').split('/');
                        if(dataPedParts.length === 3) {
                            const dataPedISO = `${dataPedParts[2]}-${dataPedParts[1]}-${dataPedParts[0]}`;
                            return dataPedISO === dataFiltro;
                        } else {
                            return false;
                        }
                    }
                }
                
                // Se n√£o h√° filtros, retorna true (mostra todos)
                return true;
            });

            renderizar(filtrados);
            // Dashboard j√° √© atualizado em renderizar()
        }

        function filtrarMesAtual() {
            // Define o intervalo do dia 1 ao √∫ltimo dia do m√™s vigente
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();
            
            // Primeiro dia do m√™s
            dataInicialIntervalo = new Date(anoAtual, mesAtual, 1);
            dataInicialIntervalo.setHours(0, 0, 0, 0);
            
            // √öltimo dia do m√™s
            dataFinalIntervalo = new Date(anoAtual, mesAtual + 1, 0);
            dataFinalIntervalo.setHours(0, 0, 0, 0);
            
            // Atualiza o display
            atualizarDisplayData();
            renderCalendar();
            filtrarPedidos();
            // Garante que o dashboard seja atualizado com os totais do per√≠odo
            atualizarDashboard();
            closeDatePicker();
        }

        function limparFiltros() {
            document.getElementById('search-input').value = '';
            document.getElementById('date-input').value = '';
            document.getElementById('date-filter-display').value = '';
            dataInicialIntervalo = null;
            dataFinalIntervalo = null;
            filtrarPedidos();
        }

        // --- L√≥gica do Calend√°rio Customizado ---
        function openDatePicker() {
            // Carrega o estado atual do filtro de data para as vari√°veis de intervalo
            const dataFiltro = document.getElementById('date-input').value;
            if (dataFiltro) {
                if (dataFiltro.includes(',')) {
                    // √â um intervalo
                    const [dataInicio, dataFim] = dataFiltro.split(',');
                    const [anoInicio, mesInicio, diaInicio] = dataInicio.split('-');
                    const [anoFim, mesFim, diaFim] = dataFim.split('-');
                    dataInicialIntervalo = new Date(parseInt(anoInicio), parseInt(mesInicio) - 1, parseInt(diaInicio));
                    dataFinalIntervalo = new Date(parseInt(anoFim), parseInt(mesFim) - 1, parseInt(diaFim));
                    dataInicialIntervalo.setHours(0, 0, 0, 0);
                    dataFinalIntervalo.setHours(0, 0, 0, 0);
                } else {
                    // √â uma data √∫nica
                    const [ano, mes, dia] = dataFiltro.split('-');
                    dataInicialIntervalo = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                    dataInicialIntervalo.setHours(0, 0, 0, 0);
                    dataFinalIntervalo = null;
                }
            } else {
                dataInicialIntervalo = null;
                dataFinalIntervalo = null;
            }
            document.getElementById('date-picker-modal').classList.add('show');
            renderCalendar();
        }
        function closeDatePicker() {
            document.getElementById('date-picker-modal').classList.remove('show');
        }
        
        // Aplica o filtro de data selecionado
        function aplicarFiltroData() {
            // Verifica se h√° um intervalo v√°lido selecionado
            if (!dataInicialIntervalo) {
                showToast("Selecione pelo menos uma data para filtrar!", true);
                return;
            }
            
            // Se h√° apenas data inicial, define ela tamb√©m como final (filtro de data √∫nica)
            if (dataInicialIntervalo && !dataFinalIntervalo) {
                dataFinalIntervalo = new Date(dataInicialIntervalo);
            }
            
            // Atualiza o display com o intervalo selecionado
            atualizarDisplayData();
            
            // Aplica o filtro e mostra apenas os pedidos com data de entrega no intervalo
            filtrarPedidos();
            
            // Garante que o dashboard seja atualizado com os totais do per√≠odo selecionado
            atualizarDashboard();
            
            // Feedback visual
            if (dataInicialIntervalo && dataFinalIntervalo) {
                const diaInicio = String(dataInicialIntervalo.getDate()).padStart(2, '0');
                const mesInicio = String(dataInicialIntervalo.getMonth() + 1).padStart(2, '0');
                const anoInicio = dataInicialIntervalo.getFullYear();
                const diaFim = String(dataFinalIntervalo.getDate()).padStart(2, '0');
                const mesFim = String(dataFinalIntervalo.getMonth() + 1).padStart(2, '0');
                const anoFim = dataFinalIntervalo.getFullYear();
                showToast(`Filtro aplicado: ${diaInicio}/${mesInicio}/${anoInicio} - ${diaFim}/${mesFim}/${anoFim}`);
            }
        }
        
        document.getElementById('prev-month').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        });
        
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearDisplay = document.getElementById('month-year-display');
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            monthYearDisplay.textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            calendarGrid.innerHTML = '';
            const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            weekdays.forEach(day => {
                const d = document.createElement('div');
                d.className = 'date-picker-weekday';
                d.textContent = day;
                calendarGrid.appendChild(d);
            });
            
            for(let i=0; i<startingDayOfWeek; i++) {
                const empty = document.createElement('div');
                empty.className = 'date-picker-empty';
                calendarGrid.appendChild(empty);
            }
            
            for(let day=1; day<=daysInMonth; day++) {
                const dayEl = document.createElement('div');
                const currentDate = new Date(year, month, day);
                currentDate.setHours(0, 0, 0, 0);
                
                // Define a classe base primeiro
                dayEl.className = 'date-picker-day';
                dayEl.textContent = day;
                
                // Adiciona evento de clique
                dayEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selecionarData(year, month, day);
                });
                
                // Verifica se √© hoje
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                if (currentDate.getTime() === hoje.getTime()) {
                    dayEl.classList.add('today');
                }
                
                // Verifica se est√° no intervalo selecionado
                if (dataInicialIntervalo && dataFinalIntervalo) {
                    const inicio = new Date(dataInicialIntervalo);
                    const fim = new Date(dataFinalIntervalo);
                    inicio.setHours(0, 0, 0, 0);
                    fim.setHours(0, 0, 0, 0);
                    
                    if (currentDate.getTime() === inicio.getTime()) {
                        dayEl.classList.add('range-start');
                    } else if (currentDate.getTime() === fim.getTime()) {
                        dayEl.classList.add('range-end');
                    } else if (currentDate >= inicio && currentDate <= fim) {
                        dayEl.classList.add('in-range');
                    }
                } else if (dataInicialIntervalo) {
                    const inicio = new Date(dataInicialIntervalo);
                    inicio.setHours(0, 0, 0, 0);
                    if (currentDate.getTime() === inicio.getTime()) {
                        dayEl.classList.add('selected');
                        // Remove classes de intervalo se n√£o estiver em um
                        dayEl.classList.remove('range-start', 'range-end', 'in-range');
                    }
                }
                
                calendarGrid.appendChild(dayEl);
            }
            
            // Adiciona c√©lulas vazias no final para completar a grade (6 semanas = 42 c√©lulas)
            const totalCells = startingDayOfWeek + daysInMonth;
            const remainingCells = 42 - totalCells;
            for(let i=0; i<remainingCells; i++) {
                const empty = document.createElement('div');
                empty.className = 'date-picker-empty';
                calendarGrid.appendChild(empty);
            }
        }

        function selecionarData(year, month, day) {
            const selectedDate = new Date(year, month, day);
            selectedDate.setHours(0, 0, 0, 0);
            
            // Se j√° tem intervalo completo (inicial e final), reinicia a sele√ß√£o
            if (dataInicialIntervalo && dataFinalIntervalo) {
                dataInicialIntervalo = selectedDate;
                dataFinalIntervalo = null;
            }
            // Se n√£o h√° data inicial, define como inicial
            else if (!dataInicialIntervalo) {
                dataInicialIntervalo = selectedDate;
                dataFinalIntervalo = null;
            }
            // Se h√° data inicial mas n√£o h√° final
            else if (!dataFinalIntervalo) {
                // Se a data selecionada √© anterior √† inicial, troca (inicial vira final)
                if (selectedDate < dataInicialIntervalo) {
                    dataFinalIntervalo = new Date(dataInicialIntervalo);
                    dataInicialIntervalo = selectedDate;
                } else {
                    // Se a data selecionada √© igual √† inicial, limpa tudo
                    if (selectedDate.getTime() === dataInicialIntervalo.getTime()) {
                        dataInicialIntervalo = null;
                        dataFinalIntervalo = null;
                    } else {
                        // Define como final
                        dataFinalIntervalo = selectedDate;
                    }
                }
            }
            
            // Atualiza o display (mas n√£o aplica o filtro ainda)
            atualizarDisplayData();
            renderCalendar();
            // O filtro s√≥ ser√° aplicado quando clicar em "Filtrar"
        }
        
        function atualizarDisplayData() {
            if (dataInicialIntervalo && dataFinalIntervalo) {
                const inicio = dataInicialIntervalo;
                const fim = dataFinalIntervalo;
                const diaInicio = String(inicio.getDate()).padStart(2, '0');
                const mesInicio = String(inicio.getMonth() + 1).padStart(2, '0');
                const anoInicio = inicio.getFullYear();
                const diaFim = String(fim.getDate()).padStart(2, '0');
                const mesFim = String(fim.getMonth() + 1).padStart(2, '0');
                const anoFim = fim.getFullYear();
                
                document.getElementById('date-filter-display').value = `${diaInicio}/${mesInicio}/${anoInicio} - ${diaFim}/${mesFim}/${anoFim}`;
                // Define o valor do input como intervalo (formato: YYYY-MM-DD,YYYY-MM-DD)
                document.getElementById('date-input').value = `${anoInicio}-${mesInicio}-${diaInicio},${anoFim}-${mesFim}-${diaFim}`;
            } else if (dataInicialIntervalo) {
                const dia = String(dataInicialIntervalo.getDate()).padStart(2, '0');
                const mes = String(dataInicialIntervalo.getMonth() + 1).padStart(2, '0');
                const ano = dataInicialIntervalo.getFullYear();
                document.getElementById('date-filter-display').value = `${dia}/${mes}/${ano}`;
                document.getElementById('date-input').value = `${ano}-${mes}-${dia}`;
            } else {
                document.getElementById('date-filter-display').value = '';
                document.getElementById('date-input').value = '';
            }
        }

        function selecionarHoje() {
            const hoje = new Date();
            dataInicialIntervalo = new Date(hoje);
            dataInicialIntervalo.setHours(0, 0, 0, 0);
            dataFinalIntervalo = null;
            atualizarDisplayData();
            renderCalendar();
            filtrarPedidos();
            // Garante que o dashboard seja atualizado
            atualizarDashboard();
            closeDatePicker();
        }

        // ============================================================================
        // L√ìGICA DE EDI√á√ÉO E ENVIO (FUNCIONAL SITE 2)
        // ============================================================================
        function abrirModalEdicao(id) {
            const pedido = todosPedidos.find(p => p.ID_do_Pedido === id);
            if(!pedido) return;

            document.getElementById('modal-id-display').textContent = `#${id}`;
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-nome').value = pedido.Nome_Cliente;
            document.getElementById('edit-telefone').value = pedido.Numero; 
            
            // Data formato YYYY-MM-DD
            const dataParts = (pedido.Data_Entrega || '').split('/');
            if(dataParts.length === 3) {
                document.getElementById('edit-data').value = `${dataParts[2]}-${dataParts[1]}-${dataParts[0]}`;
            } else {
                document.getElementById('edit-data').value = '';
            }

            document.getElementById('edit-hora').value = pedido.Horario_Entrega || '';
            document.getElementById('edit-forma').value = pedido.Forma_de_Pagamento || 'Pix';
            document.getElementById('edit-status-pgto').value = pedido.Status_Pagamento || 'Pagamento pendente';
            document.getElementById('edit-cupom').value = pedido.Cupom || '';
            document.getElementById('edit-total').value = pedido.Total_Final || '';
            document.getElementById('edit-obs').value = pedido.Observacoes || '';
            document.getElementById('edit-resumo').value = pedido.Resumo_dos_Itens || '';

            document.getElementById('edit-modal').style.display = 'flex';
        }

        function fecharModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        // SUBMIT DO FORMUL√ÅRIO (SALVA IGUAL SITE 2)
        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            mostrarLoading(true);

            const id = document.getElementById('edit-id').value;
            
            // Formata Data DD/MM/AAAA e adiciona aspa simples para texto
            const dataInput = document.getElementById('edit-data').value;
            let dataFormatada = "";
            if (dataInput) {
                const p = dataInput.split('-');
                dataFormatada = `'${p[2]}/${p[1]}/${p[0]}`;
            }

            // Hora com aspa
            let horaFormatada = `'${document.getElementById('edit-hora').value}`;

            // Total com virgula
            let total = document.getElementById('edit-total').value;
            if(total.includes('.')) total = total.replace('.', ',');

            const pedidoOriginal = todosPedidos.find(p => p.ID_do_Pedido === id);

            const payload = {
                action: 'updateData',
                ID_do_Pedido: id,
                Nome_Cliente: document.getElementById('edit-nome').value,
                Numero: document.getElementById('edit-telefone').value,
                Data_Entrega: dataFormatada,
                Horario_Entrega: horaFormatada,
                Total_Final: total,
                Forma_de_Pagamento: document.getElementById('edit-forma').value,
                Status_Pagamento: document.getElementById('edit-status-pgto').value,
                Cupom: document.getElementById('edit-cupom').value,
                Observacoes: document.getElementById('edit-obs').value,
                Status_do_Pedido: pedidoOriginal ? pedidoOriginal.Status_do_Pedido : 'Pedido Recebido',
                Resumo_dos_Itens: pedidoOriginal ? pedidoOriginal.Resumo_dos_Itens : ''
            };

            // ENVIO DIRETO (SEM FILA) PARA EVITAR BUGS
            try {
                await fetch(API_URL, {
                    method: "POST",
                    mode: 'no-cors',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                
                // Atualiza local
                atualizarLocalmente(payload);
                showToast("Salvo!");
                fecharModal();
            } catch (err) {
                console.error(err);
                showToast("Erro ao salvar!", true);
            }
            mostrarLoading(false);
        });
        
        // Atualiza pagamento direto do card
        async function atualizarStatusPagamentoDireto(id, selectElement) {
             const novoStatus = selectElement.value;
             mostrarLoading(true);
             
             // Pega dados atuais para n√£o apagar nada
             const pedido = todosPedidos.find(p => p.ID_do_Pedido === id);
             
             // Formata Total
             let totalFormatado = String(pedido.Total_Final || '').replace('.', ',');
             
             const payload = {
                action: 'updateData',
                ID_do_Pedido: id,
                Nome_Cliente: pedido.Nome_Cliente,
                Numero: pedido.Numero,
                Data_Entrega: `'${pedido.Data_Entrega}`, // Aspa para manter texto
                Horario_Entrega: `'${pedido.Horario_Entrega}`,
                Total_Final: totalFormatado,
                Forma_de_Pagamento: pedido.Forma_de_Pagamento,
                Status_Pagamento: novoStatus,
                Cupom: pedido.Cupom,
                Observacoes: pedido.Observacoes,
                Status_do_Pedido: pedido.Status_do_Pedido,
                Resumo_dos_Itens: pedido.Resumo_dos_Itens
             };
             
             try {
                await fetch(API_URL, {
                    method: "POST",
                    mode: 'no-cors',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                
                // Atualiza local
                pedido.Status_Pagamento = novoStatus;
                filtrarPedidos();
                showToast("Pagamento Atualizado!");
             } catch (err) {
                 showToast("Erro ao salvar", true);
             }
             mostrarLoading(false);
        }

        // ============================================================================
        // A√á√ïES EM MASSA E DRAG & DROP
        // ============================================================================
        function allowDrop(ev) { ev.preventDefault(); }
        function drag(ev) { ev.dataTransfer.setData("text", ev.target.dataset.id); }
        
        async function drop(ev) {
            ev.preventDefault();
            const id = ev.dataTransfer.getData("text");
            const col = ev.target.closest('.kanban-column');
            if(!col) return;
            
            const novoStatus = col.dataset.status;
            
            // Visual
            const card = document.getElementById(`card-${id}`);
            col.querySelector('.column-content').appendChild(card);
            
            // Envia
            mostrarLoading(true);
            try {
                await fetch(API_URL, {
                    method: "POST",
                    mode: 'no-cors',
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify({ action: 'updateStatus', id: id, Status_do_Pedido: novoStatus })
                });
                
                const p = todosPedidos.find(p => p.ID_do_Pedido === id);
                if(p) p.Status_do_Pedido = novoStatus;
                
                showToast("Status atualizado!");
                filtrarPedidos(); 
            } catch(e) {
                showToast("Erro ao mover", true);
            }
            mostrarLoading(false);
        }

        // Sele√ß√£o M√∫ltipla
        function toggleSelecao(id, checkbox) {
            if(checkbox.checked) ticketsSelecionados.add(id);
            else ticketsSelecionados.delete(id);
            atualizarBarraAcoes();
        }
        
        function toggleSelectColumn(checkbox, status) {
            const col = document.querySelector(`.kanban-column[data-status="${status}"]`);
            const checks = col.querySelectorAll('.card-checkbox');
            checks.forEach(c => {
                c.checked = checkbox.checked;
                toggleSelecao(c.closest('.pedido-card').dataset.id, c);
            });
        }

        function atualizarBarraAcoes() {
            const bar = document.getElementById('bulk-actions-bar');
            document.getElementById('selected-count').textContent = `${ticketsSelecionados.size} itens`;
            bar.style.display = ticketsSelecionados.size > 0 ? 'flex' : 'none';
            // Atualiza o dashboard quando a sele√ß√£o muda
            atualizarDashboard();
        }

        function limparSelecao() {
            ticketsSelecionados.clear();
            document.querySelectorAll('.card-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.column-select-all-checkbox').forEach(cb => cb.checked = false);
            atualizarBarraAcoes();
            // Dashboard j√° √© atualizado em atualizarBarraAcoes()
        }

        // Bulk Move
        function abrirBulkMove() { document.getElementById('bulk-move-modal').style.display = 'flex'; }
        async function executarBulkMove() {
            const novoStatus = document.getElementById('bulk-move-select').value;
            mostrarLoading(true);
            
            const promises = Array.from(ticketsSelecionados).map(id => {
                const p = todosPedidos.find(pedido => pedido.ID_do_Pedido === id);
                if(p) p.Status_do_Pedido = novoStatus;
                return fetch(API_URL, {
                    method: "POST", mode: 'no-cors', headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify({ action: 'updateStatus', id: id, Status_do_Pedido: novoStatus })
                });
            });

            await Promise.all(promises);
            mostrarLoading(false);
            document.getElementById('bulk-move-modal').style.display = 'none';
            limparSelecao();
            filtrarPedidos();
            showToast("Pedidos movidos!");
        }

        // Bulk Payment
        function abrirBulkPayment() { document.getElementById('bulk-payment-modal').style.display = 'flex'; }
        async function executarBulkPayment() {
            const novoStatus = document.getElementById('bulk-payment-select').value;
            mostrarLoading(true);

            const promises = Array.from(ticketsSelecionados).map(id => {
                const p = todosPedidos.find(pedido => pedido.ID_do_Pedido === id);
                if(p) {
                   // Reutiliza a l√≥gica de atualizar dados para o pagamento em lote
                   let totalFormatado = String(p.Total_Final || '').replace('.', ',');
                   const payload = {
                        action: 'updateData', ID_do_Pedido: id,
                        Nome_Cliente: p.Nome_Cliente, Numero: p.Numero,
                        Data_Entrega: `'${p.Data_Entrega}`, Horario_Entrega: `'${p.Horario_Entrega}`,
                        Total_Final: totalFormatado, Forma_de_Pagamento: p.Forma_de_Pagamento,
                        Status_Pagamento: novoStatus, Cupom: p.Cupom,
                        Observacoes: p.Observacoes, Status_do_Pedido: p.Status_do_Pedido,
                        Resumo_dos_Itens: p.Resumo_dos_Itens
                   };
                   p.Status_Pagamento = novoStatus;
                   return fetch(API_URL, {
                        method: "POST", mode: 'no-cors', headers: { "Content-Type": "text/plain" },
                        body: JSON.stringify(payload)
                   });
                }
            });

            await Promise.all(promises);
            mostrarLoading(false);
            document.getElementById('bulk-payment-modal').style.display = 'none';
            limparSelecao();
            filtrarPedidos();
            showToast("Pagamentos atualizados!");
        }

        // Abre modal de resumos
        function abrirModalResumos() {
            const selecionados = todosPedidos.filter(p => ticketsSelecionados.has(p.ID_do_Pedido));
            if(selecionados.length === 0) {
                showToast("Selecione pelo menos um pedido!", true);
                return;
            }
            document.getElementById('resumos-modal').style.display = 'flex';
        }

        // Fecha modal de resumos
        function fecharModalResumos() {
            document.getElementById('resumos-modal').style.display = 'none';
        }

        // Fun√ß√£o auxiliar para obter emoji do cupom (se houver)
        function obterEmojiCupom(pedido) {
            if (pedido.Cupom) {
                const cupom = pedido.Cupom.toLowerCase();
                if (cupom.includes('cookie') || cupom.includes('üç™')) return 'üç™';
                if (cupom.includes('ticket') || cupom.includes('üéüÔ∏è')) return 'üéüÔ∏è';
            }
            return '';
        }

        // Fun√ß√£o para extrair informa√ß√µes do cupom (desconto)
        function extrairDescontoCupom(cupomTexto) {
            if (!cupomTexto) return null;
            
            // Tenta encontrar percentual (ex: "10%", "15%")
            const percentMatch = cupomTexto.match(/(\d+(?:[.,]\d+)?)%/);
            if (percentMatch) {
                return {
                    tipo: 'percentual',
                    valor: parseFloat(percentMatch[1].replace(',', '.'))
                };
            }
            
            // Tenta encontrar valor fixo (ex: "R$ 20", "20,00", "20.00")
            const valorMatch = cupomTexto.match(/(?:R\$\s*)?(\d+(?:[.,]\d+)?)/);
            if (valorMatch) {
                let valor = valorMatch[1].replace(',', '.');
                return {
                    tipo: 'fixo',
                    valor: parseFloat(valor)
                };
            }
            
            return null;
        }

        // Fun√ß√£o para calcular valores com cupom
        function calcularValoresComCupom(pedido) {
            const totalFinal = calcularValorPedido(pedido);
            const descontoInfo = extrairDescontoCupom(pedido.Cupom);
            
            if (!descontoInfo) {
                return {
                    temCupom: !!pedido.Cupom,
                    valorOriginal: totalFinal,
                    desconto: 0,
                    totalFinal: totalFinal
                };
            }
            
            let valorOriginal = 0;
            let desconto = 0;
            
            if (descontoInfo.tipo === 'percentual') {
                // Se tem desconto percentual, calcula o valor original
                // totalFinal = valorOriginal * (1 - desconto/100)
                // valorOriginal = totalFinal / (1 - desconto/100)
                valorOriginal = totalFinal / (1 - descontoInfo.valor / 100);
                desconto = valorOriginal - totalFinal;
            } else {
                // Se tem desconto fixo, o valor original √© totalFinal + desconto
                desconto = descontoInfo.valor;
                valorOriginal = totalFinal + desconto;
            }
            
            return {
                temCupom: true,
                valorOriginal: valorOriginal,
                desconto: desconto,
                totalFinal: totalFinal
            };
        }

        // Fun√ß√£o auxiliar para processar itens do resumo
        function processarItensResumo(resumoItens) {
            if (!resumoItens) return [];
            
            const linhas = resumoItens.split('\n');
            const itens = [];
            let categoriaAtual = '';
            
            linhas.forEach(linha => {
                const linhaTrim = linha.trim();
                if (!linhaTrim) return;
                
                // Detecta categoria: linha que come√ßa com "-" seguido de texto (sem "‚§∑" e sem n√∫mero no in√≠cio)
                if (linhaTrim.startsWith('-') && !linhaTrim.includes('‚§∑') && !linhaTrim.match(/^-\s*\d/)) {
                    categoriaAtual = linhaTrim.replace(/^-\s*/, '').trim();
                } 
                // Detecta item: linha que come√ßa com "‚§∑" (pode ter espa√ßos antes)
                else if (linhaTrim.includes('‚§∑')) {
                    const itemTexto = linhaTrim.replace(/.*‚§∑\s*/, '').trim();
                    if (itemTexto && categoriaAtual) {
                        itens.push({
                            categoria: categoriaAtual,
                            item: itemTexto
                        });
                    }
                }
            });
            
            return itens;
        }

        // Gera lista de pedidos (formato detalhado)
        function gerarListaPedidos() {
            const selecionados = todosPedidos.filter(p => ticketsSelecionados.has(p.ID_do_Pedido));
            if(selecionados.length === 0) return;
            
            let texto = `Resumo ${selecionados.length} Pedido(s):\n\n`;
            
            selecionados.forEach((p, index) => {
                texto += `Pedido ${index + 1}\n\n`;
                texto += `* ${p.Nome_Cliente}\n`;
                texto += `   ‚§∑ ${p.Data_Entrega || '--/--/----'} √†s ${p.Horario_Entrega || '--:--'}\n`;
                const emoji = obterEmojiCupom(p);
                texto += `   ‚§∑ ${p.ID_do_Pedido}${emoji ? ' ' + emoji : ''}\n\n`;
                
                texto += `Itens:\n\n`;
                
                const itens = processarItensResumo(p.Resumo_dos_Itens);
                let categoriaAtual = '';
                
                itens.forEach(item => {
                    if (item.categoria !== categoriaAtual) {
                        categoriaAtual = item.categoria;
                        texto += `- ${categoriaAtual}\n`;
                    }
                    texto += ` ‚§∑ ${item.item}\n`;
                });
                
                // Se n√£o conseguiu processar itens, mostra o resumo original
                if (itens.length === 0 && p.Resumo_dos_Itens) {
                    texto += p.Resumo_dos_Itens + '\n';
                }
                
                // Adiciona informa√ß√µes de valor (com cupom se houver)
                const valores = calcularValoresComCupom(p);
                if (valores.temCupom && valores.desconto > 0) {
                    texto += `\n*Valor Original:* R$ ${valores.valorOriginal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n`;
                    texto += `*Desconto (${p.Cupom}):* R$ ${valores.desconto.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n`;
                    texto += `*Total:* R$ ${valores.totalFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n`;
                } else {
                    texto += `\n*Total:* R$ ${formatarValorComCentavos(p.Total_Final)}\n`;
                }
                
                texto += `\n------------------------------------------\n\n`;
            });
            
            // Copia para √°rea de transfer√™ncia e abre WhatsApp
            navigator.clipboard.writeText(texto).then(() => {
                showToast("Resumo copiado! Abrindo WhatsApp...");
                const link = `https://wa.me/558199591775?text=${encodeURIComponent(texto)}`;
                window.open(link, '_blank');
            }).catch(() => {
                // Fallback: abre WhatsApp direto
                const link = `https://wa.me/558199591775?text=${encodeURIComponent(texto)}`;
                window.open(link, '_blank');
            });
            
            fecharModalResumos();
        }

        // Gera resumo de itens agrupados
        function gerarResumoItens() {
            const selecionados = todosPedidos.filter(p => ticketsSelecionados.has(p.ID_do_Pedido));
            if(selecionados.length === 0) return;
            
            let texto = `Resumo ${selecionados.length} Pedido(s):\n\n`;
            
            // Lista de clientes
            texto += `- Clientes:\n\n`;
            selecionados.forEach(p => {
                const emoji = obterEmojiCupom(p);
                texto += `* ${p.Nome_Cliente}\n`;
                texto += `   ‚§∑ ${p.Data_Entrega || '--/--/----'} √†s ${p.Horario_Entrega || '--:--'}\n`;
                texto += `   ‚§∑ ${p.ID_do_Pedido}${emoji ? ' ' + emoji : ''}\n\n`;
            });
            
            // Agrupa itens por categoria
            const itensAgrupados = {};
            let totalGeral = 0;
            
            selecionados.forEach(p => {
                const itens = processarItensResumo(p.Resumo_dos_Itens);
                
                itens.forEach(item => {
                    if (!itensAgrupados[item.categoria]) {
                        itensAgrupados[item.categoria] = {};
                    }
                    
                    // Extrai quantidade e nome do item
                    const match = item.item.match(/^(\d+)\s*un\.\s*-\s*(.+)$/);
                    if (match) {
                        const quantidade = parseInt(match[1]);
                        const nomeItem = match[2].trim();
                        
                        if (!itensAgrupados[item.categoria][nomeItem]) {
                            itensAgrupados[item.categoria][nomeItem] = 0;
                        }
                        itensAgrupados[item.categoria][nomeItem] += quantidade;
                    } else {
                        // Se n√£o tem formato padr√£o, adiciona como est√°
                        if (!itensAgrupados[item.categoria][item.item]) {
                            itensAgrupados[item.categoria][item.item] = 0;
                        }
                        itensAgrupados[item.categoria][item.item] += 1;
                    }
                });
                
                totalGeral += calcularValorPedido(p);
            });
            
            // Monta texto dos itens agrupados
            texto += `- Itens:\n\n`;
            
            Object.keys(itensAgrupados).sort().forEach(categoria => {
                texto += `- ${categoria}\n`;
                
                const itensCategoria = itensAgrupados[categoria];
                Object.keys(itensCategoria).sort().forEach(nomeItem => {
                    const quantidade = itensCategoria[nomeItem];
                    texto += `${quantidade} un. - ${nomeItem}\n`;
                });
                texto += `\n`;
            });
            
            // Formata total
            const totalFormatado = totalGeral.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            texto += `Total Geral: R$ ${totalFormatado}`;
            
            // Copia para √°rea de transfer√™ncia e abre WhatsApp
            navigator.clipboard.writeText(texto).then(() => {
                showToast("Resumo copiado! Abrindo WhatsApp...");
            const link = `https://wa.me/558199591775?text=${encodeURIComponent(texto)}`;
            window.open(link, '_blank');
            }).catch(() => {
                // Fallback: abre WhatsApp direto
                const link = `https://wa.me/558199591775?text=${encodeURIComponent(texto)}`;
                window.open(link, '_blank');
            });
            
            fecharModalResumos();
        }

        // Vari√°vel para armazenar o ID do pedido atual no modal WhatsApp
        let pedidoWhatsAppAtual = null;
        let modoWhatsAppAtual = 'resumo'; // 'resumo' ou 'contato'

        // Fun√ß√£o para extrair o primeiro nome
        function obterPrimeiroNome(nomeCompleto) {
            if (!nomeCompleto) return 'Cliente';
            const partes = nomeCompleto.trim().split(' ');
            return partes[0];
        }

        // Fun√ß√£o para formatar n√∫mero de telefone (remove caracteres n√£o num√©ricos)
        function formatarNumeroTelefone(numero) {
            if (!numero) return '';
            // Remove tudo exceto n√∫meros
            let numeroLimpo = numero.replace(/\D/g, '');
            // Se come√ßar com 0, remove
            if (numeroLimpo.startsWith('0')) {
                numeroLimpo = numeroLimpo.substring(1);
            }
            return numeroLimpo;
        }

        // Abre modal de confirma√ß√£o do WhatsApp
        function abrirModalWhatsApp(idPedido) {
            const pedido = todosPedidos.find(p => p.ID_do_Pedido === idPedido);
            if (!pedido) return;

            pedidoWhatsAppAtual = idPedido;
            const primeiroNome = obterPrimeiroNome(pedido.Nome_Cliente);
            const modal = document.getElementById('whatsapp-confirm-modal');
            const title = document.getElementById('whatsapp-confirm-title');
            const message = document.getElementById('whatsapp-confirm-message');
            const btn = document.getElementById('whatsapp-confirm-btn');

            // Cria bot√µes para as tr√™s op√ß√µes
            message.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
                    <button class="btn-save" onclick="selecionarModoWhatsApp('resumo')" style="width: 100%; padding: 12px;">
                        üìã Enviar resumo do pedido
                    </button>
                    <button class="btn-save" onclick="selecionarModoWhatsApp('contato')" style="width: 100%; padding: 12px; background-color: var(--cor-fundo-azul);">
                        üí¨ Entrar em contato
                    </button>
                    <button class="btn-save" onclick="selecionarModoWhatsApp('pedido-pronto')" style="width: 100%; padding: 12px; background-color: var(--cor-verde);">
                        ‚úÖ Pedido Pronto
                    </button>
                </div>
            `;
            
            title.textContent = `Contato com ${primeiroNome}`;
            btn.style.display = 'none';
            modal.style.display = 'flex';
        }

        // Seleciona o modo do WhatsApp
        function selecionarModoWhatsApp(modo) {
            modoWhatsAppAtual = modo;
            const pedido = todosPedidos.find(p => p.ID_do_Pedido === pedidoWhatsAppAtual);
            if (!pedido) return;

            const primeiroNome = obterPrimeiroNome(pedido.Nome_Cliente);
            const message = document.getElementById('whatsapp-confirm-message');
            const btn = document.getElementById('whatsapp-confirm-btn');

            if (modo === 'resumo') {
                message.innerHTML = `Enviar resumo do pedido para <strong>${primeiroNome}</strong>?`;
                btn.textContent = 'Enviar Resumo';
            } else if (modo === 'pedido-pronto') {
                message.innerHTML = `Marcar pedido como pronto e notificar <strong>${primeiroNome}</strong>?`;
                btn.textContent = 'Confirmar';
            } else {
                message.innerHTML = `Entrar em contato com <strong>${primeiroNome}</strong>?`;
                btn.textContent = 'Abrir WhatsApp';
            }
            btn.style.display = 'block';
        }

        // Confirma e envia WhatsApp
        async function confirmarEnvioWhatsApp() {
            if (!pedidoWhatsAppAtual) return;

            const pedido = todosPedidos.find(p => p.ID_do_Pedido === pedidoWhatsAppAtual);
            if (!pedido) return;

            const numero = formatarNumeroTelefone(pedido.Numero);
            if (!numero) {
                showToast("N√∫mero de telefone inv√°lido!", true);
                fecharModalWhatsApp();
                return;
            }

            let texto = '';
            const primeiroNome = obterPrimeiroNome(pedido.Nome_Cliente);

            if (modoWhatsAppAtual === 'resumo') {
                // Envia resumo completo do pedido no formato solicitado
                texto = `*Ol√° ${primeiroNome}!*\n\n`;
                texto += `*Resumo do Pedido ${pedido.ID_do_Pedido}*\n\n`;
                texto += `*Data de Entrega:* ${pedido.Data_Entrega || '--/--/----'}\n`;
                texto += `*Hor√°rio:* ${pedido.Horario_Entrega || '--:--'}\n\n`;
                
                if (pedido.Resumo_dos_Itens) {
                    texto += `*Itens do Pedido:*\n${pedido.Resumo_dos_Itens}\n\n`;
                }
                
                // Remove R$ e formata o total (apenas n√∫meros)
                let totalFormatado = (pedido.Total_Final || '0').toString();
                // Remove R$, pontos, v√≠rgulas e espa√ßos, mant√©m apenas n√∫meros
                totalFormatado = totalFormatado.replace(/R\$/gi, '').replace(/\./g, '').replace(/,/g, '').replace(/\s/g, '').trim();
                // Se n√£o tiver valor, usa 0
                if (!totalFormatado || totalFormatado === '') {
                    totalFormatado = '0';
                }
                
                texto += `*Total:* ${totalFormatado}\n`;
                texto += `*Forma de Pagamento:* ${pedido.Forma_de_Pagamento || 'N√£o informado'}`;
            } else if (modoWhatsAppAtual === 'pedido-pronto') {
                // Move pedido para "Aguardando Retirada" e envia mensagem
                mostrarLoading(true);
                
                // Atualiza o status do pedido
                pedido.Status_do_Pedido = 'Aguardando Retirada';
                
                // Atualiza na planilha
                try {
                    await fetch(API_URL, {
                        method: "POST", 
                        mode: 'no-cors', 
                        headers: { "Content-Type": "text/plain" },
                        body: JSON.stringify({ 
                            action: 'updateStatus', 
                            id: pedidoWhatsAppAtual, 
                            Status_do_Pedido: 'Aguardando Retirada' 
                        })
                    });
                } catch (error) {
                    console.error('Erro ao atualizar status:', error);
                }
                
                mostrarLoading(false);
                
                // Prepara mensagem de pedido pronto
                texto = `*Ol√° ${primeiroNome}!*\n\n`;
                texto += `‚úÖ Seu pedido *${pedido.ID_do_Pedido}* est√° pronto para retirada!\n\n`;
                texto += `Por favor, venha buscar no hor√°rio agendado:\n`;
                texto += `üìÖ ${pedido.Data_Entrega || '--/--/----'}\n`;
                texto += `‚è∞ ${pedido.Horario_Entrega || '--:--'}\n\n`;
                texto += `Aguardamos voc√™! üòä`;
            } else {
                // Apenas abre conversa
                texto = `Ol√° ${primeiroNome}!`;
            }

            const link = `https://wa.me/55${numero}?text=${encodeURIComponent(texto)}`;
            window.open(link, '_blank');
            fecharModalWhatsApp();
            
            if (modoWhatsAppAtual === 'pedido-pronto') {
                filtrarPedidos(); // Atualiza a lista para refletir a mudan√ßa de status
                showToast("Pedido marcado como pronto e notifica√ß√£o enviada!");
            } else {
                showToast(modoWhatsAppAtual === 'resumo' ? "Resumo enviado!" : "WhatsApp aberto!");
            }
        }

        // Fecha modal do WhatsApp
        function fecharModalWhatsApp() {
            document.getElementById('whatsapp-confirm-modal').style.display = 'none';
            pedidoWhatsAppAtual = null;
            modoWhatsAppAtual = 'resumo';
        }

        // ============================================================================
        // FUN√á√ïES AUXILIARES
        // ============================================================================
        function atualizarLocalmente(payload) {
            const p = todosPedidos.find(item => item.ID_do_Pedido === payload.ID_do_Pedido);
            if(p) {
                Object.keys(payload).forEach(key => {
                    if(key !== 'action') {
                        let val = payload[key];
                        if(typeof val === 'string' && val.startsWith("'")) val = val.substring(1);
                        p[key] = val;
                    }
                });
                filtrarPedidos();
            }
        }

        function mostrarLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.backgroundColor = isError ? '#e74c3c' : '#2ecc71';
            t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 3000);
        }
        function limparString(str) { return str.replace(/[^a-zA-Z0-9]/g, ''); }
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target == modal) fecharModal();
            
            const modalWhatsApp = document.getElementById('whatsapp-confirm-modal');
            if (event.target == modalWhatsApp) fecharModalWhatsApp();
            
            const modalResumos = document.getElementById('resumos-modal');
            if (event.target == modalResumos) fecharModalResumos();
        }

    </script>
</body>
</html>
</html>
