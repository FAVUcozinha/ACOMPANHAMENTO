<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEDIDOS FAVU COZINHA AFETIVA</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ========================================================================= */
        /* ESTILOS BASEADOS NO SEU C√ìDIGO DE OR√áAMENTO */
        /* ========================================================================= */
        @font-face {
            font-family: 'Basic Choice 2';
            /* ‚ö†Ô∏è AJUSTE O CAMINHO DA FONTE SE NECESS√ÅRIO ‚ö†Ô∏è */
            /* Exemplo local: src: url('fonts/Basic Choice 2.ttf') format('truetype'); */
            src: local('Roboto'), format('truetype'); /* Fallback tempor√°rio para garantir a visualiza√ß√£o */
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            background-color: #7FB1C8; /* Cor de fundo principal (azul) */
            margin: 0;
            padding: 0;
            color: #1A2B0F; /* Cor de texto principal (verde/escuro) */
        }
        header {
            background-color: #F4E6CB; /* Cor da sua barra de navega√ß√£o/rodap√© */
            color: #1A2B0F;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        h1 {
            font-size: 24px;
            margin: 0;
        }
        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .controls label, .controls button, .controls input {
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 14px;
            border: 1px solid #E09F41;
            background-color: #F4E6CB;
            color: #1A2B0F;
            cursor: pointer;
        }
        .controls input[type="month"] {
            width: 150px; /* Mais espa√ßo para o nome do m√™s */
            text-align: center;
        }
        .controls input[type="number"] {
            width: 80px;
            text-align: center;
        }
        #refresh-button {
            background-color: #E09F41;
            color: white;
            box-shadow: 0 4px #c2883a;
        }
        #refresh-button:active {
             box-shadow: 0 2px #c2883a;
             transform: translateY(2px);
        }

        /* DASHBOARD DE TOTAIS */
        #dashboard-totals {
            text-align: right;
            line-height: 1.2;
            padding-right: 15px;
        }
        #dashboard-totals strong {
            display: block;
            font-size: 1.5em;
            color: #E09F41;
        }
        #dashboard-totals span {
            font-size: 0.8em;
            color: #555;
        }

        /* ========================================================================= */
        /* KANBAN/CRM STYLES */
        /* ========================================================================= */
        #kanban-board {
            display: flex;
            gap: 15px;
            padding: 20px;
            overflow-x: auto;
            min-height: 80vh;
        }
        .kanban-column {
            flex-basis: 300px;
            flex-shrink: 0;
            background-color: #F4E6CB; /* Cor creme/clara */
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
            min-height: 70vh;
        }
        .column-header {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #E09F41; /* Linha Laranja */
            text-align: center;
            color: #1A2B0F;
        }
        .pedido-card {
            background-color: white;
            border: 1px solid #ddd;
            border-left: 5px solid #7FB1C8; /* Cor de destaque (Azul) */
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            color: #1A2B0F;
        }
        .pedido-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-title {
            font-weight: bold;
            font-size: 1.1em;
        }
        .card-detail {
            font-size: 0.9em;
            color: #555;
        }
        
        /* Cores dos Cards por Status (Adaptadas ao seu tema) */
        .status-Or√ßado { border-left-color: #E09F41; } /* Laranja: Novos Pedidos */
        .status-Pago-50- { border-left-color: #1abc9c; } /* Verde Claro: Em Andamento */
        .status-Pago { border-left-color: #2ecc71; } /* Verde: Pago */
        .status-Entregue { border-left-color: #1A2B0F; opacity: 0.7; } /* Cor do texto: Entregue */
        .status-Cancelado { border-left-color: #E60000; opacity: 0.6; } /* Vermelho: Cancelado */

        /* Drag & Drop Styles */
        .dragging { opacity: 0.5; border: 2px dashed #E09F41; }
        .over { background-color: #e8dcc6; }

        /* ========================================================================= */
        /* MODAL STYLES (Detalhes/Edi√ß√£o) */
        /* ========================================================================= */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #F4E6CB; /* Cor de fundo creme */
            margin: 5% auto;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 650px;
            position: relative;
            color: #1A2B0F;
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-button {
            color: #E09F41;
            float: right;
            font-size: 30px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover, .close-button:focus { color: #1A2B0F; text-decoration: none; cursor: pointer; }
        
        #modal-details {
            border-bottom: 2px dashed #E09F41;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        #modal-details strong {
            display: block;
            margin-top: 10px;
            color: #7FB1C8; /* Azul para destaque dos t√≠tulos */
            font-size: 1.1em;
        }
        #modal-details p {
            margin: 5px 0;
        }
        #modal-details pre {
            white-space: pre-wrap;
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #7FB1C8;
            color: #1A2B0F;
        }


        /* Estilos do formul√°rio de edi√ß√£o */
        #edit-form h3 { color: #E09F41; border-bottom: 1px solid #E09F41; padding-bottom: 5px; }
        #edit-form label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        #edit-form input, #edit-form textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            box-sizing: border-box;
            border: 1px solid #7FB1C8; /* Borda azul */
            border-radius: 8px;
            background-color: white;
            color: #1A2B0F;
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
        }
        #edit-form textarea {
            min-height: 150px;
            white-space: pre-wrap;
        }
        
        .modal-actions button, #edit-form button {
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            padding: 12px 20px;
            margin-top: 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px #4c7e93;
            transition: background-color 0.2s, box-shadow 0.1s;
        }
        .modal-actions button:active, #edit-form button:active {
             box-shadow: 0 2px #4c7e93;
             transform: translateY(2px);
        }

        #edit-button, #edit-form button[type="submit"] {
            background-color: #2ecc71; /* Verde */
            box-shadow: 0 4px #1c8d50;
        }
        #delete-button {
            background-color: #E60000; /* Vermelho */
            box-shadow: 0 4px #a00000;
        }
        #cancel-edit {
            background-color: #E09F41; /* Laranja */
            box-shadow: 0 4px #c2883a;
        }
        #open-calculator-button {
            background-color: #7FB1C8; /* Azul */
            box-shadow: 0 4px #4c7e93;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        /* Estilo para a √°rea de resumo edit√°vel */
        #resumo-editor-section {
            padding: 10px;
            background-color: #F4E6CB; /* Cor de fundo creme para o container */
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #7FB1C8;
        }
        
        /* Modal do Calculador (Flutuante sobre o modal de edi√ß√£o) */
        #calculator-modal {
             background-color: rgba(0,0,0,0.8);
             z-index: 1100;
             display: none;
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             justify-content: center;
             align-items: center;
        }
        #calculator-iframe {
            width: 95%;
            height: 95%;
            border: 5px solid #E09F41;
            border-radius: 15px;
            background-color: white;
        }

    </style>
</head>
<body>

    <header>
        <h1>PEDIDOS FAVU COZINHA AFETIVA</h1>
        <div class="controls">
             <div id="dashboard-totals">
                <strong>R$ 0,00</strong>
                <span id="total-pedidos">0 pedidos</span>
            </div>
        </div>
    </header>

    <div style="background-color: #F4E6CB; padding: 10px 20px; display: flex; gap: 10px; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <button id="refresh-button">Recarregar</button>
        <label for="month-filter">M√™s:</label>
        <input type="month" id="month-filter" value="">
        <label for="year-filter">Ano:</label>
        <input type="number" id="year-filter" value="" min="2023" max="2050">
    </div>

    <main id="kanban-board">
        </main>
    
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 id="modal-title">Detalhes do Pedido <span id="pedido-id"></span></h2>
            
            <div id="modal-details">
                <p><strong>Status:</strong> <span id="detail-status"></span></p>
                <p><strong>Cliente:</strong> <span id="detail-nome"></span></p>
                <p><strong>Data/Hora de Entrega:</strong> <span id="detail-data-hora"></span></p>
                <p><strong>Total Final:</strong> <span id="detail-total-final"></span></p>
                <strong>Resumo dos Itens:</strong> 
                <pre id="detail-resumo-itens"></pre>
            </div>

            <div class="modal-actions">
                <button id="edit-button">Editar Pedido</button>
                <button id="delete-button" class="danger">Excluir Pedido</button>
            </div>

            <form id="edit-form" style="display: none;">
                <h3>Editar Dados do Pedido</h3>
                
                <label>Nome do Cliente:</label>
                <input type="text" id="edit-nome" required><br>
                
                <label>Data de Entrega:</label>
                <input type="date" id="edit-data" required><br>
                
                <label>Hor√°rio de Entrega:</label>
                <input type="time" id="edit-horario" required><br>
                
                <label>Total Final (R$):</label>
                <input type="number" step="0.01" id="edit-total" required><br>
                
                <label>Resumo dos Itens (Edit√°vel):</label>
                <div id="resumo-editor-section">
                     <button type="button" id="open-calculator-button" onclick="openCalculatorModal()">Gerar Resumo por Itens</button>
                    <textarea id="edit-resumo" rows="8" required></textarea>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex-grow: 1;">Salvar Edi√ß√£o</button>
                    <button type="button" id="cancel-edit" style="flex-grow: 1;">Cancelar Edi√ß√£o</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="calculator-modal" class="modal" onclick="closeCalculatorModal(event)">
        <div style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;">
             <iframe id="calculator-iframe" src="" frameborder="0"></iframe>
        </div>
    </div>


    <script>
        // =========================================================================
        // JAVASCRIPT (L√ìGICA)
        // =========================================================================

        // =========================================================================
        // CONFIGURA√á√ÉO
        // üö®üö® SUBSTITUA ESTAS URLs PELOS SEUS ENDPOINTS REAIS üö®üö®
        // =========================================================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbzPg0luc_LKOhkOLrefXv202qDAHMHFHO_19WF4dtXoc_20MwykJzNI5IRuYlq0Rr5s/exec'; 
        // URL do seu site de pedidos/calculadora (se voc√™ quiser us√°-lo no modal de edi√ß√£o)
        const CALCULATOR_URL = 'https://favucozinha.github.io/Calculadora-Favu/'; 

        // Status que aparecer√£o nas colunas Kanban (com "Cancelado" no final)
        const KANBAN_STATUSES = [
            'Or√ßado',
            'Pago - 50%',
            'Pago',
            'Entregue', 
            'Cancelado'
        ];

        // O estado global da aplica√ß√£o
        let todosOsPedidos = [];
        let pedidoSendoEditado = null;
        
        // =========================================================================
        // CORRE√á√ïES E FUN√á√ïES DE UTILIDADE
        // =========================================================================

        /**
         * CORRE√á√ÉO CR√çTICA: Lida com datas de Apps Script (Date Object ou string) e formata para DD/MM/YYYY.
         * Garante que a data seja sempre formatada corretamente.
         */
        function formatDate(dateValue) {
            if (!dateValue) return 'N/A';
            
            let date;
            
            if (dateValue instanceof Date) {
                // Se for um objeto Date do Apps Script, us√°-lo diretamente pode causar problemas de timezone.
                // Usaremos Date() e extrairemos os componentes, tratando o offset se necess√°rio.
                date = dateValue;
            } else if (typeof dateValue === 'string') {
                // Assume formato YYYY-MM-DD (ISO) ou MM/DD/YYYY (US-like, comum na sa√≠da de Apps Script)
                // Tenta criar o objeto Date de forma segura (sem for√ßar o fuso hor√°rio local, o que causa o 1899)
                 date = new Date(dateValue.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1')); 
            } else {
                 return 'Data Inv√°lida';
            }
            
            // Verifica se a data √© v√°lida
            if (isNaN(date.getTime())) {
                return String(dateValue).split('T')[0] || 'Data Inv√°lida'; // Retorna o valor original ou N/A
            }

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            return `${day}/${month}/${year}`;
        }
        
        /**
         * CORRE√á√ÉO CR√çTICA: Normaliza a hora para exibi√ß√£o ou retorna 'N/A'.
         */
        function formatTime(timeValue) {
             if (!timeValue) return 'N/A';
             if (timeValue instanceof Date) {
                 // Se for objeto Date, retorna HH:MM (ajustado ao fuso local)
                 return timeValue.toTimeString().substring(0, 5);
             }
             // Assumimos formato string HH:MM ou HH:MM:SS
             return String(timeValue).substring(0, 5);
        }

        /**
         * Extrai apenas a lista de itens do resumo de texto longo (Mantido e revisado)
         */
        function extractResumoItens(fullResumo) {
            if (!fullResumo) return 'N/A';
            
            // As chaves no seu resumo de exemplo:
            // COME√áO: "- Resumo do pedido:"
            // FIM: "Total Final:"
            
            const startKey = '- Resumo do pedido:';
            const endKey = 'Total Final:';
            
            const startIndex = fullResumo.indexOf(startKey);
            const endIndex = fullResumo.indexOf(endKey);

            if (startIndex !== -1) {
                let resumo = fullResumo.substring(startIndex + startKey.length).trim();
                
                if (endIndex !== -1 && endIndex > startIndex) {
                    // Se a chave "Total Final" for encontrada, corta antes dela
                    resumo = fullResumo.substring(startIndex + startKey.length, endIndex).trim();
                }
                
                // Limpa quebras de linha/espa√ßos no in√≠cio e fim
                return resumo.replace(/^\s*\n/g, '').replace(/\n\s*$/g, '');
            }

            return fullResumo; // Retorna o texto completo se o padr√£o n√£o for encontrado
        }
        
        // =========================================================================
        // FUN√á√ïES DE COMUNICA√á√ÉO E RENDERIZA√á√ÉO
        // =========================================================================

        /**
         * Fun√ß√£o para buscar os dados da planilha via Apps Script
         */
        async function fetchPedidos() {
            document.getElementById('refresh-button').textContent = 'Carregando...';
            document.getElementById('refresh-button').disabled = true;
            document.getElementById('total-pedidos').textContent = '...';

            try {
                const response = await fetch(`${API_URL}?action=read`);
                const json = await response.json();

                if (json.success) {
                    todosOsPedidos = json.pedidos.map(p => {
                        let dataStr = p.Data_da_Entrega;
                        
                        // Garante que a data seja uma string YYYY-MM-DD para o input[type="date"]
                        if (dataStr instanceof Date) {
                             dataStr = dataStr.toISOString().substring(0, 10);
                        } else if (typeof dataStr === 'string' && dataStr.includes('/')) {
                             // Se vier em DD/MM/YYYY, o input[type="date"] n√£o aceitar√°
                             const parts = dataStr.split('/');
                             if (parts.length === 3) dataStr = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        }
                        
                        // Tenta criar uma data v√°lida para ordena√ß√£o
                        let sortDate = new Date();
                        try {
                            // Cria a data no formato ISO completo para garantir a hora (YYY-MM-DDTHH:MM:SS)
                            sortDate = new Date(`${dataStr}T${p.Hor√°rio_da_Entrega || '00:00'}:00`);
                        } catch (e) {
                             console.warn(`Erro ao criar data de ordena√ß√£o para pedido ${p.ID_do_Pedido}:`, e);
                             sortDate = new Date(0); // Coloca no in√≠cio da lista se a data for inv√°lida
                        }
                        
                        return {
                            ...p,
                            Data_da_Entrega: dataStr, // String no formato YYYY-MM-DD
                            sortDate: sortDate 
                        };
                    });
                    
                    // Ordena os pedidos pela data/hora de entrega mais pr√≥xima
                    todosOsPedidos.sort((a, b) => a.sortDate - b.sortDate);

                    renderKanban();
                    updateDashboardTotals();
                } else {
                    console.error("Erro ao buscar pedidos:", json.message);
                    alert("Erro ao carregar os pedidos: " + json.message);
                }
            } catch (error) {
                console.error("Erro na comunica√ß√£o com a API:", error);
                alert("Erro de rede ao carregar os pedidos.");
            } finally {
                document.getElementById('refresh-button').textContent = 'Recarregar';
                document.getElementById('refresh-button').disabled = false;
            }
        }

        /**
         * Fun√ß√£o para renderizar o quadro Kanban e os cards
         */
        function renderKanban() {
            const kanbanBoard = document.getElementById('kanban-board');
            kanbanBoard.innerHTML = ''; // Limpa o quadro
            
            const currentFilterYear = document.getElementById('year-filter').value;
            // month-filter retorna 'YYYY-MM'. Pegamos o MM
            const currentFilterMonth = document.getElementById('month-filter').value.split('-')[1]; 

            KANBAN_STATUSES.forEach(status => {
                const column = document.createElement('div');
                column.className = 'kanban-column';
                column.dataset.status = status; 
                column.addEventListener('dragover', dragOver);
                column.addEventListener('drop', drop);
                column.addEventListener('dragleave', dragLeave);

                const header = document.createElement('div');
                header.className = 'column-header';
                
                let filteredPedidos = todosOsPedidos.filter(p => p.Status === status);

                // Filtra pelo m√™s e ano de entrega
                if (currentFilterMonth && currentFilterYear) {
                    filteredPedidos = filteredPedidos.filter(p => {
                        const pedidoDate = new Date(p.Data_da_Entrega);
                        // A data da entrega est√° no formato YYYY-MM-DD. Tenta criar a data.
                        const dateParts = String(p.Data_da_Entrega).split('-');
                        
                        if (dateParts.length === 3) {
                             const pYear = dateParts[0];
                             const pMonth = dateParts[1];
                             
                             return pMonth == currentFilterMonth && pYear == currentFilterYear;
                        }
                        return false; // Se a data estiver inv√°lida, n√£o inclui no filtro
                    });
                }

                header.textContent = `${status} (${filteredPedidos.length})`;
                column.appendChild(header);

                // Adiciona os cards de pedidos
                filteredPedidos.forEach(pedido => {
                    const card = createPedidoCard(pedido);
                    column.appendChild(card);
                });

                kanbanBoard.appendChild(column);
            });
        }
        
        /**
         * Atualiza os totais e a exibi√ß√£o do dashboard no cabe√ßalho
         */
        function updateDashboardTotals() {
            let totalLiquidoGeral = 0;
            let totalPedidosContados = 0;
            // Inclui status 'Entregue' no total, mas exclui 'Cancelado'
            const statusToCount = ['Or√ßado', 'Pago - 50%', 'Pago', 'Entregue'];

            todosOsPedidos.forEach(p => {
                 const total = parseFloat(p.Total_Final || 0);
                 if (statusToCount.includes(p.Status)) {
                      totalLiquidoGeral += total;
                      totalPedidosContados++;
                 }
            });

            document.querySelector('#dashboard-totals strong').textContent = `R$ ${totalLiquidoGeral.toFixed(2).replace('.', ',')}`;
            document.getElementById('total-pedidos').textContent = `${totalPedidosContados} pedidos`;
        }

        /**
         * Cria o elemento HTML para um card de pedido
         */
        function createPedidoCard(pedido) {
            const card = document.createElement('div');
            const sanitizedStatus = pedido.Status.replace(/[^a-zA-Z0-9]/g, '-').replace(/-+/g, '-').trim('-');

            card.className = `pedido-card status-${sanitizedStatus}`;
            card.setAttribute('draggable', true);
            card.dataset.id = pedido.ID_do_Pedido;

            const total = parseFloat(pedido.Total_Final || 0).toFixed(2).replace('.', ',');
            
            // CORRE√á√ÉO CR√çTICA: Chamada das fun√ß√µes de formata√ß√£o
            const data = formatDate(pedido.Data_da_Entrega);
            const hora = formatTime(pedido.Hor√°rio_da_Entrega);
            const dataHora = `${data} √†s ${hora}`;

            card.innerHTML = `
                <div class="card-title">${pedido.Nome_do_Cliente}</div>
                <div class="card-detail">Entrega: ${dataHora}</div>
                <div class="card-detail">Total: R$ ${total}</div>
                <div class="card-detail" style="font-weight: bold;">ID: ${pedido.ID_do_Pedido}</div>
            `;

            card.addEventListener('dragstart', dragStart);
            // CORRE√á√ÉO: O clique agora chama a fun√ß√£o showModal corretamente
            card.addEventListener('click', () => showModal(pedido.ID_do_Pedido)); 

            return card;
        }

        // =========================================================================
        // FUN√á√ïES DE DRAG AND DROP E UPDATE
        // =========================================================================
        
        // (As fun√ß√µes dragStart, dragOver, dragLeave, drop e updatePedidoStatus foram mantidas sem altera√ß√µes)
        function dragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.id);
            e.target.classList.add('dragging');
        }

        function dragOver(e) {
            e.preventDefault(); 
            const column = e.currentTarget;
            column.classList.add('over');
        }

        function dragLeave(e) {
            e.currentTarget.classList.remove('over');
        }

        async function drop(e) {
            e.preventDefault();
            const column = e.currentTarget;
            const newStatus = column.dataset.status;
            const pedidoId = e.dataTransfer.getData('text/plain');
            const draggedCard = document.querySelector(`.dragging[data-id="${pedidoId}"]`);

            column.classList.remove('over');
            
            if (draggedCard) {
                draggedCard.classList.remove('dragging');
                column.appendChild(draggedCard);
            }
            
            await updatePedidoStatus(pedidoId, newStatus);
        }

        async function updatePedidoStatus(id, status) {
            const formData = new URLSearchParams();
            formData.append('action', 'updateStatus');
            formData.append('id', id);
            formData.append('status', status);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                const json = await response.json();

                if (json.success) {
                    await fetchPedidos(); 
                } else {
                    alert(`Falha ao atualizar status: ${json.message}`);
                    await fetchPedidos(); 
                }
            } catch (error) {
                alert("Erro de rede ao tentar atualizar o status.");
                await fetchPedidos(); 
            }
        }


        // =========================================================================
        // MODAL/EDI√á√ÉO/FLUXO
        // =========================================================================

        const modal = document.getElementById('modal');
        const editForm = document.getElementById('edit-form');

        /**
         * Mostra o modal com os detalhes do pedido
         */
        function showModal(id) {
            const pedido = todosOsPedidos.find(p => p.ID_do_Pedido === id);
            if (!pedido) return;

            pedidoSendoEditado = pedido; 
            
            const totalFormatado = parseFloat(pedido.Total_Final || 0).toFixed(2).replace('.', ',');
            
            // CORRE√á√ÉO CR√çTICA: Uso das novas fun√ß√µes de formata√ß√£o
            const data = formatDate(pedido.Data_da_Entrega);
            const hora = formatTime(pedido.Hor√°rio_da_Entrega);
            const dataHora = `${data} √†s ${hora}`;
            
            // 1. Vis√£o de Detalhes
            document.getElementById('modal-title').textContent = `Detalhes do Pedido ${id}`;
            document.getElementById('pedido-id').textContent = id;
            document.getElementById('detail-status').textContent = pedido.Status;
            document.getElementById('detail-nome').textContent = pedido.Nome_do_Cliente;
            document.getElementById('detail-data-hora').textContent = dataHora;
            document.getElementById('detail-total-final').textContent = `R$ ${totalFormatado}`;
            document.getElementById('detail-resumo-itens').textContent = extractResumoItens(pedido.Resumo_dos_Itens);


            // 2. Formul√°rio de Edi√ß√£o (Preenchimento)
            document.getElementById('edit-nome').value = pedido.Nome_do_Cliente;
            // Data e Hora j√° devem estar no formato YYYY-MM-DD e HH:MM, adequado para input HTML
            document.getElementById('edit-data').value = pedido.Data_da_Entrega;
            document.getElementById('edit-horario').value = pedido.Hor√°rio_da_Entrega;
            document.getElementById('edit-total').value = totalFormatado.replace(',', '.'); 
            document.getElementById('edit-resumo').value = pedido.Resumo_dos_Itens;
            
            // 3. Exibi√ß√£o
            modal.style.display = 'flex';
            document.getElementById('modal-details').style.display = 'block';
            document.querySelector('.modal-actions').style.display = 'block';
            editForm.style.display = 'none'; // Sempre come√ßa com a vis√£o de detalhes
        }

        /**
         * Fecha o modal
         */
        function closeModal() {
            modal.style.display = 'none';
            pedidoSendoEditado = null;
            // Garante que a visualiza√ß√£o de detalhes seja reexibida ao fechar e reabrir
            document.getElementById('modal-details').style.display = 'block';
            document.querySelector('.modal-actions').style.display = 'block';
            editForm.style.display = 'none';
        }

        /**
         * Alterna para o formul√°rio de edi√ß√£o
         */
        document.getElementById('edit-button').addEventListener('click', () => {
            document.getElementById('modal-details').style.display = 'none';
            document.querySelector('.modal-actions').style.display = 'none';
            editForm.style.display = 'block';
        });

        document.getElementById('cancel-edit').addEventListener('click', () => {
            document.getElementById('modal-details').style.display = 'block';
            document.querySelector('.modal-actions').style.display = 'block';
            editForm.style.display = 'none';
        });
        
        /**
         * Abre o modal do iframe da calculadora de itens 
         */
        function openCalculatorModal() {
            if (!CALCULATOR_URL) {
                 alert("URL do calculador n√£o configurada. Defina a constante CALCULATOR_URL no c√≥digo.");
                 return;
            }
            document.getElementById('calculator-iframe').src = CALCULATOR_URL;
            document.getElementById('calculator-modal').style.display = 'flex';
            
            // Opcional: Adicionar um listener para capturar a sa√≠da da calculadora
            // window.addEventListener('message', handleCalculatorOutput);
        }
        
        /**
         * Fecha o modal da calculadora
         */
        function closeCalculatorModal(event) {
             // Fecha apenas se clicar no overlay (o iframe n√£o deve fechar o modal)
             if (event.target.id === 'calculator-modal') {
                document.getElementById('calculator-iframe').src = ''; 
                document.getElementById('calculator-modal').style.display = 'none';
             }
        }
        
        /**
         * Atualiza os dados do pedido (POST action=updateData)
         */
        async function updatePedidoData(data) {
            const formData = new URLSearchParams();
            formData.append('action', 'updateData');
            
            for (const key in data) {
                formData.append(key, data[key]);
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                const json = await response.json();

                if (json.success) {
                    alert(`Dados do pedido ${data.id} atualizados com sucesso!`);
                    closeModal();
                    await fetchPedidos(); 
                } else {
                    alert(`Falha ao atualizar dados: ${json.message}`);
                }
            } catch (error) {
                alert("Erro de rede ao tentar atualizar os dados.");
            }
        }

        /**
         * Excluir o pedido (Requer ajuste no Apps Script!)
         */
        document.getElementById('delete-button').addEventListener('click', () => {
            if (!pedidoSendoEditado) return;
            if (!confirm(`Tem certeza que deseja EXCLUIR o pedido ${pedidoSendoEditado.ID_do_Pedido}? Esta a√ß√£o √© IRREVERS√çVEL (na planilha)!`)) {
                return;
            }
            
            alert("Aten√ß√£o: A fun√ß√£o de 'delete' (excluir) n√£o est√° implementada na API do Apps Script fornecida. O pedido n√£o foi exclu√≠do.");
            closeModal();
        });


        // =========================================================================
        // INICIALIZA√á√ÉO E EVENTOS
        // =========================================================================

        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Inicializa Filtros de M√™s e Ano
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = String(today.getMonth() + 1).padStart(2, '0');
            
            document.getElementById('month-filter').value = `${currentYear}-${currentMonth}`;
            document.getElementById('year-filter').value = currentYear;

            // 2. Inicializa o carregamento dos pedidos
            fetchPedidos();

            // 3. Eventos de bot√µes/filtros
            document.getElementById('refresh-button').addEventListener('click', fetchPedidos);
            document.getElementById('month-filter').addEventListener('change', renderKanban);
            document.getElementById('year-filter').addEventListener('change', renderKanban);

            // 4. Polling (Atualiza√ß√£o em "Tempo Real" - 30 segundos)
            setInterval(fetchPedidos, 30000); 
            
            // 5. Fechar modal principal ao clicar fora
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeModal();
                }
            });
             
        });
    </script>
</body>
</html>
