<script>
    // üö®üö® URL DO APPS SCRIPT - COLOQUE A URL COMPLETA E CORRETA AQUI üö®üö®
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzPg0luc_LKOhkOLrefXv202qDAHMHFHO_19WF4dtXoc_20MwykJzNI5IRuYlq0Rr5s/exec"; 
    
    // Define as novas op√ß√µes de status
    const STATUS_OPTIONS = [
        "Or√ßado", 
        "Agendado - Pago", 
        "Agendado - 50%", 
        "Agendado - Pendente", 
        "Entregue", 
        "Cancelado"
    ];

    // Mapeamento de Status para classes de estilo
    const STATUS_CLASSES = {
        "Or√ßado": "status-orcado",
        "Agendado - Pago": "status-pago",
        "Agendado - 50%": "status-50",
        "Agendado - Pendente": "status-pendente",
        "Entregue": "status-entregue",
        "Cancelado": "status-cancelado"
    };
    
    // Status que devem ser exibidos no painel (em andamento)
    const STATUS_EM_ANDAMENTO = [
        "Or√ßado", 
        "Agendado - Pago", 
        "Agendado - 50%", 
        "Agendado - Pendente"
    ];

    // Fun√ß√£o auxiliar para lidar com Timeout
    function fetchWithTimeout(resource, options = {}) {
        const { timeout = 15000 } = options; // 15 segundos
        
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);

        return fetch(resource, {
            ...options,
            signal: controller.signal  
        }).finally(() => {
            clearTimeout(id);
        });
    }


    async function carregarPedidos() {
        const container = document.getElementById('lista-pedidos');
        container.innerHTML = '<table><thead><tr><th>ID Pedido</th><th>Status</th><th>Cliente / Data / Hor√°rio</th><th>Total</th><th>Resumo</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>';
        const tbody = container.querySelector('tbody');
        container.classList.add('loading');

        try {
            // Requisi√ß√£o com limite de tempo (timeout) de 15 segundos
            const response = await fetchWithTimeout(`${APPS_SCRIPT_URL}?action=read`);
            const data = await response.json();

            if (!data.success) {
                // Se o Apps Script responder com sucesso: false (indicando erro interno ou na planilha)
                tbody.innerHTML = `<tr><td colspan="6">‚ùå Erro no Apps Script ao ler dados. Mensagem: ${data.message || 'Resposta inv√°lida.'}</td></tr>`;
                return;
            }

            // Filtra e inverte a ordem para mostrar os mais novos primeiro
            const pedidosEmAndamento = data.pedidos
                .filter(p => STATUS_EM_ANDAMENTO.includes(p.Status))
                .reverse(); 

            if (pedidosEmAndamento.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6">Nenhum pedido em aberto.</td></tr>`;
                return;
            }
            
            const MAX_RESUMO_LENGTH = 100;

            pedidosEmAndamento.forEach(pedido => { 
                // CHAVES LENDO OS NOMES FORMATADOS PELO APPS SCRIPT (com underscore)
                const id = pedido.ID_do_Pedido || 'N/A';
                const statusAtual = pedido.Status || 'Or√ßado';
                const resumo = pedido.Resumo_dos_Itens || 'Sem Resumo'; 
                const nomeCliente = pedido.Nome_do_Cliente || 'N/A';
                const dataEntrega = pedido.Data_da_Entrega || '---';
                const horarioEntrega = pedido.Hor√°rio_da_Entrega || '---';
                // Garante que o Total_Final existe e √© formatado.
                const totalFinal = pedido.Total_Final !== undefined && pedido.Total_Final !== null ? pedido.Total_Final : '0,00';
                
                const resumoSimplificado = resumo.length > MAX_RESUMO_LENGTH ? resumo.substring(0, MAX_RESUMO_LENGTH) + '...' : resumo;
                
                // Converte a data (ex: dd/mm/aaaa) para o formato esperado pelo input type="date" (yyyy-mm-dd)
                const dataParaInput = dataEntrega !== '---' && typeof dataEntrega === 'string'
                    ? dataEntrega.split('/').reverse().join('-') 
                    : '';
                
                // Trata o total, convertendo-o para string caso venha como n√∫mero do Apps Script
                const totalParaExibir = String(totalFinal).replace('.', ',');


                let row = document.createElement('tr');
                row.id = `pedido-${id}`;
                // Armazena todos os dados do pedido na linha para facilitar a edi√ß√£o
                row.dataset.pedido = JSON.stringify({
                    id: id,
                    cliente: nomeCliente,
                    data: dataParaInput, // Formato yyyy-mm-dd
                    horario: horarioEntrega,
                    total: totalParaExibir,
                    resumo: resumo
                });

                row.innerHTML = `
                    <td>${id}</td>
                    <td><span id="status-${id}" class="${STATUS_CLASSES[statusAtual]}">${statusAtual}</span></td>
                    <td>
                        <strong>${nomeCliente}</strong><br>
                        Data: ${dataEntrega}<br>
                        Hor√°rio: ${horarioEntrega}
                    </td>
                    <td>R$ ${totalParaExibir}</td>
                    <td title="${resumo}">${resumoSimplificado}</td>
                    <td>
                        <select id="select-status-${id}" data-id="${id}">
                            ${STATUS_OPTIONS.map(status => `
                                <option value="${status}" ${status === statusAtual ? 'selected' : ''}>
                                    ${status}
                                </option>
                            `).join('')}
                        </select>
                        <button onclick="atualizarStatusPedido('${id}')">Salvar Status</button>
                        <button class="edit-button" onclick="abrirModalEdicao('${id}')">Editar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
        } catch (error) {
            console.error("Erro na comunica√ß√£o com a API:", error);
            // Se o erro for de Timeout
            if (error.name === 'AbortError') {
                 container.innerHTML = '<table><tr><td colspan="6">‚è≥ A leitura de dados excedeu o tempo limite (15s). Verifique se o Apps Script est√° demorando demais para processar.</td></tr></table>';
            } else if (error instanceof SyntaxError) {
                // Se a API n√£o retornar JSON v√°lido (Apps Script retornou HTML de erro ou texto simples)
                container.innerHTML = '<table><tr><td colspan="6">‚ùå Erro de formato. O Apps Script n√£o retornou um JSON v√°lido. Verifique os Logs do Apps Script.</td></tr></table>';
            } else {
                 container.innerHTML = '<table><tr><td colspan="6">‚ùå Erro de rede ou na URL do Apps Script.</td></tr></table>';
            }
        } finally {
            container.classList.remove('loading');
        }
    }
    
    // As fun√ß√µes atualizarStatusPedido, abrirModalEdicao, fecharModalEdicao e salvarEdicao
    // devem ser coladas aqui abaixo (s√£o as que te passei anteriormente e est√£o corretas).
    
    async function atualizarStatusPedido(idPedido) {
        // ... (Cole a fun√ß√£o atualizarStatusPedido que te passei aqui) ...
        const select = document.getElementById(`select-status-${idPedido}`);
        const novoStatus = select.value;
        const statusDisplay = document.getElementById(`status-${idPedido}`);
        const botao = select.nextElementSibling;
        
        const statusAnterior = statusDisplay.textContent;
        statusDisplay.textContent = 'Aguarde...';
        statusDisplay.className = '';
        botao.disabled = true;

        const urlEncodedData = new URLSearchParams();
        urlEncodedData.append('action', 'updateStatus');
        urlEncodedData.append('id', idPedido);
        urlEncodedData.append('status', novoStatus);
        
        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: urlEncodedData 
            });
            
            const data = await response.json();

            if (data.success) {
                alert(`Status do Pedido ${idPedido} atualizado para ${novoStatus}.`);
                
                if (!STATUS_EM_ANDAMENTO.includes(novoStatus)) {
                    document.getElementById(`pedido-${idPedido}`).remove();
                } else {
                    statusDisplay.textContent = novoStatus;
                    statusDisplay.className = STATUS_CLASSES[novoStatus]; 
                }
            } else {
                alert(`Erro ao atualizar o status: ${data.message}`);
                statusDisplay.textContent = statusAnterior;
                statusDisplay.className = STATUS_CLASSES[statusAnterior]; 
            }
        } catch (error) {
            console.error("Erro de rede:", error);
            alert("Erro de rede ao atualizar o status.");
            statusDisplay.textContent = statusAnterior;
            statusDisplay.className = STATUS_CLASSES[statusAnterior]; 
        } finally {
            botao.disabled = false;
        }
    }
    
    function abrirModalEdicao(idPedido) {
        const row = document.getElementById(`pedido-${idPedido}`);
        const pedidoData = JSON.parse(row.dataset.pedido);
        
        document.getElementById('modal-id-pedido').textContent = pedidoData.id;
        document.getElementById('edit-id-pedido').value = pedidoData.id;
        document.getElementById('edit-cliente').value = pedidoData.cliente;
        document.getElementById('edit-data').value = pedidoData.data;
        document.getElementById('edit-horario').value = pedidoData.horario;
        document.getElementById('edit-total').value = pedidoData.total;
        document.getElementById('edit-resumo').value = pedidoData.resumo;

        document.getElementById('modal-edicao').style.display = "block";
    }
    
    function fecharModalEdicao() {
        document.getElementById('modal-edicao').style.display = "none";
    }
    
    async function salvarEdicao() {
        const idPedido = document.getElementById('edit-id-pedido').value;
        const cliente = document.getElementById('edit-cliente').value;
        const dataEntrega = document.getElementById('edit-data').value;
        const horarioEntrega = document.getElementById('edit-horario').value;
        const totalFinal = document.getElementById('edit-total').value;
        const resumo = document.getElementById('edit-resumo').value;

        // Formata a data de volta para dd/mm/aaaa para o Apps Script
        const dataFormatada = dataEntrega.split('-').reverse().join('/'); 

        const urlEncodedData = new URLSearchParams();
        urlEncodedData.append('action', 'updateData');
        urlEncodedData.append('id', idPedido);
        urlEncodedData.append('Nome_do_Cliente', cliente);
        urlEncodedData.append('Data_da_Entrega', dataFormatada); 
        urlEncodedData.append('Hor√°rio_da_Entrega', horarioEntrega);
        urlEncodedData.append('Total_Final', totalFinal);
        urlEncodedData.append('Resumo_dos_Itens', resumo);
        
        const modal = document.getElementById('modal-edicao');
        const saveButton = modal.querySelector('button[onclick="salvarEdicao()"]');
        saveButton.textContent = 'Salvando...';
        saveButton.disabled = true;

        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: urlEncodedData 
            });
            
            const data = await response.json();

            if (data.success) {
                alert(`Dados do Pedido ${idPedido} atualizados com sucesso!`);
                fecharModalEdicao();
                carregarPedidos(); // Recarrega a lista para mostrar a mudan√ßa
            } else {
                alert(`Erro ao salvar edi√ß√µes: ${data.message}`);
            }
        } catch (error) {
            console.error("Erro de rede:", error);
            alert("Erro de rede ao salvar edi√ß√µes.");
        } finally {
            saveButton.textContent = 'Salvar Edi√ß√µes';
            saveButton.disabled = false;
        }
    }

    // --- Inicializa√ß√£o e Atualiza√ß√£o Autom√°tica ---
    
    // Chamada inicial
    document.addEventListener('DOMContentLoaded', carregarPedidos);

    // Atualiza√ß√£o autom√°tica a cada 5 minutos (300000 milissegundos)
    setInterval(carregarPedidos, 300000); 

</script>
</body>
</html>
