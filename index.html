<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEDIDOS FAVU COZINHA AFETIVA</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ========================================================================= */
        /* FONTES E VARI√ÅVEIS */
        /* ========================================================================= */
        @font-face {
            font-family: 'Basic Choice 2';
            src: url('fonts/Basic Choice 2.ttf') format('truetype'),
                 local('Roboto'); 
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --cor-fundo-azul: #7FB1C8;
            --cor-fundo-creme: #F4E6CB;
            --cor-laranja-forte: #E09F41;
            --cor-verde: #2ecc71;
            --cor-vermelho: #e74c3c;
            --cor-texto: #1A2B0F;
        }

        /* ========================================================================= */
        /* ESTILOS GERAIS */
        /* ========================================================================= */
        body {
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            background-color: var(--cor-fundo-azul); /* Fundo Azul igual da imagem */
            margin: 0;
            padding: 0;
            color: var(--cor-texto);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* HEADER */
        header {
            background-color: var(--cor-fundo-creme); /* Fundo Creme */
            color: var(--cor-texto);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        h1 { font-size: 24px; margin: 0; display: flex; flex-direction: column; }
        h1 .title-line1 { font-weight: bold; font-size: 1.2em; }
        h1 .title-line2 { font-size: 0.8em; color: var(--cor-laranja-forte); display:none; } 
        /* Na imagem parece ser s√≥ o texto preto, ajuste se necess√°rio */

        #dashboard-totals {
            text-align: right;
            background: rgba(255,255,255,0.5);
            padding: 5px 15px;
            border-radius: 10px;
            border: 1px solid var(--cor-laranja-forte);
        }
        #dashboard-totals strong { display: block; font-size: 1.4em; color: var(--cor-laranja-forte); }
        #dashboard-totals span { font-size: 0.9em; color: #555; }

        /* Tag de Pagamento no Card */
        .payment-type-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 0.7em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .payment-type-tag.pix { background-color: #32CD32; color: white; }
        .payment-type-tag.dinheiro { background-color: #FFD700; color: #333; }
        .payment-type-tag.cartao { background-color: #4169E1; color: white; }

        /* BARRA DE FILTROS */
        .filter-bar {
            background-color: var(--cor-fundo-creme); 
            padding: 10px 20px; 
            display: flex; 
            gap: 30px; 
            align-items: flex-start; 
            flex-wrap: wrap;
            border-bottom: 2px solid var(--cor-laranja-forte);
            flex-shrink: 0;
        }

        .filter-group-main {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .filter-group-additional {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            flex-wrap: wrap;
            margin-left: 40px; /* Espa√ßamento entre os grupos */
        }

        .search-filter, .date-filter, .payment-filter, .payment-method-filter, .observation-filter {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 0 0 auto;
            min-width: 200px;
        }
        
        .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #5a9bd4;
            border-radius: 15px;
            font-family: inherit;
            color: var(--cor-texto);
            background-color: #fff;
            width: 100%;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .filter-bar select:focus {
            outline: none;
            border-color: #5a9bd4;
        }

        .search-filter label, .date-filter label, .payment-filter label, .payment-method-filter label, .observation-filter label {
            color: #333;
            font-size: 0.9em;
            font-weight: normal;
        }

        .filter-bar input {
            padding: 8px 12px;
            border: 1px solid #5a9bd4; /* Borda azul clara */
            border-radius: 15px; /* Cantos mais arredondados */
            font-family: inherit;
            color: var(--cor-texto);
            background-color: #fff;
            width: 100%;
            transition: border-color 0.2s;
        }

        .filter-bar input:focus {
            outline: none;
            border-color: #5a9bd4;
        }

        .filter-bar input::placeholder {
            color: #999;
        }

        /* ========================================================================= */
        /* KANBAN BOARD */
        /* ========================================================================= */
        #main-content {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 20px;
            display: flex;
            align-items: flex-start;
        }

        #kanban-board {
            display: flex;
            gap: 15px;
            height: 100%;
            padding-bottom: 10px;
            width: 100%;
        }

        .kanban-column {
            background-color: var(--cor-fundo-creme); /* Colunas Creme */
            min-width: 300px;
            width: 300px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .column-header {
            padding: 15px;
            /* Na imagem o header n√£o tem fundo escuro, parece transparente ou mesma cor da coluna */
            background-color: transparent; 
            border-bottom: 2px solid var(--cor-laranja-forte);
            font-weight: bold;
            color: var(--cor-texto);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            cursor: default;
        }
        
        /* Indicador de expans√£o/colapso no mobile */
        .column-toggle {
            display: none;
            font-size: 1.2em;
            margin-left: 10px;
            transition: transform 0.3s;
        }
        
        .kanban-column.collapsed .column-toggle {
            transform: rotate(-90deg);
        }
        
        .column-select-all-checkbox {
            width: 18px; height: 18px; cursor: pointer;
        }

        .column-content {
            padding: 10px;
            overflow-y: auto;
            flex: 1;
        }

        /* ========================================================================= */
        /* CARDS (ESTILO DA IMAGEM) */
        /* ========================================================================= */
        .pedido-card {
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 5px solid #ccc; /* Cor padr√£o, sobrescrita por status */
            cursor: grab;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .pedido-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .pedido-card.selected { border: 2px solid var(--cor-laranja-forte); }
        
        /* Tag de Observa√ß√£o - abaixo do ID do pedido com preenchimento amarelo */
        .observacao-tag {
            display: inline-block;
            background-color: #fff9c4; /* Amarelo claro com preenchimento */
            color: #f57f17; /* Amarelo mais escuro para o texto */
            font-size: 0.65em;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 3px 6px;
            border-radius: 4px;
            margin-top: 2px;
        }

        /* Cores dos Status */
        .status-Pedido-Recebido { border-left-color: #3498db; }
        .status-Pedido-Confirmado { border-left-color: var(--cor-laranja-forte); }
        .status-Aguardando-Retirada { border-left-color: #9b59b6; }
        .status-Entregue { border-left-color: var(--cor-verde); }
        .status-Cancelado { 
            border-left-color: var(--cor-vermelho); 
            opacity: 0.5; 
        }
        .status-Cancelado * {
            opacity: 1; /* Mant√©m o conte√∫do interno com opacidade total para legibilidade */
        }

        /* Cabe√ßalho do Card (Checkbox e ID) */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-checkbox { cursor: pointer; width: 18px; height: 18px; margin-top: 2px; }
        .card-id { font-size: 0.75em; color: #5a9bd4; font-weight: bold; } /* Azul igual da imagem */

        /* T√≠tulo do Card */
        .card-title { font-weight: bold; font-size: 1em; color: #000; margin-bottom: 5px; line-height: 1.2; }

        /* BOX DE INFORMA√á√ÉO (SEM FUNDO COLORIDO) */
        .card-info-box {
            background-color: transparent;
            border-radius: 5px;
            padding: 8px;
            font-size: 0.9em;
            color: #333;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .card-info-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-icon {
            font-size: 1.2em; /* Tamanho dos emojis */
            width: 20px;
            text-align: center;
        }
        
        /* Bot√£o de n√∫mero (oculto) */
        .card-numero-btn {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            cursor: pointer;
            color: inherit;
            font-size: inherit;
            font-family: inherit;
            text-decoration: underline;
            text-decoration-style: dotted;
        }
        .card-numero-btn:hover {
            color: var(--cor-laranja-forte);
        }

        /* Cupom no Card */
        .card-cupom {
            font-size: 0.85em;
            color: var(--cor-laranja-forte);
            margin-top: 5px;
            margin-bottom: 3px;
        }
        .card-cupom-label {
            font-weight: bold;
        }
        .card-cupom-valor {
            color: var(--cor-texto);
        }

        /* Pre√ßo */
        .card-price {
            font-weight: bold; 
            color: var(--cor-texto); 
            font-size: 0.9em;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        /* Select de Pagamento no Card com Fundo Colorido */
        .card-status-pagamento {
            margin-top: 8px;
            width: 100%;
        }
        .card-status-pagamento select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 5px;
            border: none;
            font-size: 0.85em;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            color: white;
        }
        /* Cores destacadas para o status de pagamento - tons suaves e claros */
        .card-status-pagamento select.pg-pendente { 
            background-color: #ffb3b3; /* Vermelho claro e suave */
            color: #8b0000; /* Texto vermelho escuro para contraste */
        }
        .card-status-pagamento select.pg-pago { 
            background-color: #a8e6a8; /* Verde claro e suave */
            color: #006400; /* Texto verde escuro para contraste */
        }
        .card-status-pagamento select.pg-parcial { 
            background-color: #ffeb9c; /* Amarelo claro e suave */
            color: #8b6914; /* Texto marrom/amarelo escuro para contraste */
        }

        /* MODAL DE EDI√á√ÉO */
        .modal {
            display: none;
            position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--cor-fundo-creme);
            padding: 25px; border-radius: 10px; width: 90%; max-width: 500px;
            max-height: 90vh; overflow-y: auto; position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-button { position: absolute; right: 20px; top: 15px; font-size: 28px; cursor: pointer; color: var(--cor-laranja-forte); }
        
        #edit-form label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }
        #edit-form input, #edit-form select, #edit-form textarea {
            width: 100%; padding: 10px; margin-top: 5px;
            border: 1px solid var(--cor-fundo-azul); border-radius: 8px;
            box-sizing: border-box; font-family: inherit;
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-save { background-color: var(--cor-verde); color: white; padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .btn-cancel { background-color: var(--cor-vermelho); color: white; padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }

        /* BARRA DE A√á√ïES EM LOTE */
        #bulk-actions-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: white; padding: 15px 25px; border-radius: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none; align-items: center; gap: 15px; z-index: 1500;
        }
        #bulk-actions-bar.show { display: flex; }
        #bulk-actions-bar button { padding: 8px 15px; border-radius: 20px; border: none; color: white; font-weight: bold; cursor: pointer; }

        /* Loading & Toast */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 3000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--cor-laranja-forte); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast { position: fixed; top: 20px; right: 20px; background-color: var(--cor-verde); color: white; padding: 15px 25px; border-radius: 8px; z-index: 4000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* CALEND√ÅRIO CUSTOMIZADO */
        #date-picker-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        #date-picker-modal.show { display: flex; }
        .date-picker-content { 
            background-color: var(--cor-fundo-creme); 
            border-radius: 20px; 
            padding: 25px; 
            max-width: 380px; 
            width: 90%; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.3); 
        }
        .date-picker-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            font-weight: bold;
            font-size: 1.1em;
        }
        .date-picker-month-year {
            color: #1a5f3f; /* Verde escuro */
            font-weight: bold;
        }
        .date-picker-nav { 
            background: none; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            color: #1a5f3f; /* Verde escuro */ 
            padding: 5px 10px;
            border-radius: 8px;
            transition: background-color 0.2s;
            font-weight: bold;
        }
        .date-picker-nav:hover {
            background-color: rgba(26, 95, 63, 0.1);
        }
        .date-picker-calendar { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 4px; 
            margin-bottom: 20px; 
        }
        .date-picker-weekday {
            text-align: center;
            padding: 8px;
            font-size: 0.85em;
            color: #5a9bd4; /* Azul claro/verde-azulado */
            font-weight: bold;
        }
        .date-picker-day { 
            text-align: center; 
            padding: 12px 8px; 
            border-radius: 8px; 
            cursor: pointer; 
            background-color: #fff;
            border: 1px solid transparent;
            transition: all 0.2s;
            font-weight: normal;
            color: #000; /* Preto */
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .date-picker-day:hover { 
            background-color: rgba(90, 155, 212, 0.1);
        }
        .date-picker-day.selected { 
            background-color: #a0a0a0; /* Azul-cinza */
            color: #000;
            font-weight: normal;
            border: 2px solid var(--cor-laranja-forte);
            border-radius: 8px;
        }
        .date-picker-day.in-range {
            background-color: #a0a0a0; /* Azul-cinza */
            color: #000;
        }
        .date-picker-day.range-start {
            background-color: #a0a0a0; /* Azul-cinza */
            color: #000;
            font-weight: normal;
            border: 2px solid var(--cor-laranja-forte);
            border-radius: 8px;
        }
        .date-picker-day.range-end {
            background-color: #a0a0a0; /* Azul-cinza */
            color: #000;
            font-weight: normal;
            border: 2px solid var(--cor-laranja-forte);
            border-radius: 8px;
        }
        .date-picker-day.today {
            background-color: #fff;
            border: 2px solid var(--cor-laranja-forte);
            border-radius: 8px;
        }
        /* C√©lulas vazias (dias de outros meses) */
        .date-picker-empty {
            background-color: transparent;
            border: none;
            min-height: 40px;
        }
        .date-picker-buttons { 
            display: flex; 
            flex-direction: column;
            gap: 10px; 
        }
        .date-picker-buttons-row {
            display: flex;
            gap: 10px;
        }
        .date-picker-btn { 
            flex: 1; 
            padding: 10px; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .date-picker-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            #kanban-board { flex-direction: column; overflow-y: auto; overflow-x: hidden; }
            .kanban-column { 
                width: 100%; 
                min-width: 100%; 
                margin-bottom: 10px; 
                min-height: auto;
            }
            
            header { flex-direction: column; gap: 10px; text-align: center; }
            
            /* Filtros ocultos por padr√£o no mobile */
            #filter-toggle-btn {
                display: block !important;
            }
            
            .filter-bar { 
                flex-direction: column; 
                align-items: stretch;
                display: none; /* Oculto por padr√£o */
            }
            
            .filter-bar.show {
                display: flex; /* Mostra quando tem classe 'show' */
            }
            
            .filter-group-main, .filter-group-additional { 
                flex-direction: column; 
                margin-left: 0; 
                gap: 15px; 
            }
            
            /* Colunas fechadas por padr√£o no mobile */
            .kanban-column:not(.expanded) .column-content {
                display: none !important;
                max-height: 0 !important;
                overflow: hidden;
            }
            
            .kanban-column.expanded .column-content {
                display: block !important;
                max-height: none !important;
                overflow-y: auto;
            }
            
            /* Header clic√°vel no mobile */
            .column-header {
                cursor: pointer;
                user-select: none;
            }
            
            .column-toggle {
                display: inline-block;
            }
            
            /* Ajustes do modal de adicionar itens no mobile */
            #adicionar-itens-modal .modal-content {
                max-width: 95vw !important;
                max-height: 95vh !important;
                padding: 15px !important;
            }
            
            /* Campos "Outros" em coluna no mobile */
            .outros-fields-row {
                flex-direction: column !important;
            }
            
            .outros-field-item,
            .outros-field-valor,
            .outros-field-qtd {
                flex: 1 1 100% !important;
                width: 100% !important;
                margin-bottom: 10px;
            }
            
            /* Itens dispon√≠veis - ajustes para mobile */
            #itens-disponiveis-container {
                overflow-x: hidden;
            }
            
            #itens-lista > div {
                min-width: 100% !important;
            }
            
            /* Linhas de itens dispon√≠veis em coluna no mobile */
            .item-disponivel-row {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 10px !important;
            }
            
            .item-nome {
                width: 100% !important;
                flex: none !important;
            }
            
            .item-valor-input,
            .item-qtd-input {
                width: 100% !important;
                flex: none !important;
            }
            
            .item-add-btn {
                width: 100% !important;
            }
            
            /* Fieldset de adicionar item - responsivo no mobile */
            fieldset > div[style*="display: flex"] {
                flex-direction: column !important;
            }
            
            fieldset > div > div {
                flex: 1 1 100% !important;
                width: 100% !important;
                margin-bottom: 10px;
            }
            
            fieldset button {
                width: 100% !important;
            }
            
            #bulk-actions-bar { width: 90%; flex-wrap: wrap; justify-content: center; bottom: 10px; border-radius: 15px;}
        }
    </style>
</head>
<body>

    <div id="loading-overlay"><div class="spinner"></div><p style="color:#1A2B0F; font-weight:bold; margin-top:10px;">Sincronizando...</p></div>
    <div id="toast">Opera√ß√£o realizada!</div>

    <header>
        <h1>
            <span class="title-line1">Pedidos<br>FAVU COZINHA AFETIVA</span>
        </h1>
        <div id="dashboard-totals">
            <strong>R$ 0,00</strong>
            <span id="total-count">Carregando...</span>
        </div>
    </header>

    <div id="filter-toggle-btn" style="display: none; padding: 10px; background: var(--cor-fundo-creme); border-bottom: 2px solid var(--cor-laranja-forte); text-align: center; cursor: pointer; user-select: none;">
        <span style="font-weight: bold; color: var(--cor-texto);">Filtros</span>
    </div>
    <div class="filter-bar" id="filter-bar">
        <div class="filter-group-main">
        <div class="search-filter">
            <label>Buscar</label>
            <input type="text" id="search-input" placeholder="ID do pedido, nome ou n√∫mero do cliente" oninput="filtrarPedidos()">
        </div>
        <div class="date-filter">
            <label>Data de Entrega</label>
                <input type="hidden" id="date-input" onchange="filtrarPedidos()">
            <input type="hidden" id="date-filter-inicial" value="">
            <input type="text" id="date-filter-display" readonly placeholder="Filtrar por Data" onclick="openDatePicker()" style="background:white; cursor:pointer;">
            </div>
        </div>
        <div class="filter-group-additional">
            <div class="payment-filter">
                <label>Status Pagamento</label>
                <select id="filter-status-pagamento" onchange="filtrarPedidos()">
                    <option value="">Todos</option>
                    <option value="Pagamento pendente">Pagamento pendente</option>
                    <option value="Pago 50%">Pago 50%</option>
                    <option value="Pago 100%">Pago 100%</option>
                </select>
            </div>
            <div class="payment-method-filter">
                <label>Forma Pagamento</label>
                <select id="filter-forma-pagamento" onchange="filtrarPedidos()">
                    <option value="">Todas</option>
                    <option value="Pix">Pix</option>
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Cart√£o">Cart√£o</option>
                </select>
            </div>
            <div class="observation-filter">
                <label>Observa√ß√£o</label>
                <select id="filter-observacao" onchange="filtrarPedidos()">
                    <option value="">Todos</option>
                    <option value="com">Com Observa√ß√£o</option>
                    <option value="sem">Sem Observa√ß√£o</option>
                </select>
            </div>
        </div>
    </div>

    <div id="main-content">
        <div id="kanban-board">
            </div>
    </div>

    <div id="bulk-actions-bar">
        <span id="selected-count" style="color:var(--cor-texto); font-weight:bold;">0 itens</span>
        <button onclick="abrirBulkMove()" style="background-color: var(--cor-fundo-azul);">Etapa</button>
        <button onclick="abrirBulkPayment()" style="background-color: var(--cor-laranja-forte);">Pagamento</button>
        <button onclick="abrirModalResumos()" style="background-color: var(--cor-verde);">Resumos</button>
        <button onclick="limparSelecao()" style="background-color: var(--cor-vermelho); color: white;">Limpar</button>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <h2 style="margin-top:0; color:var(--cor-laranja-forte);">Editar Pedido</h2>
                <span class="close-button" onclick="fecharModal()">&times;</span>
            </div>
            <div id="modal-id-display" style="font-size:0.85em; color:#777; font-weight:normal; margin-top:5px; margin-bottom:10px;"></div>
            
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                
                <label>Nome do Cliente:</label>
                <input type="text" id="edit-nome" required>

                <label>Telefone:</label>
                <input type="text" id="edit-telefone" required>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label>Data Entrega:</label>
                        <input type="date" id="edit-data" required>
                    </div>
                    <div style="flex:1;">
                        <label>Hor√°rio:</label>
                        <input type="time" id="edit-hora" required>
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label>Forma Pagamento:</label>
                        <select id="edit-forma">
                            <option value="Pix">Pix</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cart√£o">Cart√£o</option>
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label>Status Pagamento:</label>
                        <select id="edit-status-pgto">
                            <option value="Pagamento pendente">Pagamento pendente</option>
                            <option value="Pago 50%">Pago 50%</option>
                            <option value="Pago 100%">Pago 100%</option>
                        </select>
                    </div>
                </div>

                <label>Cupom:</label>
                <input type="text" id="edit-cupom">

                <label>Total Final (R$):</label>
                <input type="text" id="edit-total" required>

                <label>Observa√ß√µes:</label>
                <textarea id="edit-obs" rows="3"></textarea>
                
                <!-- Se√ß√£o Adicionar Item ao Pedido -->
                <fieldset style="border: 2px solid var(--cor-laranja-forte); border-radius: 8px; padding: 15px; margin: 15px 0;">
                    <legend style="font-weight: bold; color: var(--cor-laranja-forte); padding: 0 10px;">Adicionar Item ao Pedido</legend>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                        <div style="flex: 2; min-width: 200px;">
                            <label style="font-size:0.9em;">Produto:</label>
                            <select id="add-produto-select" style="width:100%; padding:8px; border:1px solid #5a9bd4; border-radius:8px;" onchange="toggleCamposOutros()">
                                <option value="">Selecione um produto...</option>
                                <option value="__OUTROS__">--- Outros ---</option>
                            </select>
                        </div>
                        <div id="add-nome-outros-container" style="flex: 2; min-width: 200px; display: none;">
                            <label style="font-size:0.9em;">Nome do Item:</label>
                            <input type="text" id="add-nome-outros" placeholder="Nome do item" style="width:100%; padding:8px; border:1px solid #5a9bd4; border-radius:8px;">
                        </div>
                        <div style="flex: 1; min-width: 100px;">
                            <label style="font-size:0.9em;">Quantidade:</label>
                            <input type="number" id="add-qtd" value="1" min="1" style="width:100%; padding:8px; border:1px solid #5a9bd4; border-radius:8px;">
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label style="font-size:0.9em;">Pre√ßo (R$):</label>
                            <input type="text" id="add-preco" placeholder="0,00" style="width:100%; padding:8px; border:1px solid #5a9bd4; border-radius:8px;">
                        </div>
                        <div style="flex: 0 0 auto;">
                            <button type="button" class="btn-save" onclick="adicionarItemAoResumo()" style="padding: 8px 16px; white-space: nowrap;">Adicionar √† Lista</button>
                        </div>
                    </div>
                </fieldset>
                
                <label>Itens do Pedido:</label>
                <textarea id="edit-resumo" rows="4" style="font-size:0.85em;"></textarea>

                <div class="modal-actions" style="justify-content: center;">
                    <button type="button" class="btn-cancel" onclick="fecharModal()">Cancelar</button>
                    <button type="submit" class="btn-save">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="bulk-move-modal" class="modal">
        <div class="modal-content" style="max-width:350px; text-align:center;">
            <h3>Mover para...</h3>
            <select id="bulk-move-select" style="width:100%; padding:10px; margin-bottom:20px;">
                </select>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn-cancel" onclick="document.getElementById('bulk-move-modal').style.display='none'">Cancelar</button>
                <button class="btn-save" onclick="executarBulkMove()">Mover</button>
            </div>
        </div>
    </div>

    <div id="bulk-payment-modal" class="modal">
        <div class="modal-content" style="max-width:350px; text-align:center;">
            <h3>Alterar Pagamento para...</h3>
            <select id="bulk-payment-select" style="width:100%; padding:10px; margin-bottom:20px;">
                <option value="Pagamento pendente">Pagamento pendente</option>
                <option value="Pago 50%">Pago 50%</option>
                <option value="Pago 100%">Pago 100%</option>
            </select>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn-cancel" onclick="document.getElementById('bulk-payment-modal').style.display='none'">Cancelar</button>
                <button class="btn-save" onclick="executarBulkPayment()">Alterar</button>
            </div>
        </div>
    </div>

    <div id="date-picker-modal">
        <div class="date-picker-content">
            <div class="date-picker-header">
                <button class="date-picker-nav" id="prev-month">‚Äπ</button>
                <div class="date-picker-month-year" id="month-year-display"></div>
                <button class="date-picker-nav" id="next-month">‚Ä∫</button>
            </div>
            <div class="date-picker-calendar" id="calendar-grid"></div>
            <div class="date-picker-buttons">
                <div class="date-picker-buttons-row">
                <button class="date-picker-btn" style="background:#A5D6A7; color:white;" onclick="selecionarHoje()">Hoje</button>
                    <button class="date-picker-btn" style="background:var(--cor-fundo-azul); color:white;" onclick="filtrarMesAtual(); closeDatePicker();">M√™s Atual</button>
                </div>
                <div class="date-picker-buttons-row">
                    <button class="date-picker-btn" style="background:#EF9A9A; color:white;" onclick="limparFiltros(); closeDatePicker();">Limpar</button>
                    <button class="date-picker-btn" style="background:var(--cor-verde); color:white;" onclick="aplicarFiltroData(); closeDatePicker();">Filtrar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="whatsapp-confirm-modal" class="modal">
        <div class="modal-content" style="max-width:400px; text-align:center;">
            <span class="close-button" onclick="fecharModalWhatsApp()">&times;</span>
            <h3 id="whatsapp-confirm-title" style="margin-top:0; color:var(--cor-texto);"></h3>
            <p id="whatsapp-confirm-message" style="margin:20px 0;"></p>
            <div class="modal-actions" style="justify-content: center; gap: 10px;">
                <button class="btn-cancel" onclick="fecharModalWhatsApp()">Cancelar</button>
                <button class="btn-save" id="whatsapp-confirm-btn" onclick="confirmarEnvioWhatsApp()">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="resumos-modal" class="modal">
        <div class="modal-content" style="max-width:400px; text-align:center;">
            <span class="close-button" onclick="fecharModalResumos()">&times;</span>
            <h3 style="margin-top:0; color:var(--cor-texto);">Escolha o tipo de resumo</h3>
            <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
                <button class="btn-save" onclick="gerarListaPedidos()" style="width: 100%; padding: 12px;">
                    üìã Lista de pedidos
                </button>
                <button class="btn-save" onclick="gerarResumoItens()" style="width: 100%; padding: 12px; background-color: var(--cor-fundo-azul);">
                    üì¶ Lista de itens
                </button>
            </div>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn-cancel" onclick="fecharModalResumos()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="adicionar-itens-modal" class="modal">
        <div class="modal-content" style="max-width:600px; max-height:90vh; overflow-y:auto;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <h2 style="margin-top:0; color:var(--cor-laranja-forte);">Adicionar Itens</h2>
                <span class="close-button" onclick="fecharModalAdicionarItens()">&times;</span>
            </div>
            
            <!-- Campo "Outros" no topo -->
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;" class="outros-container">
                <h3 style="margin-top:0; font-size:1em; color:var(--cor-texto);">Outros</h3>
                <div class="outros-fields-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <div class="outros-field-item" style="flex: 2;">
                        <label style="font-size:0.9em;">Item:</label>
                        <input type="text" id="outros-item-nome" placeholder="Nome do item" style="width:100%; padding:8px; border:1px solid #5a9bd4; border-radius:8px;">
                    </div>
                    <div class="outros-field-valor" style="flex: 1;">
                        <label style="font-size:0.9em;">Valor (R$):</label>
                        <input type="number" id="outros-item-valor" placeholder="0.00" step="0.01" min="0" style="width:100%; padding:8px; border:1px solid #5a9bd4; border-radius:8px;">
                    </div>
                    <div class="outros-field-qtd" style="flex: 1;">
                        <label style="font-size:0.9em;">Quantidade:</label>
                        <input type="number" id="outros-item-quantidade" placeholder="1" min="1" value="1" style="width:100%; padding:8px; border:1px solid #5a9bd4; border-radius:8px;">
                    </div>
                </div>
                <button type="button" class="btn-save" onclick="adicionarItemOutros()" style="width:100%; padding:8px; font-size:0.9em;">Adicionar Item</button>
            </div>

            <!-- Lista de itens dispon√≠veis -->
            <div id="itens-disponiveis-container">
                <h3 style="margin-top:0; font-size:1em; color:var(--cor-texto);">Itens Dispon√≠veis</h3>
                <div id="itens-lista" style="display:flex; flex-direction:column; gap:15px;">
                    <!-- Itens ser√£o inseridos aqui via JavaScript -->
                </div>
            </div>

            <!-- Resumo dos itens selecionados -->
            <div id="itens-selecionados-resumo" style="margin-top:20px; padding:15px; background:#e8f5e9; border-radius:8px; display:none;">
                <h3 style="margin-top:0; font-size:1em; color:var(--cor-texto);">Itens a Adicionar:</h3>
                <div id="itens-selecionados-lista" style="margin:10px 0;"></div>
                <div style="font-weight:bold; margin-top:10px; padding-top:10px; border-top:1px solid #ccc;">
                    <span>Total: R$ </span><span id="total-itens-selecionados">0,00</span>
                </div>
            </div>

            <div class="modal-actions" style="justify-content: center; margin-top:20px;">
                <button type="button" class="btn-cancel" onclick="fecharModalAdicionarItens()">Cancelar</button>
                <button type="button" class="btn-save" onclick="confirmarAdicionarItens()">Confirmar e Adicionar</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURA√á√ÉO
        // ============================================================================
        const API_URL = "https://script.google.com/macros/s/AKfycbxg41fkz_lDRKUTcnukG-LmuasWR_W6C7QovJo7Vdll58snz9MknU9f5QZ2KWKOOSA/exec";

        // ============================================================================
        // CAT√ÅLOGO DE PRODUTOS
        // ============================================================================
        // ============================================================================
        // CAT√ÅLOGO DE PRE√áOS
        // ============================================================================
        const CATALOGO_PRECOS = {
            // --- BOLOS TRADICIONAIS ---
            'Bolo de Bem-Casado - P (1.5 KG)': 100.00,
            'Bolo de Bem-Casado - M (2.5 KG)': 160.00,
            'Bolo de Bem-Casado - G (3.5 KG)': 220.00,
            'Bolo de Doce de Leite - P (1.5 KG)': 90.00,
            'Bolo de Doce de Leite - M (2.5 KG)': 150.00,
            'Bolo de Doce de Leite - G (3.5 KG)': 210.00,
            'Bolo de Chocolate - P (1.5 KG)': 90.00,
            'Bolo de Chocolate - M (2.5 KG)': 150.00,
            'Bolo de Chocolate - G (3.5 KG)': 210.00,
            'Bolo de Lim√£o - P (1.5 KG)': 90.00,
            'Bolo de Lim√£o - M (2.5 KG)': 150.00,
            'Bolo de Lim√£o - G (3.5 KG)': 210.00,
            'Bolo de Maracuj√° - P (1.5 KG)': 90.00,
            'Bolo de Maracuj√° - M (2.5 KG)': 150.00,
            'Bolo de Maracuj√° - G (3.5 KG)': 210.00,

            // --- BOLOS ESPECIAIS ---
            'üéÑCheesecake tradicional - 2.1 KG': 150.00,
            'üéÑCheesecake Doce de leite - 2.1 KG': 155.00,
            'Bolo de Ameixa - P (1.5 KG)': 110.00,
            'Bolo de Ameixa - M (2.5 KG)': 180.00,
            'Bolo de Ameixa - G (3.5 KG)': 250.00,
            'Bolo de Caf√© e Doce de Leite - P (1.5 KG)': 110.00,
            'Bolo de Caf√© e Doce de Leite - M (2.5 KG)': 180.00,
            'Bolo de Caf√© e Doce de Leite - G (3.5 KG)': 250.00,
            'Bolo de Chocolate 50% - P (1.5 KG)': 110.00,
            'Bolo de Chocolate 50% - M (2.5 KG)': 175.00,
            'Bolo de Chocolate 50% - G (3.5 KG)': 245.00,
            'Bolo de Delicia de Abacaxi - P (1.5 KG)': 105.00,
            'Bolo de Delicia de Abacaxi - M (2.5 KG)': 175.00,
            'Bolo de Delicia de Abacaxi - G (3.5 KG)': 245.00,
            'Bolo de Morango - P (1.5 KG)': 110.00,
            'Bolo de Morango - M (2.5 KG)': 175.00,
            'Bolo de Morango - G (3.5 KG)': 245.00,
            'Bolo de Ninho trufado - P (1.5 KG)': 110.00,
            'Bolo de Ninho trufado - M (2.5 KG)': 175.00,
            'Bolo de Ninho trufado - G (3.5 KG)': 245.00,
            'üéÑBolo de Noiva - P (1.5 KG)': 145.00,
            'üéÑBolo de Noiva - M (2.5 KG)': 240.00,
            'üéÑBolo de Noiva - G (3.5 KG)': 335.00,
            'Bolo Prest√≠gio - P (1.5 KG)': 105.00,
            'Bolo Prest√≠gio - M (2.5 KG)': 175.00,
            'Bolo Prest√≠gio - G (3.5 KG)': 245.00,
            'Bolo Red velvet - P (1.5 KG)': 105.00,
            'Bolo Red velvet - M (2.5 KG)': 175.00,
            'Bolo Red velvet - G (3.5 KG)': 245.00,

            // --- DOCES ---
            'Beijinho': 1.20,
            'Bem-casado': 1.20,
            'Brigadeiro': 1.20,
            'Mini Cookie Black': 2.80,
            'Mini Cookie Red Velvet': 2.80,
            'Mini Cookie Tradicional': 2.80,
            'Mini Tortilete': 1.30,
            'Moranguinho': 1.20,
            'Ouri√ßo': 1.30,
            'Queijadinha': 1.30,
            'Surpresa de uva': 1.30,

            // --- COOKIES ---
            'Cookie Tradicional *': 12.00,
            'Cookie Red Velvet *': 12.00,
            'Cookie Black *': 12.00,

            // --- SALGADOS FRITOS ---
            'Bolinho de Bacalhau': 1.30,
            'Bolinho de Charque': 1.20,
            'Coxinha de Frango': 1.00,
            'Croquete Misto': 1.00,
            'Camar√£o Empanado': 1.50,
            'Mini Quibe': 1.10,
            'Pastel de Festa': 1.30,

            // --- SALGADOS FORNO ---
            'Canudinho de Frango': 1.50,
            'Empadinha de Bacalhau': 1.30,
            'Empadinha de Camar√£o': 1.30,
            'Empadinha de Carne': 1.00,
            'Empadinha de Frango': 1.00,
            'Mini Folhado de Carne': 2.20,
            'Mini Folhado de Frango': 2.20,
            'Mini Folhado de Queijo': 2.20,
            'Mini Folhado de Pizza': 2.20,
            'Mini Enroladinho': 1.00,
            'Pastel de Forno de Bacalhau': 1.30,
            'Pastel de Forno de Camar√£o': 1.40,
            'Pastel de Forno de Carne': 1.00,
            'Pastel de Forno de Frango': 1.00,
            'Pastel de Forno de Queijo': 1.00,
            'Pastel de Forno de Pizza': 1.00,

            // --- SALGADOS VEGETARIANOS ---
            'Canudinho de Soja': 1.50,
            'Coxinha de Soja': 1.00,
            'Coxinha de Caju *': 1.20,
            'Empadinha de Creme de Aborbinha': 1.00,
            'Empadinha de Falso Camar√£o': 1.00,
            'Pastel de Festa Vegetariano': 1.30,
            'Pastel de Forno Creme de Abobrinha': 1.00,
            'Pastel de Forno Caju *': 1.30,

            // --- PRATOS SALGADOS ---
            'Empad√£o de Bacalhau - P (1 KG)': 120.00,
            'Empad√£o de Bacalhau - M (2 KG)': 220.00,
            'Empad√£o de Bacalhau - G (3 KG)': 340.00,
            'Empad√£o de Carne - P (1 KG)': 70.00,
            'Empad√£o de Carne - M (2 KG)': 140.00,
            'Empad√£o de Carne - G (3 KG)': 210.00,
            'Empad√£o de Camar√£o - P (1 KG)': 120.00,
            'Empad√£o de Camar√£o - M (2 KG)': 220.00,
            'Empad√£o de Camar√£o - G (3 KG)': 340.00,
            'Empad√£o de Frango - P (1 KG)': 70.00,
            'Empad√£o de Frango - M (2 KG)': 140.00,
            'Empad√£o de Frango - G (3 KG)': 210.00,
            'Fricass√™ de Frango - P (1 KG)': 80.00,
            'Fricass√™ de Frango - M (2 KG)': 160.00,
            'Fricass√™ de Frango - G (3 KG)': 240.00,
            'Quiche de Camar√£o - P (1 KG)': 120.00,
            'Quiche de Camar√£o - M (2 KG)': 240.00,
            'Quiche de Camar√£o - G (3 KG)': 360.00,
            'Quiche de Frango - P (1 KG)': 90.00,
            'Quiche de Frango - M (2 KG)': 180.00,
            'Quiche de Frango - G (3 KG)': 260.00,
            'Rocambole de Bacalhau - P (1 KG)': 120.00,
            'Rocambole de Bacalhau - M (2 KG)': 240.00,
            'Rocambole de Bacalhau - G (3 KG)': 360.00,
            'Rocambole de Camar√£o - P (1 KG)': 120.00,
            'Rocambole de Camar√£o - M (2 KG)': 240.00,
            'Rocambole de Camar√£o - G (3 KG)': 365.00,
            'Rocambole de Carne - P (1 KG)': 70.00,
            'Rocambole de Carne - M (2 KG)': 140.00,
            'Rocambole de Carne - G (3 KG)': 210.00,
            'Rocambole de Frango - P (1 KG)': 70.00,
            'Rocambole de Frango - M (2 KG)': 140.00,
            'Rocambole de Frango - G (3 KG)': 210.00,
            'üéÑSalpic√£o de Frango - P (1 KG)': 80.00,
            'üéÑSalpic√£o de Frango - M (2 KG)': 160.00,
            'üéÑSalpic√£o de Frango - G (3 KG)': 240.00,
            'Torta Salgada de Bacalhau - P (1 KG)': 120.00,
            'Torta Salgada de Bacalhau - M (2 KG)': 240.00,
            'Torta Salgada de Bacalhau - G (3 KG)': 360.00,
            'Torta Salgada de Carne - P (1 KG)': 70.00,
            'Torta Salgada de Carne - M (2 KG)': 140.00,
            'Torta Salgada de Carne - G (3 KG)': 210.00,
            'Torta Salgada de Camar√£o - P (1 KG)': 120.00,
            'Torta Salgada de Camar√£o - M (2 KG)': 240.00,
            'Torta Salgada de Camar√£o - G (3 KG)': 360.00,
            'Torta Salgada de Frango - P (1 KG)': 70.00,
            'Torta Salgada de Frango - M (2 KG)': 140.00,
            'Torta Salgada de Frango - G (3 KG)': 210.00
        };

        const CATALOGO_PRODUTOS = {
            'Bolos Tradicionais': [
                'Bolo de Bem-Casado',
                'Bolo de Doce de Leite',
                'Bolo de Chocolate',
                'Bolo de Lim√£o',
                'Bolo de Maracuj√°'
            ],
            'Bolos Especiais': [
                'Cheesecake tradicional',
                'Cheesecake Doce de leite',
                'Bolo de Ameixa',
                'Bolo de Caf√© e Doce de Leite',
                'Bolo de Chocolate 50%',
                'Bolo de Delicia de Abacaxi',
                'Bolo de Morango',
                'Bolo de Ninho trufado',
                'Bolo de Noiva',
                'Bolo Prest√≠gio',
                'Bolo Red velvet'
            ],
            'Doces': [
                'Beijinho',
                'Bem-casado',
                'Brigadeiro',
                'Mini Cookie Black',
                'Mini Cookie Red Velvet',
                'Mini Cookie Tradicional',
                'Mini Tortilete',
                'Moranguinho',
                'Ouri√ßo',
                'Queijadinha',
                'Surpresa de uva'
            ],
            'Cookies': [
                'Cookie Tradicional',
                'Cookie Red Velvet',
                'Cookie Black'
            ],
            'Salgados Fritos': [
                'Bolinho de Bacalhau',
                'Bolinho de Charque',
                'Coxinha de Frango',
                'Croquete Misto',
                'Camar√£o Empanado',
                'Mini Quibe',
                'Pastel de Festa'
            ],
            'Salgados Assados': [
                'Canudinho de Frango',
                'Empadinha de Bacalhau',
                'Empadinha de Camar√£o',
                'Empadinha de Carne',
                'Empadinha de Frango',
                'Mini Folhado de Carne',
                'Mini Folhado de Frango',
                'Mini Folhado de Queijo',
                'Mini Folhado de Pizza',
                'Mini Enroladinho',
                'Pastel de Forno de Bacalhau',
                'Pastel de Forno de Camar√£o',
                'Pastel de Forno de Carne',
                'Pastel de Forno de Frango',
                'Pastel de Forno de Queijo',
                'Pastel de Forno de Pizza'
            ],
            'Salgados Vegetarianos': [
                'Canudinho de Soja',
                'Coxinha de Soja',
                'Coxinha de Caju',
                'Empadinha de Creme de Aborbinha',
                'Empadinha de Falso Camar√£o',
                'Pastel de Festa Vegetariano',
                'Pastel de Forno Creme de Abobrinha',
                'Pastel de Forno Caju'
            ],
            'Pratos Salgados': [
                'Empad√£o de Bacalhau',
                'Empad√£o de Carne',
                'Empad√£o de Camar√£o',
                'Empad√£o de Frango',
                'Fricass√™ de Frango',
                'Quiche de Camar√£o',
                'Quiche de Frango',
                'Rocambole de Bacalhau',
                'Rocambole de Camar√£o',
                'Rocambole de Carne',
                'Rocambole de Frango',
                'Salpic√£o de Frango',
                'Torta Salgada de Bacalhau',
                'Torta Salgada de Carne',
                'Torta Salgada de Camar√£o',
                'Torta Salgada de Frango'
            ]
        };

        // Fun√ß√£o auxiliar para buscar categoria de um item no cat√°logo
        function buscarCategoriaNoCatalogo(nomeItem) {
            // Remove quantidade e formata√ß√£o do nome para busca
            let nomeLimpo = nomeItem
                .replace(/^\d+\s*un\.\s*-\s*/i, '') // Remove "X un. - "
                .replace(/\s*-\s*\([^)]*\)\s*=?\s*/g, '') // Remove "- (qualquer coisa) ="
                .replace(/\s*-\s*\([^)]*$/g, '') // Remove "- (" e tudo depois
                .trim();
            
            // Busca o item no cat√°logo
            for (const [categoria, produtos] of Object.entries(CATALOGO_PRODUTOS)) {
                if (produtos.some(produto => {
                    // Compara√ß√£o case-insensitive e permite varia√ß√µes
                    const produtoLower = produto.toLowerCase().trim();
                    const nomeLower = nomeLimpo.toLowerCase().trim();
                    return nomeLower.includes(produtoLower) || produtoLower.includes(nomeLower);
                })) {
                    return categoria;
                }
            }
            return null;
        }

        const STATUS_FLOW = [
            'Pedido Recebido',
            'Pedido Confirmado',
            'Aguardando Retirada',
            'Entregue',
            'Cancelado'
        ];

        let todosPedidos = [];
        let ticketsSelecionados = new Set();
        let isDragEnabled = window.innerWidth > 768; // Desabilita drag no mobile
        let currentCalendarDate = new Date();
        let dataInicialIntervalo = null;
        let dataFinalIntervalo = null;

        // ============================================================================
        // FUN√á√ïES AUXILIARES DE DATA
        // ============================================================================
        /**
         * Converte data no formato brasileiro "DD/MM/AAAA" para objeto Date
         * com horas zeradas (00:00:00)
         */
        function parseDataBR(dataString) {
            if (!dataString || typeof dataString !== 'string') return null;
            
            const partes = dataString.trim().split('/');
            if (partes.length !== 3) return null;
            
            const dia = parseInt(partes[0], 10);
            const mes = parseInt(partes[1], 10) - 1; // M√™s √© 0-indexed
            const ano = parseInt(partes[2], 10);
            
            if (isNaN(dia) || isNaN(mes) || isNaN(ano)) return null;
            
            const data = new Date(ano, mes, dia);
            data.setHours(0, 0, 0, 0);
            return data;
        }

        /**
         * Converte data no formato ISO "YYYY-MM-DD" para objeto Date
         * com horas zeradas (00:00:00)
         */
        function parseDataISO(dataString) {
            if (!dataString || typeof dataString !== 'string') return null;
            
            const partes = dataString.trim().split('-');
            if (partes.length !== 3) return null;
            
            const ano = parseInt(partes[0], 10);
            const mes = parseInt(partes[1], 10) - 1; // M√™s √© 0-indexed
            const dia = parseInt(partes[2], 10);
            
            if (isNaN(dia) || isNaN(mes) || isNaN(ano)) return null;
            
            const data = new Date(ano, mes, dia);
            data.setHours(0, 0, 0, 0);
            return data;
        }

        // ============================================================================
        // INICIALIZA√á√ÉO
        // ============================================================================
        document.addEventListener("DOMContentLoaded", () => {
            inicializarKanban();
            carregarPedidos();
            renderCalendar(); 
            // Auto-refresh a cada 30 segundos
            setInterval(carregarPedidos, 30000);
            
            // Fecha o calend√°rio ao clicar fora
            const modal = document.getElementById('date-picker-modal');
            if (modal) {
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        closeDatePicker();
                    }
                });
            }
            
            // Toggle de filtros no mobile
            const filterToggleBtn = document.getElementById('filter-toggle-btn');
            const filterBar = document.getElementById('filter-bar');
            if (filterToggleBtn && filterBar) {
                filterToggleBtn.addEventListener('click', () => {
                    filterBar.classList.toggle('show');
                });
            }
            
            // Configura comportamento de acorde√£o para colunas no mobile
            configurarAcordeaoColunas();
            
            // Reconfigura ao redimensionar a janela
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    configurarAcordeaoColunas();
                    // Se voltar para desktop, remove classe expanded de todas
                    if (window.innerWidth > 768) {
                        document.querySelectorAll('.kanban-column').forEach(col => {
                            col.classList.remove('expanded');
                        });
                    }
                }, 250);
            });

        });
        
        // Fun√ß√£o para configurar comportamento de acorde√£o nas colunas
        function configurarAcordeaoColunas() {
            // Remove listeners antigos para evitar duplica√ß√£o
            document.querySelectorAll('.column-header').forEach(header => {
                const newHeader = header.cloneNode(true);
                header.parentNode.replaceChild(newHeader, header);
            });
            
            // Adiciona novos listeners
            if (window.innerWidth <= 768) {
                document.querySelectorAll('.column-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        // N√£o aciona se clicar no checkbox
                        if (e.target.type === 'checkbox' || e.target.closest('.column-select-all-checkbox')) return;
                        
                        const column = header.closest('.kanban-column');
                        if (!column) return;
                        
                        // Fecha todas as outras colunas
                        document.querySelectorAll('.kanban-column').forEach(col => {
                            if (col !== column) {
                                col.classList.remove('expanded');
                            }
                        });
                        
                        // Toggle da coluna clicada
                        column.classList.toggle('expanded');
                    });
                });
            }
        }

        function inicializarKanban() {
            const board = document.getElementById('kanban-board');
            const bulkSelect = document.getElementById('bulk-move-select');
            
            STATUS_FLOW.forEach(status => {
                // Cria coluna
                const col = document.createElement('div');
                col.className = 'kanban-column';
                col.dataset.status = status;
                col.innerHTML = `
                    <div class="column-header">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <input type="checkbox" class="column-select-all-checkbox" onclick="toggleSelectColumn(this, '${status}')">
                            <span>${status} (<span class="count-badge">0</span>)</span>
                        </div>
                    </div>
                    <div class="column-content" id="col-${limparString(status)}" 
                         ondrop="drop(event)" ondragover="allowDrop(event)">
                    </div>
                `;
                board.appendChild(col);

                // Preenche select de mover em massa
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                bulkSelect.appendChild(option);
            });
        }

        function limparString(str) {
            return str.replace(/[^a-zA-Z0-9]/g, '');
        }

        // ============================================================================
        // CARREGAMENTO DE DADOS
        // ============================================================================
        async function carregarPedidos() {
            if(document.getElementById('edit-modal').style.display === 'flex') return;

            try {
                const response = await fetch(`${API_URL}?action=read`);
                const data = await response.json();

                if (data.success) {
                    todosPedidos = data.pedidos;
                    filtrarPedidos();
                    // Dashboard j√° √© atualizado em filtrarPedidos()
                } else {
                    console.error("Erro API:", data.message);
                }
            } catch (erro) {
                console.error("Erro de conex√£o:", erro);
            }
        }

        /**
         * Fun√ß√£o auxiliar para converter hor√°rio HH:MM em minutos para compara√ß√£o
         */
        function parseHorario(horarioStr) {
            if (!horarioStr || typeof horarioStr !== 'string') return 0;
            
            const partes = horarioStr.trim().split(':');
            if (partes.length !== 2) return 0;
            
            const horas = parseInt(partes[0], 10);
            const minutos = parseInt(partes[1], 10);
            
            if (isNaN(horas) || isNaN(minutos)) return 0;
            
            return horas * 60 + minutos; // Retorna total de minutos
        }

        /**
         * Fun√ß√£o de ordena√ß√£o: ordena pedidos por data e hor√°rio de entrega
         */
        function ordenarPedidosPorDataHorario(pedidos) {
            return pedidos.sort((a, b) => {
                // Primeiro compara por data de entrega
                const dataA = parseDataBR(a.Data_Entrega);
                const dataB = parseDataBR(b.Data_Entrega);
                
                // Se n√£o h√° data, coloca no final
                if (!dataA && !dataB) return 0;
                if (!dataA) return 1;
                if (!dataB) return -1;
                
                // Compara datas usando getTime()
                const diffData = dataA.getTime() - dataB.getTime();
                
                // Se as datas s√£o diferentes, retorna a diferen√ßa
                if (diffData !== 0) return diffData;
                
                // Se as datas s√£o iguais, compara por hor√°rio
                const horarioA = parseHorario(a.Horario_Entrega);
                const horarioB = parseHorario(b.Horario_Entrega);
                
                return horarioA - horarioB;
            });
        }

        function renderizar(pedidosParaExibir) {
            // Limpa colunas
            document.querySelectorAll('.column-content').forEach(el => el.innerHTML = '');
            const contadores = {};
            STATUS_FLOW.forEach(s => contadores[s] = 0);

            // Agrupa pedidos por status
            const pedidosPorStatus = {};
            STATUS_FLOW.forEach(status => {
                pedidosPorStatus[status] = [];
            });

            // Agrupa os pedidos por status
            pedidosParaExibir.forEach(pedido => {
                const status = pedido.Status_do_Pedido || 'Pedido Recebido';
                let statusNormalizado = STATUS_FLOW.find(s => s.toLowerCase() === status.toLowerCase()) || 'Pedido Recebido';
                
                if (!pedidosPorStatus[statusNormalizado]) {
                    pedidosPorStatus[statusNormalizado] = [];
                }
                pedidosPorStatus[statusNormalizado].push(pedido);
            });

            // Ordena e renderiza os pedidos de cada status
            STATUS_FLOW.forEach(status => {
                const pedidosDoStatus = pedidosPorStatus[status] || [];
                
                // Ordena os pedidos por data e hor√°rio de entrega
                const pedidosOrdenados = ordenarPedidosPorDataHorario([...pedidosDoStatus]);
                
                const colId = `col-${limparString(status)}`;
                const coluna = document.getElementById(colId);

                if (coluna) {
                    pedidosOrdenados.forEach(pedido => {
                    const card = criarCardHTML(pedido);
                    coluna.appendChild(card);
                        contadores[status]++;
                    });
                }
            });

            STATUS_FLOW.forEach(status => {
                const col = document.querySelector(`.kanban-column[data-status="${status}"]`);
                if(col) col.querySelector('.count-badge').textContent = contadores[status];
            });

            // No mobile, inicia todas as colunas fechadas
            if (window.innerWidth <= 768) {
                document.querySelectorAll('.kanban-column').forEach(col => {
                    col.classList.remove('expanded');
                });
            }

            // Reconfigura acorde√£o ap√≥s renderiza√ß√£o
            configurarAcordeaoColunas();

            // Atualiza dashboard com l√≥gica: selecionados OU per√≠odo
            atualizarDashboard();
        }

        // Fun√ß√£o para obter pedidos do m√™s vigente (usado apenas quando n√£o h√° filtros)
        function obterPedidosDoMesAtual() {
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                
                return todosPedidos.filter(p => {
                const dataPed = parseDataBR(p.Data_Entrega);
                if (!dataPed) return false;
                
                return dataPed.getMonth() === mesAtual && dataPed.getFullYear() === anoAtual;
            });
        }

        // Fun√ß√£o helper para converter string de valor para n√∫mero
        function converterValorParaNumero(valorStr) {
            if (!valorStr) return 0;
            
            let valor = String(valorStr);
            valor = valor.replace(/R\$/gi, '').trim();
            
            const temVirgula = valor.includes(',');
            const temPonto = valor.includes('.');
            
            if (temVirgula) {
                valor = valor.replace(/\./g, '');
                valor = valor.replace(',', '.');
            } else if (temPonto) {
                // Mant√©m ponto como decimal
            } else {
                valor = valor.replace(/\D/g, '');
            }
            
            const num = parseFloat(valor);
            return isNaN(num) ? 0 : num;
        }

        // Fun√ß√£o helper para formatar valor com 2 casas decimais (formato brasileiro)
        function formatarValorComCentavos(valor) {
            if (!valor) return '0,00';
            
            // Converte para n√∫mero
            const valorNum = converterValorParaNumero(valor);
            
            // Formata com 2 casas decimais e v√≠rgula
            return valorNum.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Fun√ß√£o helper para calcular valor de um pedido
        // Converte string monet√°ria brasileira (ex: 'R$ 2.530,50') para float
        function calcularValorPedido(pedido) {
            if (!pedido || !pedido.Total_Final) return 0;
            let valor = String(pedido.Total_Final).trim();
            
            if (valor.includes(',')) {
                valor = valor.replace(/\./g, '').replace(',', '.');
            } 
            
            valor = valor.replace(/[^\d.]/g, '');
            return parseFloat(valor) || 0;
        }

        // Fun√ß√£o para obter pedidos filtrados (considera busca, data/intervalo, status pagamento, forma pagamento e observa√ß√£o)
        function obterPedidosFiltrados() {
            const texto = document.getElementById('search-input').value.trim().toLowerCase();
            const dataFiltro = document.getElementById('date-input').value; // YYYY-MM-DD ou YYYY-MM-DD,YYYY-MM-DD
            const statusPagamento = document.getElementById('filter-status-pagamento').value;
            const formaPagamento = document.getElementById('filter-forma-pagamento').value;
            const filtroObservacao = document.getElementById('filter-observacao').value;

            return todosPedidos.filter(p => {
                // Filtro de texto
                if (texto) {
                    const matchTexto = 
                        (p.Nome_Cliente || '').toLowerCase().includes(texto) ||
                        (p.ID_do_Pedido || '').toLowerCase().includes(texto) ||
                        (p.Numero || '').includes(texto);
                    
                    if (!matchTexto) return false;
                }
                
                // Filtro de data/intervalo
                if (dataFiltro && dataFiltro.trim() !== '') {
                    const dataPed = parseDataBR(p.Data_Entrega);
                    if (!dataPed) return false;
                    
                    if (dataFiltro.includes(',')) {
                        // Intervalo de datas
                        const [dataInicioStr, dataFimStr] = dataFiltro.split(',');
                        const dataInicio = parseDataISO(dataInicioStr.trim());
                        const dataFim = parseDataISO(dataFimStr.trim());
                        
                        if (!dataInicio || !dataFim) return false;
                        
                        // Compara√ß√£o usando getTime() (inclusivo: >= inicio e <= fim)
                        if (!(dataPed.getTime() >= dataInicio.getTime() && dataPed.getTime() <= dataFim.getTime())) {
                            return false;
                        }
                    } else {
                        // Data √∫nica
                        const dataFiltroObj = parseDataISO(dataFiltro.trim());
                        if (!dataFiltroObj) return false;
                        
                        // Compara√ß√£o usando getTime()
                        if (dataPed.getTime() !== dataFiltroObj.getTime()) {
                            return false;
                        }
                    }
                }
                
                // Filtro de Status de Pagamento
                if (statusPagamento && statusPagamento.trim() !== '') {
                    const statusPed = (p.Status_Pagamento || 'Pagamento pendente').trim();
                    if (statusPed !== statusPagamento) {
                        return false;
                    }
                }
                
                // Filtro de Forma de Pagamento
                if (formaPagamento && formaPagamento.trim() !== '') {
                    const formaPed = (p.Forma_de_Pagamento || '').trim();
                    if (formaPed !== formaPagamento) {
                        return false;
                    }
                }
                
                // Filtro de Observa√ß√£o
                if (filtroObservacao && filtroObservacao.trim() !== '') {
                    const temObs = p.Observacoes && p.Observacoes.trim() !== '';
                    if (filtroObservacao === 'com' && !temObs) {
                        return false;
                    }
                    if (filtroObservacao === 'sem' && temObs) {
                        return false;
                    }
                }
                
                return true;
            });
        }

        // Atualiza o dashboard com os totais baseados nos pedidos vis√≠veis ap√≥s o filtro
        // EXCLUI pedidos CANCELADOS do valor financeiro, mas inclui na contagem
        function atualizarDashboard() {
            let pedidosParaCalcular = [];
            let totalValor = 0;
            let totalPedidos = 0;

            const texto = document.getElementById('search-input').value.trim();
            const dataFiltro = document.getElementById('date-input').value;

            // Prioridade 1: Se h√° pedidos selecionados manualmente (via checkbox)
            if (ticketsSelecionados.size > 0) {
                pedidosParaCalcular = todosPedidos.filter(p => ticketsSelecionados.has(p.ID_do_Pedido));
            } else {
                // Prioridade 2: Usa a mesma l√≥gica de filtrarPedidos para obter os pedidos vis√≠veis
                // Se o campo de busca tiver texto OU o campo de data tiver valor: busca em todo hist√≥rico
                // Se ambos estiverem vazios: usa o m√™s vigente
                if (texto || (dataFiltro && dataFiltro.trim() !== '')) {
                    pedidosParaCalcular = obterPedidosFiltrados();
                } else {
                    // Se n√£o h√° filtros nem sele√ß√£o, usa o m√™s vigente (padr√£o)
                    pedidosParaCalcular = obterPedidosDoMesAtual();
                }
            }

            // Calcula total e contagem baseado nos pedidos vis√≠veis
            pedidosParaCalcular.forEach(pedido => {
                const status = pedido.Status_do_Pedido || 'Pedido Recebido';
                const statusLower = (status || '').toLowerCase();
                
                // Contagem: inclui todos os pedidos vis√≠veis (incluindo cancelados)
                    totalPedidos++;
                
                // Valor financeiro: EXCLUI pedidos onde Status_do_Pedido cont√©m "Cancelado" (case insensitive)
                if (!statusLower.includes('cancelado')) {
                    totalValor += calcularValorPedido(pedido);
                }
            });

            // Atualiza o dashboard com os valores calculados
            document.querySelector('#dashboard-totals strong').textContent = 
                totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('total-count').textContent = 
                `${totalPedidos} pedido${totalPedidos !== 1 ? 's' : ''}`;
        }

        function criarCardHTML(pedido) {
            const card = document.createElement('div');
            const sanitizedStatus = (pedido.Status_do_Pedido || '').replace(/\s+/g, '-');
            const temObs = pedido.Observacoes && pedido.Observacoes.trim() !== '';
            
            card.className = `pedido-card status-${sanitizedStatus} ${temObs ? 'com-observacao' : ''} ${ticketsSelecionados.has(pedido.ID_do_Pedido) ? 'selected' : ''}`;
            if(isDragEnabled) card.draggable = true;
            card.id = `card-${pedido.ID_do_Pedido}`;
            card.dataset.id = pedido.ID_do_Pedido;
            
            if(isDragEnabled) card.addEventListener('dragstart', drag);
            card.addEventListener('click', (e) => {
                // Se clicar no select ou checkbox, n√£o abre modal
                if(e.target.tagName !== 'SELECT' && e.target.type !== 'checkbox') {
                    abrirModalEdicao(pedido.ID_do_Pedido);
                }
            });

            // Estilo do select de pagamento
            const pgStatus = (pedido.Status_Pagamento || 'Pagamento pendente').toLowerCase();
            let pgClass = 'pg-pendente';
            if(pgStatus.includes('50%')) pgClass = 'pg-parcial';
            if(pgStatus.includes('100%') || pgStatus === 'pago') pgClass = 'pg-pago';

            // Determina o tipo de pagamento para a tag
            const formaPagamento = (pedido.Forma_de_Pagamento || '').trim();
            let tipoPagamentoTag = '';
            let tipoPagamentoClasse = '';
            if (formaPagamento) {
                const formaNormalizada = formaPagamento.toLowerCase();
                if (formaNormalizada.includes('pix')) {
                    tipoPagamentoTag = 'PIX';
                    tipoPagamentoClasse = 'pix';
                } else if (formaNormalizada.includes('dinheiro')) {
                    tipoPagamentoTag = 'DINHEIRO';
                    tipoPagamentoClasse = 'dinheiro';
                } else if (formaNormalizada.includes('cart√£o') || formaNormalizada.includes('cartao')) {
                    tipoPagamentoTag = 'CART√ÉO';
                    tipoPagamentoClasse = 'cartao';
                } else {
                    tipoPagamentoTag = formaPagamento.toUpperCase();
                    tipoPagamentoClasse = formaNormalizada.replace(/[^a-z0-9]/g, '');
                }
            }

            // HTML DO CARD IGUAL A IMAGEM
            card.innerHTML = `
                <div class="card-header">
                    <input type="checkbox" class="card-checkbox" 
                           ${ticketsSelecionados.has(pedido.ID_do_Pedido) ? 'checked' : ''}
                           onclick="toggleSelecao('${pedido.ID_do_Pedido}', this); event.stopPropagation();">
                    <div style="text-align: right;">
                        <div>
                            <span class="card-id">${pedido.ID_do_Pedido}</span>
                        </div>
                        ${temObs ? '<div><span class="observacao-tag">OBSERVA√á√ÉO</span></div>' : ''}
                    </div>
                </div>
                <br>
                <div class="card-title">${pedido.Nome_Cliente}</div>

                <div class="card-info-box">
                    <div class="card-info-row">
                        <span class="card-icon">üóìÔ∏è</span> ${pedido.Data_Entrega || '--/--/----'}
                    </div>
                    <div class="card-info-row">
                        <span class="card-icon">‚è∞</span> ${pedido.Horario_Entrega || '--:--'}
                    </div>
                    <div class="card-info-row">
                        <span class="card-icon">üì±</span> 
                        <button class="card-numero-btn" onclick="abrirModalWhatsApp('${pedido.ID_do_Pedido}'); event.stopPropagation();">
                            ${pedido.Numero || 'N/A'}
                        </button>
                    </div>
                </div>
                
                ${pedido.Cupom ? `
                <div class="card-cupom">
                    <span class="card-cupom-label">Cupom:</span> ${pedido.Cupom}
                    ${(() => {
                        const valores = calcularValoresComCupom(pedido);
                        if (valores.desconto > 0) {
                            return ` - Desconto: R$ ${valores.desconto.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                        }
                        return '';
                    })()}
                </div>
                ` : ''}
                
                <div class="card-price">
                    <span>Total do valor: ${formatarValorComCentavos(pedido.Total_Final)}</span>
                    ${tipoPagamentoTag ? `<span class="payment-type-tag ${tipoPagamentoClasse}">${tipoPagamentoTag}</span>` : ''}
                </div>

                <div class="card-status-pagamento">
                    <select class="${pgClass}" onchange="atualizarStatusPagamentoDireto('${pedido.ID_do_Pedido}', this)">
                        <option value="Pagamento pendente" ${pgStatus === 'pendente' || pgStatus === 'pagamento pendente' ? 'selected' : ''}>Pagamento pendente</option>
                        <option value="Pago 50%" ${pgStatus.includes('50') ? 'selected' : ''}>Pago 50%</option>
                        <option value="Pago 100%" ${pgStatus.includes('100') || pgStatus === 'pago' ? 'selected' : ''}>Pago 100%</option>
                    </select>
                </div>
            `;
            return card;
        }

        // ============================================================================
        // L√ìGICA DE FILTROS & CALEND√ÅRIO
        // ============================================================================
        
        // Fun√ß√£o principal de filtro que filtra os pedidos baseado em texto, data, status pagamento, forma pagamento e observa√ß√£o
        function filtrarPedidos() {
            const texto = document.getElementById('search-input').value.trim();
            const dataFiltro = document.getElementById('date-input').value; // YYYY-MM-DD ou YYYY-MM-DD,YYYY-MM-DD
            const statusPagamento = document.getElementById('filter-status-pagamento').value;
            const formaPagamento = document.getElementById('filter-forma-pagamento').value;
            const filtroObservacao = document.getElementById('filter-observacao').value;
            
            // ============================================================================
            // 1. DEFINI√á√ÉO DO ESCOPO (BASE DE DADOS)
            // ============================================================================
            // Verifica se h√° texto na busca OU se h√° data selecionada
            // Se houver: escopo = todosPedidos (todo o hist√≥rico)
            // Se N√ÉO houver: escopo = pedidos do m√™s e ano correntes
            let escopoInicial = [];
            
            if (texto || (dataFiltro && dataFiltro.trim() !== '')) {
                // H√° texto ou data: busca em todo o hist√≥rico
                escopoInicial = todosPedidos;
            } else {
                // N√£o h√° texto nem data: usa apenas pedidos do m√™s atual
                escopoInicial = obterPedidosDoMesAtual();
            }
            
            // ============================================================================
            // 2. APLICA√á√ÉO DOS FILTROS (CASCATA)
            // ============================================================================
            // Aplica todos os filtros acumulativamente sobre o escopo inicial
            const textoLower = texto.toLowerCase();
            const temDataFiltro = dataFiltro && dataFiltro.trim() !== '';
            const temStatusPagamento = statusPagamento && statusPagamento.trim() !== '';
            const temFormaPagamento = formaPagamento && formaPagamento.trim() !== '';
            const temFiltroObservacao = filtroObservacao && filtroObservacao.trim() !== '';
            
            const filtrados = escopoInicial.filter(p => {
                // Filtro de Texto (se houver)
                if (texto) {
                    const matchTexto = 
                        (p.Nome_Cliente || '').toLowerCase().includes(textoLower) ||
                        (p.ID_do_Pedido || '').toLowerCase().includes(textoLower) ||
                        (p.Numero || '').includes(texto);
                    
                    if (!matchTexto) return false;
                }
                
                // Filtro de Data/Intervalo (se houver)
                if (temDataFiltro) {
                    const dataPed = parseDataBR(p.Data_Entrega);
                    if (!dataPed) return false;
                    
                    if (dataFiltro.includes(',')) {
                        // Intervalo de datas
                        const [dataInicioStr, dataFimStr] = dataFiltro.split(',');
                        const dataInicio = parseDataISO(dataInicioStr.trim());
                        const dataFim = parseDataISO(dataFimStr.trim());
                        
                        if (!dataInicio || !dataFim) return false;
                        
                        // Compara√ß√£o usando getTime() (inclusivo: >= inicio e <= fim)
                        if (!(dataPed.getTime() >= dataInicio.getTime() && dataPed.getTime() <= dataFim.getTime())) {
                            return false;
                        }
                    } else {
                        // Data √∫nica
                        const dataFiltroObj = parseDataISO(dataFiltro.trim());
                        if (!dataFiltroObj) return false;
                        
                        // Compara√ß√£o usando getTime()
                        if (dataPed.getTime() !== dataFiltroObj.getTime()) {
                            return false;
                        }
                    }
                }
                
                // Filtro de Status de Pagamento (se houver)
                if (temStatusPagamento) {
                    const statusPed = (p.Status_Pagamento || 'Pagamento pendente').trim();
                    if (statusPed !== statusPagamento) {
                        return false;
                    }
                }
                
                // Filtro de Forma de Pagamento (se houver)
                if (temFormaPagamento) {
                    const formaPed = (p.Forma_de_Pagamento || '').trim();
                    if (formaPed !== formaPagamento) {
                        return false;
                    }
                }
                
                // Filtro de Observa√ß√£o (se houver)
                if (temFiltroObservacao) {
                    const temObs = p.Observacoes && p.Observacoes.trim() !== '';
                    if (filtroObservacao === 'com' && !temObs) {
                        return false;
                    }
                    if (filtroObservacao === 'sem' && temObs) {
                        return false;
                    }
                }
                
                // Passou em todos os filtros aplicados
                return true;
            });
            
            // ============================================================================
            // 3. RESULTADO
            // ============================================================================
            // Renderiza apenas os pedidos filtrados no Kanban
            renderizar(filtrados);
            // O dashboard j√° √© atualizado em renderizar() atrav√©s de atualizarDashboard()
        }

        function filtrarMesAtual() {
            // Define o intervalo do dia 1 ao √∫ltimo dia do m√™s vigente
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();
            
            // Primeiro dia do m√™s
            dataInicialIntervalo = new Date(anoAtual, mesAtual, 1);
            dataInicialIntervalo.setHours(0, 0, 0, 0);
            
            // √öltimo dia do m√™s
            dataFinalIntervalo = new Date(anoAtual, mesAtual + 1, 0);
            dataFinalIntervalo.setHours(0, 0, 0, 0);
            
            // Atualiza o display
            atualizarDisplayData();
            renderCalendar();
            filtrarPedidos();
            closeDatePicker();
        }

        function limparFiltros() {
            document.getElementById('search-input').value = '';
            document.getElementById('date-input').value = '';
            document.getElementById('date-filter-display').value = '';
            document.getElementById('filter-status-pagamento').value = '';
            document.getElementById('filter-forma-pagamento').value = '';
            document.getElementById('filter-observacao').value = '';
            dataInicialIntervalo = null;
            dataFinalIntervalo = null;
            filtrarPedidos();
        }

        // --- L√≥gica do Calend√°rio Customizado ---
        function openDatePicker() {
            // Carrega o estado atual do filtro de data para as vari√°veis de intervalo
            const dataFiltro = document.getElementById('date-input').value;
            if (dataFiltro) {
                if (dataFiltro.includes(',')) {
                    // √â um intervalo
                    const [dataInicio, dataFim] = dataFiltro.split(',');
                    const [anoInicio, mesInicio, diaInicio] = dataInicio.split('-');
                    const [anoFim, mesFim, diaFim] = dataFim.split('-');
                    dataInicialIntervalo = new Date(parseInt(anoInicio), parseInt(mesInicio) - 1, parseInt(diaInicio));
                    dataFinalIntervalo = new Date(parseInt(anoFim), parseInt(mesFim) - 1, parseInt(diaFim));
                    dataInicialIntervalo.setHours(0, 0, 0, 0);
                    dataFinalIntervalo.setHours(0, 0, 0, 0);
                } else {
                    // √â uma data √∫nica
                    const [ano, mes, dia] = dataFiltro.split('-');
                    dataInicialIntervalo = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                    dataInicialIntervalo.setHours(0, 0, 0, 0);
                    dataFinalIntervalo = null;
                }
            } else {
                dataInicialIntervalo = null;
                dataFinalIntervalo = null;
            }
            document.getElementById('date-picker-modal').classList.add('show');
            renderCalendar();
        }
        function closeDatePicker() {
            document.getElementById('date-picker-modal').classList.remove('show');
        }
        
        // Aplica o filtro de data selecionado
        function aplicarFiltroData() {
            if (!dataInicialIntervalo) {
                showToast("Selecione pelo menos uma data para filtrar!", true);
                return;
            }
            
            // Se h√° apenas data inicial, define ela tamb√©m como final (filtro de data √∫nica)
            if (dataInicialIntervalo && !dataFinalIntervalo) {
                dataFinalIntervalo = new Date(dataInicialIntervalo);
            }
            
            if (dataInicialIntervalo) dataInicialIntervalo.setHours(0, 0, 0, 0);
            if (dataFinalIntervalo) dataFinalIntervalo.setHours(0, 0, 0, 0);
            
            atualizarDisplayData();
            filtrarPedidos();
            
            if (dataInicialIntervalo && dataFinalIntervalo) {
                const diaInicio = String(dataInicialIntervalo.getDate()).padStart(2, '0');
                const mesInicio = String(dataInicialIntervalo.getMonth() + 1).padStart(2, '0');
                const anoInicio = dataInicialIntervalo.getFullYear();
                const diaFim = String(dataFinalIntervalo.getDate()).padStart(2, '0');
                const mesFim = String(dataFinalIntervalo.getMonth() + 1).padStart(2, '0');
                const anoFim = dataFinalIntervalo.getFullYear();
                
                if (dataInicialIntervalo.getTime() === dataFinalIntervalo.getTime()) {
                    showToast(`Filtro aplicado: ${diaInicio}/${mesInicio}/${anoInicio}`);
                } else {
                    showToast(`Filtro aplicado: ${diaInicio}/${mesInicio}/${anoInicio} - ${diaFim}/${mesFim}/${anoFim}`);
                }
            }
        }
        
        document.getElementById('prev-month').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        });
        
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearDisplay = document.getElementById('month-year-display');
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            monthYearDisplay.textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            calendarGrid.innerHTML = '';
            const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            weekdays.forEach(day => {
                const d = document.createElement('div');
                d.className = 'date-picker-weekday';
                d.textContent = day;
                calendarGrid.appendChild(d);
            });
            
            for(let i=0; i<startingDayOfWeek; i++) {
                const empty = document.createElement('div');
                empty.className = 'date-picker-empty';
                calendarGrid.appendChild(empty);
            }
            
            for(let day=1; day<=daysInMonth; day++) {
                const dayEl = document.createElement('div');
                const currentDate = new Date(year, month, day);
                currentDate.setHours(0, 0, 0, 0);
                
                dayEl.className = 'date-picker-day';
                dayEl.textContent = day;
                
                dayEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selecionarData(year, month, day);
                });
                
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                if (currentDate.getTime() === hoje.getTime()) {
                    dayEl.classList.add('today');
                }
                
                if (dataInicialIntervalo && dataFinalIntervalo) {
                    const inicio = new Date(dataInicialIntervalo);
                    const fim = new Date(dataFinalIntervalo);
                    inicio.setHours(0, 0, 0, 0);
                    fim.setHours(0, 0, 0, 0);
                    
                    if (currentDate.getTime() === inicio.getTime()) {
                        dayEl.classList.add('range-start');
                    } else if (currentDate.getTime() === fim.getTime()) {
                        dayEl.classList.add('range-end');
                    } else if (currentDate >= inicio && currentDate <= fim) {
                        dayEl.classList.add('in-range');
                    }
                } else if (dataInicialIntervalo) {
                    const inicio = new Date(dataInicialIntervalo);
                    inicio.setHours(0, 0, 0, 0);
                    if (currentDate.getTime() === inicio.getTime()) {
                        dayEl.classList.add('selected');
                        dayEl.classList.remove('range-start', 'range-end', 'in-range');
                    }
                }
                
                calendarGrid.appendChild(dayEl);
            }
            
            const totalCells = startingDayOfWeek + daysInMonth;
            const remainingCells = 42 - totalCells;
            for(let i=0; i<remainingCells; i++) {
                const empty = document.createElement('div');
                empty.className = 'date-picker-empty';
                calendarGrid.appendChild(empty);
            }
        }

        function selecionarData(year, month, day) {
            const selectedDate = new Date(year, month, day);
            selectedDate.setHours(0, 0, 0, 0);
            
            if (dataInicialIntervalo && dataFinalIntervalo) {
                dataInicialIntervalo = selectedDate;
                dataFinalIntervalo = null;
            }
            else if (!dataInicialIntervalo) {
                dataInicialIntervalo = selectedDate;
                dataFinalIntervalo = null;
            }
            else if (!dataFinalIntervalo) {
                if (selectedDate < dataInicialIntervalo) {
                    dataFinalIntervalo = new Date(dataInicialIntervalo);
                    dataInicialIntervalo = selectedDate;
                } else {
                    if (selectedDate.getTime() === dataInicialIntervalo.getTime()) {
                        dataInicialIntervalo = null;
                        dataFinalIntervalo = null;
                    } else {
                        dataFinalIntervalo = selectedDate;
                    }
                }
            }
            
            atualizarDisplayData();
            renderCalendar();
        }
        
        function atualizarDisplayData() {
            if (dataInicialIntervalo && dataFinalIntervalo) {
                const inicio = dataInicialIntervalo;
                const fim = dataFinalIntervalo;
                const diaInicio = String(inicio.getDate()).padStart(2, '0');
                const mesInicio = String(inicio.getMonth() + 1).padStart(2, '0');
                const anoInicio = inicio.getFullYear();
                const diaFim = String(fim.getDate()).padStart(2, '0');
                const mesFim = String(fim.getMonth() + 1).padStart(2, '0');
                const anoFim = fim.getFullYear();
                
                document.getElementById('date-filter-display').value = `${diaInicio}/${mesInicio}/${anoInicio} - ${diaFim}/${mesFim}/${anoFim}`;
                document.getElementById('date-input').value = `${anoInicio}-${mesInicio.padStart(2, '0')}-${diaInicio.padStart(2, '0')},${anoFim}-${mesFim.padStart(2, '0')}-${diaFim.padStart(2, '0')}`;
            } else if (dataInicialIntervalo) {
                const dia = String(dataInicialIntervalo.getDate()).padStart(2, '0');
                const mes = String(dataInicialIntervalo.getMonth() + 1).padStart(2, '0');
                const ano = dataInicialIntervalo.getFullYear();
                
                document.getElementById('date-filter-display').value = `${dia}/${mes}/${ano}`;
                document.getElementById('date-input').value = `${ano}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
            } else {
                document.getElementById('date-filter-display').value = '';
                document.getElementById('date-input').value = '';
            }
        }

        function selecionarHoje() {
            const hoje = new Date();
            dataInicialIntervalo = new Date(hoje);
            dataInicialIntervalo.setHours(0, 0, 0, 0);
            dataFinalIntervalo = null;
            atualizarDisplayData();
            renderCalendar();
            aplicarFiltroData(); // J√° chama filtrarPedidos e atualizarDashboard
            closeDatePicker();
        }

        // ============================================================================
        // L√ìGICA DE EDI√á√ÉO E ENVIO
        // ============================================================================
        function abrirModalEdicao(id) {
            const pedido = todosPedidos.find(p => p.ID_do_Pedido === id);
            if(!pedido) return;

            document.getElementById('modal-id-display').textContent = `#${id}`;
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-nome').value = pedido.Nome_Cliente;
            document.getElementById('edit-telefone').value = pedido.Numero; 
            
            const dataParts = (pedido.Data_Entrega || '').split('/');
            if(dataParts.length === 3) {
                document.getElementById('edit-data').value = `${dataParts[2]}-${dataParts[1]}-${dataParts[0]}`;
            } else {
                document.getElementById('edit-data').value = '';
            }

            document.getElementById('edit-hora').value = pedido.Horario_Entrega || '';
            document.getElementById('edit-forma').value = pedido.Forma_de_Pagamento || 'Pix';
            document.getElementById('edit-status-pgto').value = pedido.Status_Pagamento || 'Pagamento pendente';
            document.getElementById('edit-cupom').value = pedido.Cupom || '';
            document.getElementById('edit-total').value = pedido.Total_Final || '';
            document.getElementById('edit-obs').value = pedido.Observacoes || '';
            document.getElementById('edit-resumo').value = pedido.Resumo_dos_Itens || '';

            // Preenche o select de produtos
            preencherSelectProdutos();

            document.getElementById('edit-modal').style.display = 'flex';
        }

        // Preenche o select com produtos do cat√°logo
        function preencherSelectProdutos() {
            const select = document.getElementById('add-produto-select');
            select.innerHTML = '<option value="">Selecione um produto...</option>';
            
            // Adiciona "Outros" no topo (j√° est√° no HTML, mas garante que est√° presente)
            const outrosOption = select.querySelector('option[value="__OUTROS__"]');
            if (!outrosOption) {
                const optionOutros = document.createElement('option');
                optionOutros.value = '__OUTROS__';
                optionOutros.textContent = '--- Outros ---';
                select.appendChild(optionOutros);
            }
            
            Object.keys(CATALOGO_PRECOS).sort().forEach(produto => {
                const option = document.createElement('option');
                option.value = produto;
                option.textContent = produto;
                select.appendChild(option);
            });
        }

        // Fun√ß√£o para mostrar/ocultar campos quando "Outros" √© selecionado
        function toggleCamposOutros() {
            const produtoSelect = document.getElementById('add-produto-select');
            const nomeOutrosContainer = document.getElementById('add-nome-outros-container');
            const nomeOutrosInput = document.getElementById('add-nome-outros');
            const precoInput = document.getElementById('add-preco');
            
            if (produtoSelect.value === '__OUTROS__') {
                nomeOutrosContainer.style.display = 'block';
            } else {
                nomeOutrosContainer.style.display = 'none';
                nomeOutrosInput.value = '';
                
                // Se n√£o for "Outros", preenche o pre√ßo automaticamente
                if (produtoSelect.value && CATALOGO_PRECOS[produtoSelect.value]) {
                    const preco = CATALOGO_PRECOS[produtoSelect.value];
                    precoInput.value = preco.toFixed(2).replace('.', ',');
                } else {
                    precoInput.value = '';
                }
            }
        }

        // Fun√ß√£o para adicionar item ao resumo com c√°lculo de desconto e organiza√ß√£o por categoria
        function adicionarItemAoResumo() {
            const produtoSelect = document.getElementById('add-produto-select');
            const qtdInput = document.getElementById('add-qtd');
            const precoInput = document.getElementById('add-preco');
            const nomeOutrosInput = document.getElementById('add-nome-outros');
            const resumoTextarea = document.getElementById('edit-resumo');
            const totalInput = document.getElementById('edit-total');
            const obsTextarea = document.getElementById('edit-obs');

            const produtoSelecionado = produtoSelect.value;
            const quantidade = parseInt(qtdInput.value) || 1;

            if (!produtoSelecionado) {
                showToast('Selecione um produto', true);
                return;
            }

            if (quantidade < 1) {
                showToast('Quantidade deve ser no m√≠nimo 1', true);
                return;
            }

            // Verifica se √© "Outros"
            let produtoNome = '';
            let precoOriginal = 0;
            let categoriaEncontrada = 'Outros';
            
            if (produtoSelecionado === '__OUTROS__') {
                // Item "Outros"
                produtoNome = nomeOutrosInput.value.trim();
                
                if (!produtoNome) {
                    showToast('Informe o nome do item', true);
                    return;
                }
                
                const precoStr = precoInput.value.trim();
                if (!precoStr) {
                    showToast('Informe o pre√ßo do item', true);
                    return;
                }
                
                precoOriginal = parseFloat(precoStr.replace(',', '.')) || 0;
                if (precoOriginal <= 0) {
                    showToast('Pre√ßo deve ser maior que zero', true);
                    return;
                }
            } else {
                // Item do cat√°logo
                produtoNome = produtoSelecionado;
                precoOriginal = CATALOGO_PRECOS[produtoNome] || 0;
            }
            
            // Pre√ßo editado pelo usu√°rio
            let precoEditado = parseFloat(precoInput.value.replace(',', '.')) || precoOriginal;
            
            // Se n√£o foi preenchido e n√£o √© "Outros", usa o pre√ßo original
            if (!precoInput.value || precoInput.value.trim() === '') {
                if (produtoSelecionado !== '__OUTROS__') {
                    precoEditado = precoOriginal;
                }
            }

            // Calcula total do item
            const totalItem = precoEditado * quantidade;

            // Formata valores para exibi√ß√£o
            const precoFormatado = precoEditado.toFixed(2).replace('.', ',');
            const totalFormatado = totalItem.toFixed(2).replace('.', ',');

            // Busca a categoria do produto no cat√°logo (apenas se n√£o for "Outros")
            if (produtoSelecionado !== '__OUTROS__') {
                // Extrai o nome base do produto (remove tamanho)
                let nomeBase = produtoNome;
                // Remove padr√µes como " - P (1.5 KG)", " - M (2.5 KG)", etc.
                nomeBase = nomeBase.replace(/\s*-\s*[PMG]\s*\([\d.]+ KG\)/i, '').trim();
                
                // Busca a categoria no CATALOGO_PRODUTOS
                for (const [categoria, produtos] of Object.entries(CATALOGO_PRODUTOS)) {
                    if (produtos.some(produto => {
                        const produtoLower = produto.toLowerCase().trim();
                        const nomeLower = nomeBase.toLowerCase().trim();
                        return nomeLower.includes(produtoLower) || produtoLower.includes(nomeLower);
                    })) {
                        categoriaEncontrada = categoria;
                        break;
                    }
                }
            }

            // Gera string do item no formato: Nome - Qtd un. (R$ Unit√°rio) = R$ Total
            const linhaItem = `${produtoNome} - ${quantidade} un. (R$ ${precoFormatado}) = R$ ${totalFormatado}`;

            // Adiciona ao resumo organizado por categoria
            let resumoAtual = resumoTextarea.value.trim();
            let linhas = resumoAtual ? resumoTextarea.value.split('\n') : [];
            
            // Procura se a categoria j√° existe no resumo
            let categoriaIndex = -1;
            let proximaCategoriaIndex = linhas.length;
            
            for (let i = 0; i < linhas.length; i++) {
                const linha = linhas[i].trim();
                // Verifica se √© uma linha de categoria (come√ßa com "-" ou termina com ":")
                if (linha.startsWith('-') && linha.toLowerCase().includes(categoriaEncontrada.toLowerCase())) {
                    categoriaIndex = i;
                    // Procura a pr√≥xima categoria ou fim do texto
                    for (let j = i + 1; j < linhas.length; j++) {
                        const proxLinha = linhas[j].trim();
                        if (proxLinha.startsWith('-') && proxLinha.includes(':')) {
                            proximaCategoriaIndex = j;
                            break;
                        }
                    }
                    break;
                }
            }
            
            // Se encontrou a categoria, adiciona o item nela
            if (categoriaIndex >= 0) {
                // Insere o item ap√≥s a linha da categoria, antes da pr√≥xima categoria
                linhas.splice(proximaCategoriaIndex, 0, linhaItem);
            } else {
                // Se n√£o encontrou, adiciona linha em branco, categoria e o item
                const categoriaLinha = `- ${categoriaEncontrada}:`;
                // Adiciona linha em branco antes da categoria se j√° houver conte√∫do
                if (linhas.length > 0 && linhas[linhas.length - 1].trim() !== '') {
                    linhas.push('');
                }
                linhas.push(categoriaLinha);
                linhas.push(linhaItem);
            }
            
            resumoTextarea.value = linhas.join('\n');

            // Atualiza o total do pedido
            let totalAtual = 0;
            const totalAtualStr = totalInput.value.trim();
            if (totalAtualStr) {
                totalAtual = parseFloat(totalAtualStr.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            }
            const novoTotal = totalAtual + totalItem;
            totalInput.value = novoTotal.toFixed(2).replace('.', ',');

            // L√≥gica de desconto (apenas para produtos do cat√°logo, n√£o para "Outros")
            if (produtoSelecionado !== '__OUTROS__' && precoOriginal > 0 && precoEditado < precoOriginal) {
                const diferenca = (precoOriginal - precoEditado) * quantidade;
                const descontoFormatado = diferenca.toFixed(2).replace('.', ',');

                let obsAtual = obsTextarea.value.trim();
                
                // Procura por "Desconto de R$" no texto
                const regexDesconto = /Desconto de R\$\s*([\d.,]+)/i;
                const match = obsAtual.match(regexDesconto);

                if (match) {
                    // J√° existe desconto, soma o novo valor
                    const descontoAtual = parseFloat(match[1].replace(',', '.')) || 0;
                    const novoDescontoTotal = descontoAtual + diferenca;
                    const novoDescontoFormatado = novoDescontoTotal.toFixed(2).replace('.', ',');
                    
                    obsAtual = obsAtual.replace(regexDesconto, `Desconto de R$ ${novoDescontoFormatado}`);
                } else {
                    // N√£o existe desconto, adiciona novo
                    const novaLinhaDesconto = obsAtual ? `\nDesconto de R$ ${descontoFormatado}` : `Desconto de R$ ${descontoFormatado}`;
                    obsAtual = obsAtual + novaLinhaDesconto;
                }

                obsTextarea.value = obsAtual;
            }

            // Limpa os campos
            produtoSelect.value = '';
            qtdInput.value = '1';
            precoInput.value = '';
            nomeOutrosInput.value = '';
            
            // Reseta a interface gr√°fica para o estado inicial
            toggleCamposOutros();

            showToast('Item adicionado com sucesso!');
        }

        function fecharModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        // ============================================================================
        // FUNCIONALIDADE DE ADICIONAR ITENS
        // ============================================================================
        
        // Lista de itens dispon√≠veis organizados por categoria
        const ITENS_DISPONIVEIS = {
            'Bolos Especiais': [
                { nome: 'Cheesecake tradicional', valor: 0 },
                { nome: 'Bolo Red velvet', valor: 0 },
                { nome: 'Bolo de Chocolate', valor: 0 }
            ],
            'Bolos Tradicionais': [
                { nome: 'Bolo de Lim√£o e Chocolate Branco', valor: 0 },
                { nome: 'Bolo de Chocolate', valor: 0 },
                { nome: 'Bolo de Cenoura', valor: 0 }
            ],
            'Doces': [
                { nome: 'Bem-casado', valor: 0 },
                { nome: 'Ouri√ßo', valor: 0 },
                { nome: 'Brigadeiro', valor: 0 }
            ],
            'Pratos Salgados': [
                { nome: 'Empad√£o de Camar√£o', valor: 0 },
                { nome: 'Quiche de Frango', valor: 0 },
                { nome: 'Torta Salgada', valor: 0 }
            ],
            'Salgados Assados': [
                { nome: 'Empadinha de Frango', valor: 0 },
                { nome: 'Coxinha Assada', valor: 0 }
            ],
            'Salgados Fritos': [
                { nome: 'Bolinho de Charque', valor: 0 },
                { nome: 'Coxinha de Frango', valor: 0 },
                { nome: 'Pastel de Festa', valor: 0 }
            ]
        };

        let itensSelecionados = []; // Array de { categoria, nome, quantidade, valorUnitario, valorTotal }

        function abrirModalAdicionarItens() {
            itensSelecionados = [];
            renderizarItensDisponiveis();
            atualizarResumoSelecionados();
            document.getElementById('adicionar-itens-modal').style.display = 'flex';
        }

        function fecharModalAdicionarItens() {
            document.getElementById('adicionar-itens-modal').style.display = 'none';
            // Limpa campos "Outros"
            document.getElementById('outros-item-nome').value = '';
            document.getElementById('outros-item-valor').value = '';
            document.getElementById('outros-item-quantidade').value = '1';
        }

        function renderizarItensDisponiveis() {
            const container = document.getElementById('itens-lista');
            container.innerHTML = '';

            Object.keys(ITENS_DISPONIVEIS).forEach(categoria => {
                const categoriaDiv = document.createElement('div');
                categoriaDiv.style.border = '1px solid #ddd';
                categoriaDiv.style.borderRadius = '8px';
                categoriaDiv.style.padding = '10px';
                categoriaDiv.style.backgroundColor = '#fff';

                const categoriaTitle = document.createElement('h4');
                categoriaTitle.textContent = categoria;
                categoriaTitle.style.margin = '0 0 10px 0';
                categoriaTitle.style.fontSize = '0.95em';
                categoriaTitle.style.color = 'var(--cor-texto)';
                categoriaDiv.appendChild(categoriaTitle);

                ITENS_DISPONIVEIS[categoria].forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item-disponivel-row';
                    itemDiv.style.display = 'flex';
                    itemDiv.style.gap = '10px';
                    itemDiv.style.alignItems = 'center';
                    itemDiv.style.marginBottom = '8px';

                    const nomeSpan = document.createElement('span');
                    nomeSpan.textContent = item.nome;
                    nomeSpan.className = 'item-nome';
                    nomeSpan.style.flex = '2';
                    nomeSpan.style.fontSize = '0.9em';
                    itemDiv.appendChild(nomeSpan);

                    const valorInput = document.createElement('input');
                    valorInput.type = 'number';
                    valorInput.placeholder = 'Valor (R$)';
                    valorInput.step = '0.01';
                    valorInput.min = '0';
                    valorInput.className = 'item-valor-input';
                    valorInput.style.flex = '1';
                    valorInput.style.padding = '6px';
                    valorInput.style.border = '1px solid #5a9bd4';
                    valorInput.style.borderRadius = '6px';
                    valorInput.dataset.categoria = categoria;
                    valorInput.dataset.nome = item.nome;
                    itemDiv.appendChild(valorInput);

                    const qtdInput = document.createElement('input');
                    qtdInput.type = 'number';
                    qtdInput.placeholder = 'Qtd';
                    qtdInput.min = '1';
                    qtdInput.value = '1';
                    qtdInput.className = 'item-qtd-input';
                    qtdInput.style.width = '60px';
                    qtdInput.style.padding = '6px';
                    qtdInput.style.border = '1px solid #5a9bd4';
                    qtdInput.style.borderRadius = '6px';
                    qtdInput.dataset.categoria = categoria;
                    qtdInput.dataset.nome = item.nome;
                    itemDiv.appendChild(qtdInput);

                    const addBtn = document.createElement('button');
                    addBtn.textContent = '+';
                    addBtn.className = 'btn-save item-add-btn';
                    addBtn.style.padding = '6px 12px';
                    addBtn.style.fontSize = '0.85em';
                    addBtn.onclick = () => adicionarItemLista(categoria, item.nome, valorInput.value, qtdInput.value);
                    itemDiv.appendChild(addBtn);

                    categoriaDiv.appendChild(itemDiv);
                });

                container.appendChild(categoriaDiv);
            });
        }

        function adicionarItemLista(categoria, nome, valorStr, quantidadeStr) {
            const valor = parseFloat(valorStr) || 0;
            const quantidade = parseInt(quantidadeStr) || 1;

            if (quantidade < 1) {
                showToast('Quantidade m√≠nima √© 1 unidade', true);
                return;
            }

            if (valor <= 0) {
                showToast('Informe o valor do item', true);
                return;
            }

            const valorTotal = valor * quantidade;
            const itemKey = `${categoria}-${nome}`;

            // Verifica se j√° existe, se sim, atualiza
            const index = itensSelecionados.findIndex(i => i.key === itemKey);
            if (index >= 0) {
                itensSelecionados[index].quantidade += quantidade;
                itensSelecionados[index].valorTotal = itensSelecionados[index].valorUnitario * itensSelecionados[index].quantidade;
            } else {
                itensSelecionados.push({
                    key: itemKey,
                    categoria: categoria,
                    nome: nome,
                    quantidade: quantidade,
                    valorUnitario: valor,
                    valorTotal: valorTotal
                });
            }

            atualizarResumoSelecionados();
            showToast('Item adicionado!');
        }

        function adicionarItemOutros() {
            const nome = document.getElementById('outros-item-nome').value.trim();
            const valorStr = document.getElementById('outros-item-valor').value;
            const quantidadeStr = document.getElementById('outros-item-quantidade').value;

            if (!nome) {
                showToast('Informe o nome do item', true);
                return;
            }

            const valor = parseFloat(valorStr) || 0;
            const quantidade = parseInt(quantidadeStr) || 1;

            if (quantidade < 1) {
                showToast('Quantidade m√≠nima √© 1 unidade', true);
                return;
            }

            if (valor <= 0) {
                showToast('Informe o valor do item', true);
                return;
            }

            const valorTotal = valor * quantidade;
            const itemKey = `Outros-${nome}`;

            // Verifica se j√° existe, se sim, atualiza
            const index = itensSelecionados.findIndex(i => i.key === itemKey);
            if (index >= 0) {
                itensSelecionados[index].quantidade += quantidade;
                itensSelecionados[index].valorTotal = itensSelecionados[index].valorUnitario * itensSelecionados[index].quantidade;
            } else {
                itensSelecionados.push({
                    key: itemKey,
                    categoria: 'Outros',
                    nome: nome,
                    quantidade: quantidade,
                    valorUnitario: valor,
                    valorTotal: valorTotal
                });
            }

            // Limpa campos
            document.getElementById('outros-item-nome').value = '';
            document.getElementById('outros-item-valor').value = '';
            document.getElementById('outros-item-quantidade').value = '1';

            atualizarResumoSelecionados();
            showToast('Item adicionado!');
        }

        function atualizarResumoSelecionados() {
            const container = document.getElementById('itens-selecionados-resumo');
            const lista = document.getElementById('itens-selecionados-lista');
            const totalSpan = document.getElementById('total-itens-selecionados');

            if (itensSelecionados.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            lista.innerHTML = '';

            let totalGeral = 0;

            // Agrupa por categoria
            const itensPorCategoria = {};
            itensSelecionados.forEach(item => {
                if (!itensPorCategoria[item.categoria]) {
                    itensPorCategoria[item.categoria] = [];
                }
                itensPorCategoria[item.categoria].push(item);
            });

            Object.keys(itensPorCategoria).forEach(categoria => {
                const categoriaDiv = document.createElement('div');
                categoriaDiv.style.marginBottom = '10px';

                const categoriaTitle = document.createElement('strong');
                categoriaTitle.textContent = `- ${categoria}:`;
                categoriaTitle.style.display = 'block';
                categoriaTitle.style.marginBottom = '5px';
                categoriaDiv.appendChild(categoriaTitle);

                itensPorCategoria[categoria].forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.style.fontSize = '0.9em';
                    itemDiv.style.marginLeft = '10px';
                    itemDiv.style.marginBottom = '3px';
                    itemDiv.innerHTML = `${item.quantidade} un. - ${item.nome} (R$ ${item.valorUnitario.toFixed(2).replace('.', ',')} cada) = R$ ${item.valorTotal.toFixed(2).replace('.', ',')}`;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = '√ó';
                    removeBtn.style.marginLeft = '10px';
                    removeBtn.style.padding = '2px 6px';
                    removeBtn.style.background = '#f44336';
                    removeBtn.style.color = 'white';
                    removeBtn.style.border = 'none';
                    removeBtn.style.borderRadius = '4px';
                    removeBtn.style.cursor = 'pointer';
                    removeBtn.onclick = () => {
                        const index = itensSelecionados.findIndex(i => i.key === item.key);
                        if (index >= 0) {
                            itensSelecionados.splice(index, 1);
                            atualizarResumoSelecionados();
                        }
                    };
                    itemDiv.appendChild(removeBtn);
                    categoriaDiv.appendChild(itemDiv);

                    totalGeral += item.valorTotal;
                });

                lista.appendChild(categoriaDiv);
            });

            totalSpan.textContent = totalGeral.toFixed(2).replace('.', ',');
        }

        function confirmarAdicionarItens() {
            if (itensSelecionados.length === 0) {
                showToast('Selecione pelo menos um item', true);
                return;
            }

            const resumoAtual = document.getElementById('edit-resumo').value;
            const totalAtualStr = document.getElementById('edit-total').value;
            
            // Calcula novo total
            let totalAtual = 0;
            if (totalAtualStr) {
                totalAtual = parseFloat(totalAtualStr.replace(',', '.')) || 0;
            }
            
            let totalNovosItens = 0;
            itensSelecionados.forEach(item => {
                totalNovosItens += item.valorTotal;
            });

            const novoTotal = totalAtual + totalNovosItens;

            // Adiciona itens ao resumo
            let novoResumo = resumoAtual ? resumoAtual + '\n' : '';
            
            // Agrupa por categoria
            const itensPorCategoria = {};
            itensSelecionados.forEach(item => {
                if (!itensPorCategoria[item.categoria]) {
                    itensPorCategoria[item.categoria] = [];
                }
                itensPorCategoria[item.categoria].push(item);
            });

            Object.keys(itensPorCategoria).forEach(categoria => {
                novoResumo += `- ${categoria}:\n`;
                itensPorCategoria[categoria].forEach(item => {
                    novoResumo += `${item.quantidade} un. - ${item.nome}\n`;
                });
            });

            // Atualiza campos
            document.getElementById('edit-resumo').value = novoResumo;
            document.getElementById('edit-total').value = novoTotal.toFixed(2).replace('.', ',');

            showToast('Itens adicionados com sucesso!');
            fecharModalAdicionarItens();
        }

        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            mostrarLoading(true);

            const id = document.getElementById('edit-id').value;
            
            const dataInput = document.getElementById('edit-data').value;
            let dataFormatada = "";
            if (dataInput) {
                const p = dataInput.split('-');
                dataFormatada = `'${p[2]}/${p[1]}/${p[0]}`;
            }

            let horaFormatada = `'${document.getElementById('edit-hora').value}`;
            let total = document.getElementById('edit-total').value;
            if(total.includes('.')) total = total.replace('.', ',');

            const pedidoOriginal = todosPedidos.find(p => p.ID_do_Pedido === id);

            const payload = {
                action: 'updateData',
                ID_do_Pedido: id,
                Nome_Cliente: document.getElementById('edit-nome').value,
                Numero: document.getElementById('edit-telefone').value,
                Data_Entrega: dataFormatada,
                Horario_Entrega: horaFormatada,
                Total_Final: total,
                Forma_de_Pagamento: document.getElementById('edit-forma').value,
                Status_Pagamento: document.getElementById('edit-status-pgto').value,
                Cupom: document.getElementById('edit-cupom').value,
                Observacoes: document.getElementById('edit-obs').value,
                Status_do_Pedido: pedidoOriginal ? pedidoOriginal.Status_do_Pedido : 'Pedido Recebido',
                Resumo_dos_Itens: document.getElementById('edit-resumo').value
            };

            try {
                await fetch(API_URL, {
                    method: "POST",
                    mode: 'no-cors',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                
                atualizarLocalmente(payload);
                showToast("Salvo!");
                fecharModal();
            } catch (err) {
                console.error(err);
                showToast("Erro ao salvar!", true);
            }
            mostrarLoading(false);
        });
        
        async function atualizarStatusPagamentoDireto(id, selectElement) {
             const novoStatus = selectElement.value;
             mostrarLoading(true);
             
             const pedido = todosPedidos.find(p => p.ID_do_Pedido === id);
             let totalFormatado = String(pedido.Total_Final || '').replace('.', ',');
             
             const payload = {
                action: 'updateData',
                ID_do_Pedido: id,
                Nome_Cliente: pedido.Nome_Cliente,
                Numero: pedido.Numero,
                Data_Entrega: `'${pedido.Data_Entrega}`,
                Horario_Entrega: `'${pedido.Horario_Entrega}`,
                Total_Final: totalFormatado,
                Forma_de_Pagamento: pedido.Forma_de_Pagamento,
                Status_Pagamento: novoStatus,
                Cupom: pedido.Cupom,
                Observacoes: pedido.Observacoes,
                Status_do_Pedido: pedido.Status_do_Pedido,
                Resumo_dos_Itens: pedido.Resumo_dos_Itens
             };
             
             try {
                await fetch(API_URL, {
                    method: "POST",
                    mode: 'no-cors',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                
                pedido.Status_Pagamento = novoStatus;
                filtrarPedidos();
                showToast("Pagamento Atualizado!");
             } catch (err) {
                 showToast("Erro ao salvar", true);
             }
             mostrarLoading(false);
        }

        // ============================================================================
        // A√á√ïES EM MASSA E DRAG & DROP
        // ============================================================================
        function allowDrop(ev) { ev.preventDefault(); }
        function drag(ev) { ev.dataTransfer.setData("text", ev.target.dataset.id); }
        
        async function drop(ev) {
            ev.preventDefault();
            const id = ev.dataTransfer.getData("text");
            const col = ev.target.closest('.kanban-column');
            if(!col) return;
            
            const novoStatus = col.dataset.status;
            
            const card = document.getElementById(`card-${id}`);
            col.querySelector('.column-content').appendChild(card);
            
            mostrarLoading(true);
            try {
                await fetch(API_URL, {
                    method: "POST",
                    mode: 'no-cors',
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify({ action: 'updateStatus', id: id, Status_do_Pedido: novoStatus })
                });
                
                const p = todosPedidos.find(p => p.ID_do_Pedido === id);
                if(p) p.Status_do_Pedido = novoStatus;
                
                showToast("Status atualizado!");
                filtrarPedidos(); 
            } catch(e) {
                showToast("Erro ao mover", true);
            }
            mostrarLoading(false);
        }

        function toggleSelecao(id, checkbox) {
            if(checkbox.checked) ticketsSelecionados.add(id);
            else ticketsSelecionados.delete(id);
            atualizarBarraAcoes();
        }
        
        function toggleSelectColumn(checkbox, status) {
            const col = document.querySelector(`.kanban-column[data-status="${status}"]`);
            const checks = col.querySelectorAll('.card-checkbox');
            checks.forEach(c => {
                c.checked = checkbox.checked;
                toggleSelecao(c.closest('.pedido-card').dataset.id, c);
            });
        }

        function atualizarBarraAcoes() {
            const bar = document.getElementById('bulk-actions-bar');
            document.getElementById('selected-count').textContent = `${ticketsSelecionados.size} itens`;
            bar.style.display = ticketsSelecionados.size > 0 ? 'flex' : 'none';
            atualizarDashboard();
        }

        function limparSelecao() {
            ticketsSelecionados.clear();
            document.querySelectorAll('.card-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.column-select-all-checkbox').forEach(cb => cb.checked = false);
            atualizarBarraAcoes();
        }

        function abrirBulkMove() { document.getElementById('bulk-move-modal').style.display = 'flex'; }
        async function executarBulkMove() {
            const novoStatus = document.getElementById('bulk-move-select').value;
            mostrarLoading(true);
            
            const promises = Array.from(ticketsSelecionados).map(id => {
                const p = todosPedidos.find(pedido => pedido.ID_do_Pedido === id);
                if(p) p.Status_do_Pedido = novoStatus;
                return fetch(API_URL, {
                    method: "POST", mode: 'no-cors', headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify({ action: 'updateStatus', id: id, Status_do_Pedido: novoStatus })
                });
            });

            await Promise.all(promises);
            mostrarLoading(false);
            document.getElementById('bulk-move-modal').style.display = 'none';
            limparSelecao();
            filtrarPedidos();
            showToast("Pedidos movidos!");
        }

        function abrirBulkPayment() { document.getElementById('bulk-payment-modal').style.display = 'flex'; }
        async function executarBulkPayment() {
            const novoStatus = document.getElementById('bulk-payment-select').value;
            mostrarLoading(true);

            const promises = Array.from(ticketsSelecionados).map(id => {
                const p = todosPedidos.find(pedido => pedido.ID_do_Pedido === id);
                if(p) {
                   let totalFormatado = String(p.Total_Final || '').replace('.', ',');
                   const payload = {
                        action: 'updateData', ID_do_Pedido: id,
                        Nome_Cliente: p.Nome_Cliente, Numero: p.Numero,
                        Data_Entrega: `'${p.Data_Entrega}`, Horario_Entrega: `'${p.Horario_Entrega}`,
                        Total_Final: totalFormatado, Forma_de_Pagamento: p.Forma_de_Pagamento,
                        Status_Pagamento: novoStatus, Cupom: p.Cupom,
                        Observacoes: p.Observacoes, Status_do_Pedido: p.Status_do_Pedido,
                        Resumo_dos_Itens: p.Resumo_dos_Itens
                   };
                   p.Status_Pagamento = novoStatus;
                   return fetch(API_URL, {
                        method: "POST", mode: 'no-cors', headers: { "Content-Type": "text/plain" },
                        body: JSON.stringify(payload)
                   });
                }
            });

            await Promise.all(promises);
            mostrarLoading(false);
            document.getElementById('bulk-payment-modal').style.display = 'none';
            limparSelecao();
            filtrarPedidos();
            showToast("Pagamentos atualizados!");
        }

        function abrirModalResumos() {
            const selecionados = todosPedidos.filter(p => ticketsSelecionados.has(p.ID_do_Pedido));
            if(selecionados.length === 0) {
                showToast("Selecione pelo menos um pedido!", true);
                return;
            }
            document.getElementById('resumos-modal').style.display = 'flex';
        }

        function fecharModalResumos() {
            document.getElementById('resumos-modal').style.display = 'none';
        }

        function obterEmojiCupom(pedido) {
            if (pedido.Cupom) {
                const cupom = pedido.Cupom.toLowerCase();
                if (cupom.includes('cookie') || cupom.includes('üç™')) return 'üç™';
                if (cupom.includes('ticket') || cupom.includes('üéüÔ∏è')) return 'üéüÔ∏è';
            }
            return '';
        }

        function extrairDescontoCupom(cupomTexto) {
            if (!cupomTexto) return null;
            
            const textoUpper = cupomTexto.toUpperCase();

            // 1. Verifica se tem porcentagem expl√≠cita (ex: "10%")
            const percentMatch = cupomTexto.match(/(\d+(?:[.,]\d+)?)%/);
            if (percentMatch) {
                return { tipo: 'percentual', valor: parseFloat(percentMatch[1].replace(',', '.')) };
            }

            // 2. Verifica se √© um c√≥digo FAVU... (Regra espec√≠fica: 10% de desconto)
            // Isso evita que ele pegue os n√∫meros do c√≥digo como valor monet√°rio
            if (textoUpper.includes('FAVU') || textoUpper.includes('COOKIES10')) {
                return { tipo: 'percentual', valor: 10 };
            }

            // 3. Verifica valor fixo (R$ OBRIGAT√ìRIO agora, para n√£o confundir com o c√≥digo)
            const valorMatch = cupomTexto.match(/R\$\s*(\d+(?:[.,]\d+)?)/i);
            if (valorMatch) {
                let valor = valorMatch[1].replace(',', '.');
                return { tipo: 'fixo', valor: parseFloat(valor) };
            }

            return null;
        }

        function calcularValoresComCupom(pedido) {
            const totalFinal = calcularValorPedido(pedido);
            const descontoInfo = extrairDescontoCupom(pedido.Cupom);
            
            if (!descontoInfo) {
                return { temCupom: !!pedido.Cupom, valorOriginal: totalFinal, desconto: 0, totalFinal: totalFinal };
            }
            
            let valorOriginal = 0;
            let desconto = 0;
            
            if (descontoInfo.tipo === 'percentual') {
                valorOriginal = totalFinal / (1 - descontoInfo.valor / 100);
                desconto = valorOriginal - totalFinal;
            } else {
                desconto = descontoInfo.valor;
                valorOriginal = totalFinal + desconto;
            }
            
            return { temCupom: true, valorOriginal: valorOriginal, desconto: desconto, totalFinal: totalFinal };
        }

        /**
         * Processa o texto do campo Resumo_dos_Itens e extrai itens organizados por categoria.
         * 
         * Regras:
         * - Detecta categorias: linhas come√ßando com "-" ou terminando com ":"
         * - Detecta itens: padr√£o "Quantidade un. - Nome" ou linhas contendo valores monet√°rios
         * - Se item detectado sem categoria: atribui categoria "Outros"
         * - Extrai quantidade via Regex (d√≠gitos antes de "un", "un.", "unidades")
         */
        function processarItensResumo(resumoItens) {
            if (!resumoItens) return [];
            
            const linhas = resumoItens.split('\n');
            const itens = [];
            let categoriaAtual = '';
            
            linhas.forEach(linha => {
                const linhaTrim = linha.trim();
                if (!linhaTrim) return;
                
                // Detec√ß√£o de Categorias:
                // 1. Linhas come√ßando com "-" (sem ‚§∑ e sem n√∫mero no in√≠cio)
                // 2. Linhas terminando com ":" (ex: "Bolos Tradicionais:")
                const ehCategoriaComHifen = linhaTrim.startsWith('-') && !linhaTrim.includes('‚§∑') && !linhaTrim.match(/^-\s*\d/);
                const ehCategoriaComDoisPontos = linhaTrim.endsWith(':') && !linhaTrim.includes('‚§∑');
                
                if (ehCategoriaComHifen) {
                    categoriaAtual = linhaTrim.replace(/^-\s*/, '').trim();
                } 
                else if (ehCategoriaComDoisPontos) {
                    // Remove os dois pontos ao salvar
                    categoriaAtual = linhaTrim.replace(/:\s*$/, '').trim();
                }
                // Detec√ß√£o de Itens:
                // Itens seguem padr√£o "Quantidade un. - Nome" ou cont√™m valores monet√°rios (R$)
                else {
                    // Verifica se √© um item: cont√©m "un.", "unidades", "un" com n√∫mero, ou "R$"
                    const temQuantidade = linhaTrim.match(/\d+\s*(un\.|unidades|un)\b/i);
                    const temValorMonetario = linhaTrim.includes('R$');
                    const temPadraoItem = linhaTrim.match(/^[\w\s]+-\s*\d+/);
                    const temSeta = linhaTrim.includes('‚§∑');
                    
                    if (temQuantidade || temValorMonetario || temPadraoItem || temSeta) {
                        // Remove "‚§∑" se presente
                    let itemTexto = linhaTrim.replace(/.*‚§∑\s*/, '').trim();
                        
                        // Extrai quantidade usando Regex (d√≠gitos antes de "un", "un.", "unidades")
                        const quantidadeMatch = itemTexto.match(/(\d+)\s*(un\.|unidades|un)\b/i);
                        let quantidade = 1;
                        
                        if (quantidadeMatch) {
                            quantidade = parseInt(quantidadeMatch[1], 10) || 1;
                        }
                        
                        // Normaliza o formato do item para "X un. - Nome do Produto"
                    if (!itemTexto.match(/^\d+\s*un\.\s*-/)) {
                            // Remove a quantidade existente para reformatar
                            itemTexto = itemTexto.replace(/\d+\s*(un\.|unidades|un)\s*/gi, '').trim();
                            // Remove "R$" e valores monet√°rios do final
                            itemTexto = itemTexto.replace(/\s*R\$\s*[\d.,]+.*$/, '').trim();
                            // Remove h√≠fens extras
                            itemTexto = itemTexto.replace(/^-\s*/, '').trim();
                            
                            if (itemTexto) {
                                itemTexto = `${quantidade} un. - ${itemTexto}`;
                            }
                        }
                        
                        // L√≥gica de categoriza√ß√£o inteligente:
                        // 1. Se j√° tem categoria detectada no texto, usa ela
                        // 2. Se n√£o tem categoria, busca no cat√°logo
                        // 3. Se n√£o encontrar no cat√°logo, usa "Outros"
                        if (itemTexto) {
                            let categoriaParaUsar = categoriaAtual;
                            
                            // Se n√£o h√° categoria detectada, busca no cat√°logo
                            if (!categoriaParaUsar) {
                                categoriaParaUsar = buscarCategoriaNoCatalogo(itemTexto);
                            }
                            
                            // Se ainda n√£o encontrou, usa "Outros"
                            if (!categoriaParaUsar) {
                                categoriaParaUsar = 'Outros';
                            }
                            
                            itens.push({ categoria: categoriaParaUsar, item: itemTexto, quantidade: quantidade });
                        }
                    }
                }
            });
            return itens;
        }

        function gerarListaPedidos() {
            const selecionados = todosPedidos.filter(p => ticketsSelecionados.has(p.ID_do_Pedido));
            if(selecionados.length === 0) return;
            
            let texto = `Resumo ${selecionados.length} Pedido(s):\n\n`;
            
            selecionados.forEach((p, index) => {
                texto += `Pedido ${index + 1}\n\n`;
                texto += `* ${p.Nome_Cliente}\n`;
                texto += `   ‚§∑ ${p.Data_Entrega || '--/--/----'} √†s ${p.Horario_Entrega || '--:--'}\n`;
                const emoji = obterEmojiCupom(p);
                texto += `   ‚§∑ ${p.ID_do_Pedido}${emoji ? ' ' + emoji : ''}\n\n`;
                
                texto += `*- Itens:*\n\n`;
                const itens = processarItensResumo(p.Resumo_dos_Itens);
                let categoriaAtual = '';
                
                // Agrupa itens por categoria para exibi√ß√£o organizada
                itens.forEach(item => {
                    if (item.categoria !== categoriaAtual) {
                        categoriaAtual = item.categoria;
                        texto += `*- ${categoriaAtual}*\n`;
                    }
                    let itemFormatado = item.item.replace(/^‚§∑\s*/, '').trim();
                    texto += `${itemFormatado}\n`;
                });
                
                // Se n√£o houver itens processados mas houver resumo, exibe o resumo original
                if (itens.length === 0 && p.Resumo_dos_Itens) {
                    texto += p.Resumo_dos_Itens + '\n';
                }
                
                const valores = calcularValoresComCupom(p);
                if (valores.temCupom && valores.desconto > 0) {
                    texto += `\n*Valor Original:* R$ ${valores.valorOriginal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n`;
                    texto += `*Desconto (${p.Cupom}):* R$ ${valores.desconto.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n`;
                    texto += `*Total:* R$ ${valores.totalFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n`;
                } else {
                    texto += `\n*Total:* R$ ${formatarValorComCentavos(p.Total_Final)}\n`;
                }
                texto += `\n------------------------------------------\n\n`;
            });
            
            navigator.clipboard.writeText(texto).then(() => {
                showToast("Resumo copiado! Abrindo WhatsApp...");
                const link = `https://wa.me/558195256641?text=${encodeURIComponent(texto)}`;
                window.open(link, '_blank');
            }).catch(() => {
                const link = `https://wa.me/558195256641?text=${encodeURIComponent(texto)}`;
                window.open(link, '_blank');
            });
            fecharModalResumos();
        }

        function gerarResumoItens() {
            const selecionados = todosPedidos.filter(p => ticketsSelecionados.has(p.ID_do_Pedido));
            if(selecionados.length === 0) return;
            
            const itensAgrupados = {};
            const datasEntrega = [];
            
            // Percorre todos os pedidos selecionados e processa seus itens
            selecionados.forEach(p => {
                // Coleta datas de entrega para calcular o intervalo
                if (p.Data_Entrega) {
                    const dataPed = parseDataBR(p.Data_Entrega);
                    if (dataPed) {
                        datasEntrega.push(dataPed);
                    }
                }
                
                const itens = processarItensResumo(p.Resumo_dos_Itens);
                itens.forEach(item => {
                    // Inicializa a categoria se n√£o existir
                    if (!itensAgrupados[item.categoria]) {
                        itensAgrupados[item.categoria] = {};
                    }
                    
                    // Extrai quantidade e nome do item
                    // Padr√£o esperado: "X un. - Nome do Produto"
                    // Usa a propriedade quantidade retornada por processarItensResumo, ou extrai do texto
                    let quantidade = item.quantidade || 1;
                    let nomeItem = '';
                    
                    const match = item.item.match(/^(\d+)\s*un\.\s*-\s*(.+)$/);
                    if (match) {
                        // Se j√° tem quantidade no objeto, usa ela; sen√£o, extrai do texto
                        quantidade = item.quantidade || parseInt(match[1], 10) || 1;
                        nomeItem = match[2].trim();
                    } else {
                        // Se n√£o tem o padr√£o, tenta extrair o nome removendo a quantidade do in√≠cio
                        nomeItem = item.item.replace(/^\d+\s*un\.\s*-\s*/, '').trim();
                        if (!nomeItem) {
                            nomeItem = item.item.trim();
                        }
                    }
                    
                    // Limpa o nome do item: remove "- (" e informa√ß√µes de valor unit√°rio
                    // Remove padr√µes como "- (R$: 3,00 cada) =", "- (", etc.
                    nomeItem = nomeItem
                        .replace(/\s*-\s*\([^)]*\)\s*=?\s*/g, '') // Remove "- (qualquer coisa) =" em qualquer lugar
                        .replace(/\s*-\s*\([^)]*$/g, '') // Remove "- (" e tudo depois at√© o final (caso n√£o tenha fechamento)
                        .replace(/\s*-\s*\(/g, '') // Remove qualquer "- (" restante
                        .trim();
                    
                    // Inicializa o item na categoria se n√£o existir
                    if (!itensAgrupados[item.categoria][nomeItem]) {
                        itensAgrupados[item.categoria][nomeItem] = 0;
                    }
                    
                    // Soma a quantidade do item id√™ntico (mesmo nome e categoria)
                    itensAgrupados[item.categoria][nomeItem] += quantidade;
                });
            });
            
            // Calcula o intervalo de datas (m√≠nima e m√°xima)
            let dataInicioStr = '--/--/----';
            let dataFimStr = '--/--/----';
            
            if (datasEntrega.length > 0) {
                datasEntrega.sort((a, b) => a.getTime() - b.getTime());
                const dataInicio = datasEntrega[0];
                const dataFim = datasEntrega[datasEntrega.length - 1];
                
                // Formata data no formato DD/MM/AAAA
                const formatarDataBR = (data) => {
                    const dia = String(data.getDate()).padStart(2, '0');
                    const mes = String(data.getMonth() + 1).padStart(2, '0');
                    const ano = data.getFullYear();
                    return `${dia}/${mes}/${ano}`;
                };
                
                dataInicioStr = formatarDataBR(dataInicio);
                dataFimStr = formatarDataBR(dataFim);
            }
            
            // Gera o texto final - apenas lista de itens
            // Se data in√≠cio e fim s√£o iguais, mostra apenas uma data; sen√£o, mostra intervalo
            const intervaloDatas = dataInicioStr === dataFimStr ? dataInicioStr : `${dataInicioStr} √† ${dataFimStr}`;
            let texto = `*- Lista de itens | ${intervaloDatas}*\n\n`;
            
            // Separa categorias normais de "Outros" para colocar "Outros" no final
            const categorias = Object.keys(itensAgrupados);
            const categoriasNormais = categorias.filter(cat => cat.toLowerCase() !== 'outros' && cat.toLowerCase() !== 'outros itens');
            const categoriasOutros = categorias.filter(cat => cat.toLowerCase() === 'outros' || cat.toLowerCase() === 'outros itens');
            
            // Ordena categorias normais alfabeticamente
            categoriasNormais.sort();
            
            // Adiciona categorias normais primeiro
            categoriasNormais.forEach(categoria => {
                texto += `*- ${categoria}*\n`;
                const itensCategoria = itensAgrupados[categoria];
                Object.keys(itensCategoria).sort().forEach(nomeItem => {
                    const quantidade = itensAgrupados[categoria][nomeItem];
                    texto += `${quantidade} un. - ${nomeItem}\n`;
                });
                texto += `\n`;
            });
            
            // Adiciona "Outros" no final (se houver)
            categoriasOutros.forEach(categoria => {
                // Normaliza o nome para "Outros itens"
                const nomeCategoria = categoria.toLowerCase() === 'outros' ? 'Outros itens' : categoria;
                texto += `*- ${nomeCategoria}*\n`;
                const itensCategoria = itensAgrupados[categoria];
                Object.keys(itensCategoria).sort().forEach(nomeItem => {
                    const quantidade = itensAgrupados[categoria][nomeItem];
                    texto += `${quantidade} un. - ${nomeItem}\n`;
                });
                texto += `\n`;
            });
            
            navigator.clipboard.writeText(texto).then(() => {
                showToast("Resumo copiado! Abrindo WhatsApp...");
            const link = `https://wa.me/558195256641?text=${encodeURIComponent(texto)}`;
            window.open(link, '_blank');
            }).catch(() => {
                const link = `https://wa.me/558195256641?text=${encodeURIComponent(texto)}`;
                window.open(link, '_blank');
            });
            fecharModalResumos();
        }

        let pedidoWhatsAppAtual = null;
        let modoWhatsAppAtual = 'resumo';

        function obterPrimeiroNome(nomeCompleto) {
            if (!nomeCompleto) return 'Cliente';
            const partes = nomeCompleto.trim().split(' ');
            return partes[0];
        }

        function formatarNumeroTelefone(numero) {
            if (!numero) return '';
            let numeroLimpo = numero.replace(/\D/g, '');
            if (numeroLimpo.startsWith('0')) {
                numeroLimpo = numeroLimpo.substring(1);
            }
            return numeroLimpo;
        }

        function abrirModalWhatsApp(idPedido) {
            const pedido = todosPedidos.find(p => p.ID_do_Pedido === idPedido);
            if (!pedido) return;

            pedidoWhatsAppAtual = idPedido;
            const primeiroNome = obterPrimeiroNome(pedido.Nome_Cliente);
            const modal = document.getElementById('whatsapp-confirm-modal');
            const title = document.getElementById('whatsapp-confirm-title');
            const message = document.getElementById('whatsapp-confirm-message');
            const btn = document.getElementById('whatsapp-confirm-btn');

            message.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
                    <button class="btn-save" onclick="selecionarModoWhatsApp('resumo')" style="width: 100%; padding: 12px;">
                        üìã Enviar resumo do pedido
                    </button>
                    <button class="btn-save" onclick="selecionarModoWhatsApp('contato')" style="width: 100%; padding: 12px; background-color: var(--cor-fundo-azul);">
                        üí¨ Entrar em contato
                    </button>
                    <button class="btn-save" onclick="selecionarModoWhatsApp('pedido-pronto')" style="width: 100%; padding: 12px; background-color: var(--cor-verde);">
                        ‚úÖ Pedido Pronto
                    </button>
                </div>
            `;
            
            title.textContent = `Contato com ${primeiroNome}`;
            btn.style.display = 'none';
            modal.style.display = 'flex';
        }

        function selecionarModoWhatsApp(modo) {
            modoWhatsAppAtual = modo;
            const pedido = todosPedidos.find(p => p.ID_do_Pedido === pedidoWhatsAppAtual);
            if (!pedido) return;

            const primeiroNome = obterPrimeiroNome(pedido.Nome_Cliente);
            const message = document.getElementById('whatsapp-confirm-message');
            const btn = document.getElementById('whatsapp-confirm-btn');

            if (modo === 'resumo') {
                message.innerHTML = `Enviar resumo do pedido para <strong>${primeiroNome}</strong>?`;
                btn.textContent = 'Enviar Resumo';
            } else if (modo === 'pedido-pronto') {
                message.innerHTML = `Marcar pedido como pronto e notificar <strong>${primeiroNome}</strong>?`;
                btn.textContent = 'Confirmar';
            } else {
                message.innerHTML = `Entrar em contato com <strong>${primeiroNome}</strong>?`;
                btn.textContent = 'Abrir WhatsApp';
            }
            btn.style.display = 'block';
        }

        async function confirmarEnvioWhatsApp() {
            if (!pedidoWhatsAppAtual) return;

            const pedido = todosPedidos.find(p => p.ID_do_Pedido === pedidoWhatsAppAtual);
            if (!pedido) return;

            const numero = formatarNumeroTelefone(pedido.Numero);
            if (!numero) {
                showToast("N√∫mero de telefone inv√°lido!", true);
                fecharModalWhatsApp();
                return;
            }

            let texto = '';
            const primeiroNome = obterPrimeiroNome(pedido.Nome_Cliente);

            if (modoWhatsAppAtual === 'resumo') {
                texto = `*Ol√° ${primeiroNome}!*\n\n`;
                texto += `*Resumo do Pedido ${pedido.ID_do_Pedido}*\n\n`;
                texto += `*Data de Entrega:* ${pedido.Data_Entrega || '--/--/----'}\n`;
                texto += `*Hor√°rio:* ${pedido.Horario_Entrega || '--:--'}\n\n`;
                
                if (pedido.Resumo_dos_Itens) {
                    texto += `*Itens do Pedido:*\n${pedido.Resumo_dos_Itens}\n\n`;
                }
                
                let totalFormatado = (pedido.Total_Final || '0').toString();
                totalFormatado = totalFormatado.replace(/R\$/gi, '').replace(/\./g, '').replace(/,/g, '').replace(/\s/g, '').trim();
                if (!totalFormatado || totalFormatado === '') totalFormatado = '0';
                
                texto += `*Total:* ${totalFormatado}\n`;
                texto += `*Forma de Pagamento:* ${pedido.Forma_de_Pagamento || 'N√£o informado'}`;
            } else if (modoWhatsAppAtual === 'pedido-pronto') {
                mostrarLoading(true);
                pedido.Status_do_Pedido = 'Aguardando Retirada';
                try {
                    await fetch(API_URL, {
                        method: "POST", 
                        mode: 'no-cors', 
                        headers: { "Content-Type": "text/plain" },
                        body: JSON.stringify({ action: 'updateStatus', id: pedidoWhatsAppAtual, Status_do_Pedido: 'Aguardando Retirada' })
                    });
                } catch (error) { console.error('Erro:', error); }
                mostrarLoading(false);
                
                texto = `*Ol√° ${primeiroNome}!*\n\n`;
                texto += `‚úÖ Seu pedido *${pedido.ID_do_Pedido}* est√° pronto para retirada!\n\n`;
                texto += `Por favor, venha buscar no hor√°rio agendado:\n`;
                texto += `üìÖ ${pedido.Data_Entrega || '--/--/----'}\n`;
                texto += `‚è∞ ${pedido.Horario_Entrega || '--:--'}\n\n`;
                texto += `Aguardamos voc√™! üòä`;
            } else {
                texto = `Ol√° ${primeiroNome}!`;
            }

            const link = `https://wa.me/55${numero}?text=${encodeURIComponent(texto)}`;
            window.open(link, '_blank');
            fecharModalWhatsApp();
            
            if (modoWhatsAppAtual === 'pedido-pronto') {
                filtrarPedidos(); 
                showToast("Pedido marcado como pronto e notifica√ß√£o enviada!");
            } else {
                showToast(modoWhatsAppAtual === 'resumo' ? "Resumo enviado!" : "WhatsApp aberto!");
            }
        }

        function fecharModalWhatsApp() {
            document.getElementById('whatsapp-confirm-modal').style.display = 'none';
            pedidoWhatsAppAtual = null;
            modoWhatsAppAtual = 'resumo';
        }

        // ============================================================================
        // FUN√á√ïES AUXILIARES
        // ============================================================================
        function atualizarLocalmente(payload) {
            const p = todosPedidos.find(item => item.ID_do_Pedido === payload.ID_do_Pedido);
            if(p) {
                Object.keys(payload).forEach(key => {
                    if(key !== 'action') {
                        let val = payload[key];
                        if(typeof val === 'string' && val.startsWith("'")) val = val.substring(1);
                        p[key] = val;
                    }
                });
                filtrarPedidos();
            }
        }

        function mostrarLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.backgroundColor = isError ? '#e74c3c' : '#2ecc71';
            t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 3000);
        }
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target == modal) fecharModal();
            
            const modalWhatsApp = document.getElementById('whatsapp-confirm-modal');
            if (event.target == modalWhatsApp) fecharModalWhatsApp();
            
            const modalResumos = document.getElementById('resumos-modal');
            if (event.target == modalResumos) fecharModalResumos();
        }

    </script>
</body>
</html>
